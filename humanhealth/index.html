<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Immune Defender - Form 2 Science</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Quicksand', sans-serif;
            overflow: hidden;
            background: #fdf2f2;
            margin: 0;
            user-select: none;
            touch-action: none;
        }
        .bubbly-font { font-family: 'Fredoka One', cursive; }
        
        #game-canvas {
            display: block;
            background: radial-gradient(circle, #fff5f5 0%, #fed7d7 100%);
            box-shadow: inset 0 0 100px rgba(245, 101, 101, 0.1);
        }

        .ui-panel {
            backdrop-filter: blur(8px);
            background: rgba(255, 255, 255, 0.8);
            border: 4px solid #fbd38d;
            border-radius: 24px;
        }

        .btn-bubbly {
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .btn-bubbly:hover { transform: scale(1.05); }
        .btn-bubbly:active { transform: scale(0.95); }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-float { animation: float 3s ease-in-out infinite; }

        .hidden { display: none !important; }

        #phase-announcement {
            pointer-events: none;
            transition: opacity 0.5s ease-in-out;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #feb2b2;
            border-radius: 10px;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-red-50 p-4 md:p-6 text-center">
        <div class="animate-float mb-4">
            <svg width="100" height="100" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="45" fill="#fff" stroke="#fc8181" stroke-width="4" />
                <circle cx="50" cy="50" r="35" fill="#fff5f5" />
                <ellipse cx="35" cy="40" rx="5" ry="8" fill="#4a5568" />
                <ellipse cx="65" cy="40" rx="5" ry="8" fill="#4a5568" />
                <path d="M 40 65 Q 50 75 60 65" stroke="#4a5568" stroke-width="3" fill="none" stroke-linecap="round" />
            </svg>
        </div>
        <h1 class="text-4xl md:text-5xl bubbly-font text-red-500 mb-2 drop-shadow-sm">IMMUNE DEFENDER</h1>
        
        <!-- Educational Info Box -->
        <div class="ui-panel max-w-2xl w-full p-6 mb-6 text-left overflow-y-auto max-h-[40vh] custom-scrollbar">
            <div class="space-y-4 text-sm md:text-base text-gray-700">
                <div>
                    <h3 class="font-bold text-red-600 uppercase text-xs mb-1">What are Pathogens?</h3>
                    <p>Pathogens are microorganisms like <b>bacteria</b> and <b>viruses</b> that cause diseases. They try to enter our body to multiply.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-blue-50 p-3 rounded-xl border border-blue-100">
                        <h3 class="font-bold text-blue-600 text-xs mb-1 uppercase">1st Line: Skin Defense</h3>
                        <p class="text-xs">Your skin acts as a physical barrier. In Phase 1, use the <b>Aegi plate</b> to represent the skin blocking germs from entering!</p>
                    </div>
                    <div class="bg-green-50 p-3 rounded-xl border border-green-100">
                        <h3 class="font-bold text-green-600 text-xs mb-1 uppercase">2nd Line: Phagocytosis</h3>
                        <p class="text-xs">If germs enter, <b>White Blood Cells</b> engulf and digest them. In Phase 2, take control of the cell to "devour" the bad guys!</p>
                    </div>
                </div>
            </div>
        </div>

        <button id="start-btn" class="btn-bubbly bubbly-font bg-orange-400 text-white px-10 py-4 rounded-full text-2xl shadow-lg border-b-8 border-orange-600">
            START DEFENSE
        </button>
    </div>

    <!-- Game HUD -->
    <div id="hud" class="fixed top-6 left-6 right-6 flex justify-between items-start pointer-events-none hidden">
        <div class="flex flex-col gap-2">
            <div class="ui-panel px-6 py-3 flex items-center gap-4">
                <div class="text-red-500 font-bold">HEALTH</div>
                <div class="w-48 h-6 bg-red-100 rounded-full overflow-hidden border-2 border-red-200">
                    <div id="health-bar" class="h-full bg-gradient-to-r from-red-400 to-red-500 transition-all duration-300" style="width: 100%"></div>
                </div>
            </div>
            <div id="phase-badge" class="ui-panel px-4 py-1 text-xs font-bold text-blue-600 uppercase tracking-tighter w-fit">
                PHASE 1: SKIN DEFENSE
            </div>
        </div>
        <div class="ui-panel px-8 py-3 text-center">
            <div class="text-orange-500 text-xs font-bold uppercase tracking-widest">Score</div>
            <div id="score-display" class="text-3xl bubbly-font text-orange-600">0</div>
        </div>
    </div>

    <!-- Phase Announcement Overlay -->
    <div id="phase-announcement" class="fixed inset-0 z-40 flex items-center justify-center opacity-0">
        <div class="text-6xl bubbly-font text-blue-500 drop-shadow-lg text-center">
            <div id="phase-title">PHASE 2</div>
            <div class="text-2xl text-blue-800">PHAGOCYTOSIS ENGAGED!</div>
        </div>
    </div>

    <!-- Game Canvas -->
    <canvas id="game-canvas"></canvas>

    <!-- Game Over Overlay -->
    <div id="game-over" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white/90 backdrop-blur-md p-6 text-center hidden">
        <h2 class="text-6xl bubbly-font text-red-500 mb-2">SYSTEM CRITICAL!</h2>
        <p class="text-2xl text-gray-600 mb-8">Pathogens have overwhelmed the host.</p>
        <div class="text-4xl bubbly-font text-orange-500 mb-10">Final Score: <span id="final-score">0</span></div>
        <button id="restart-btn" class="btn-bubbly bubbly-font bg-green-400 text-white px-12 py-5 rounded-full text-3xl shadow-lg border-b-8 border-green-600">
            TRY AGAIN
        </button>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);

                if (type === 'pop') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(400, audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
                    gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                    osc.start(); osc.stop(audioCtx.currentTime + 0.1);
                } else if (type === 'damage') {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                    osc.frequency.linearRampToValueAtTime(50, audioCtx.currentTime + 0.2);
                    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.2);
                    osc.start(); osc.stop(audioCtx.currentTime + 0.2);
                } else if (type === 'deflect') {
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.05);
                    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
                    osc.start(); osc.stop(audioCtx.currentTime + 0.05);
                }
            } catch(e) {}
        }

        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const splash = document.getElementById('splash-screen');
        const hud = document.getElementById('hud');
        const gameOverScreen = document.getElementById('game-over');
        const healthBar = document.getElementById('health-bar');
        const scoreDisplay = document.getElementById('score-display');
        const finalScoreDisplay = document.getElementById('final-score');
        const phaseBadge = document.getElementById('phase-badge');
        const phaseOverlay = document.getElementById('phase-announcement');

        let width, height;
        let gameActive = false;
        let score = 0;
        let health = 100;
        let pathogens = [];
        let particles = [];
        let rbc = []; 
        let mouse = { x: 0, y: 0 };
        let phase = 1; 
        const PHASE_2_THRESHOLD = 500;

        const player = {
            x: 0,
            y: 0,
            radius: 45,
            color: '#ffffff',
            paddleWidth: 180,
            paddleHeight: 15,
            draw() {
                if (phase === 2) {
                    ctx.save();
                    ctx.translate(this.x, this.y);
                    
                    const grad = ctx.createRadialGradient(0, 0, 0, 0, 0, this.radius + 15);
                    grad.addColorStop(0, 'rgba(255, 255, 255, 0.4)');
                    grad.addColorStop(1, 'rgba(255, 255, 255, 0)');
                    ctx.fillStyle = grad;
                    ctx.beginPath();
                    ctx.arc(0, 0, this.radius + 15, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.fillStyle = this.color;
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = 'rgba(0,0,0,0.1)';
                    ctx.beginPath();
                    for (let i = 0; i < 360; i += 10) {
                        const angle = i * Math.PI / 180;
                        const r = this.radius + Math.sin(angle * 5 + Date.now() / 400) * 3;
                        const dx = Math.cos(angle) * r;
                        const dy = Math.sin(angle) * r;
                        if (i === 0) ctx.moveTo(dx, dy);
                        else ctx.lineTo(dx, dy);
                    }
                    ctx.closePath();
                    ctx.fill();
                    ctx.strokeStyle = '#feb2b2';
                    ctx.lineWidth = 3;
                    ctx.stroke();

                    ctx.fillStyle = '#4a5568';
                    ctx.beginPath();
                    ctx.ellipse(-12, -8, 5, 8 + Math.sin(Date.now()/500)*2, 0, 0, Math.PI * 2);
                    ctx.ellipse(12, -8, 5, 8 + Math.sin(Date.now()/500)*2, 0, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.beginPath();
                    ctx.arc(0, 15, 10, 0, Math.PI * 2); 
                    ctx.strokeStyle = '#4a5568';
                    ctx.stroke();
                    ctx.restore();
                }

                if (phase === 1) {
                    ctx.save();
                    ctx.translate(this.x, height - 150);
                    ctx.fillStyle = '#63b3ed';
                    ctx.strokeStyle = '#3182ce';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.roundRect(-this.paddleWidth/2, -this.paddleHeight/2, this.paddleWidth, this.paddleHeight, 10);
                    ctx.fill();
                    ctx.stroke();
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = '#63b3ed';
                    ctx.stroke();
                    ctx.restore();
                }
            }
        };

        class Pathogen {
            constructor() {
                this.radius = 15 + Math.random() * 15;
                this.type = Math.random() > 0.5 ? 'bacteria' : 'virus';
                this.deflected = false;
                this.reset();
            }
            reset() {
                if (phase === 1) {
                    const speedMult = 1 + (score / 5000); 
                    this.x = Math.random() * (width - 100) + 50;
                    this.y = -50;
                    this.vx = (Math.random() - 0.5) * 2;
                    this.vy = (3.5 + (score / 1500)) * speedMult;
                } else {
                    // Phase 2: Much slower gradual speed increase
                    const speedMult = 1 + (score / 12000); 
                    const side = Math.floor(Math.random() * 4);
                    if (side === 0) { this.x = -50; this.y = Math.random() * height; }
                    else if (side === 1) { this.x = width + 50; this.y = Math.random() * height; }
                    else if (side === 2) { this.x = Math.random() * width; this.y = -50; }
                    else { this.x = Math.random() * width; this.y = height + 50; }
                    
                    const angle = Math.atan2(player.y - this.y, player.x - this.x);
                    const speed = (2.6 + (score / 6000)) * speedMult;
                    this.vx = Math.cos(angle) * speed;
                    this.vy = Math.sin(angle) * speed;
                }
                this.angle = 0;
                this.spin = (Math.random() - 0.5) * 0.1;
                this.deflected = false;
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.angle += this.spin;
                
                if (phase === 1 && this.deflected) {
                    if (this.x < 0 || this.x > width) this.vx *= -1;
                }
            }
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);
                if (this.type === 'bacteria') {
                    ctx.fillStyle = '#9ae6b4';
                    ctx.strokeStyle = '#276749';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.roundRect(-this.radius, -this.radius/2, this.radius*2, this.radius, this.radius/2);
                    ctx.fill(); ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(-this.radius, 0);
                    ctx.bezierCurveTo(-this.radius-10, 10, -this.radius-10, -10, -this.radius-20, 0);
                    ctx.stroke();
                } else {
                    ctx.fillStyle = '#feb2b2';
                    ctx.strokeStyle = '#c53030';
                    ctx.lineWidth = 2;
                    for (let i = 0; i < 8; i++) {
                        ctx.rotate(Math.PI / 4);
                        ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(0, this.radius + 8); ctx.stroke();
                        ctx.beginPath(); ctx.arc(0, this.radius + 8, 4, 0, Math.PI*2); ctx.fill();
                    }
                    ctx.beginPath(); ctx.arc(0, 0, this.radius, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                }
                ctx.restore();
            }
        }

        class RedBloodCell {
            constructor() {
                this.radius = 20;
                this.x = Math.random() * width;
                this.y = -50;
                this.vx = (Math.random() - 0.5) * 1;
                this.vy = 1.2 + Math.random() * 2;
            }
            update() { this.x += this.vx; this.y += this.vy; }
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.fillStyle = '#f56565';
                ctx.strokeStyle = '#9b2c2c';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(0, 0, this.radius, 0, Math.PI * 2);
                ctx.fill(); ctx.stroke();
                ctx.globalAlpha = 0.3;
                ctx.beginPath();
                ctx.arc(0, 0, this.radius * 0.6, 0, Math.PI * 2);
                ctx.stroke();
                ctx.restore();
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y; this.color = color;
                this.radius = Math.random() * 4 + 2;
                this.vx = (Math.random() - 0.5) * 8;
                this.vy = (Math.random() - 0.5) * 8;
                this.alpha = 1;
            }
            update() { this.x += this.vx; this.y += this.vy; this.alpha -= 0.02; }
            draw() {
                ctx.save(); ctx.globalAlpha = this.alpha; ctx.fillStyle = this.color;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2); ctx.fill();
                ctx.restore();
            }
        }

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            if (!gameActive) { player.x = width / 2; player.y = height / 2; }
        }

        function update() {
            if (!gameActive) return;

            if (phase === 1) {
                player.x += (mouse.x - player.x) * 0.2;
                if (player.x < player.paddleWidth/2) player.x = player.paddleWidth/2;
                if (player.x > width - player.paddleWidth/2) player.x = width - player.paddleWidth/2;
            } else {
                player.x += (mouse.x - player.x) * 0.15;
                player.y += (mouse.y - player.y) * 0.15;
            }

            pathogens.forEach((p, i) => {
                p.update();
                
                if (phase === 1) {
                    const paddleY = height - 150;
                    if (!p.deflected && 
                        p.y + p.radius > paddleY - 10 && 
                        p.y - p.radius < paddleY + 10 &&
                        p.x > player.x - player.paddleWidth/2 && 
                        p.x < player.x + player.paddleWidth/2) {
                        
                        p.vy = -Math.abs(p.vy) * 1.25;
                        p.vx += (p.x - player.x) * 0.12;
                        p.deflected = true;
                        score += 25;
                        playSound('deflect');
                        if (score >= PHASE_2_THRESHOLD) startPhaseTwo();
                    }

                    if (p.y > height) {
                        health -= 10;
                        pathogens.splice(i, 1);
                        playSound('damage');
                        if (health <= 0) endGame();
                    } else if (p.y < -150 && p.deflected) {
                        pathogens.splice(i, 1);
                    }
                } else {
                    const dist = Math.hypot(p.x - player.x, p.y - player.y);
                    if (dist < player.radius + p.radius) {
                        score += 50;
                        pathogens.splice(i, 1);
                        playSound('pop');
                        for(let j=0; j<8; j++) particles.push(new Particle(p.x, p.y, '#9ae6b4'));
                    } else if (p.x < -150 || p.x > width + 150 || p.y < -150 || p.y > height + 150) {
                        health -= 2; 
                        pathogens.splice(i, 1);
                        if (health <= 0) endGame();
                    }
                }
            });

            if (phase === 2) {
                rbc.forEach((c, i) => {
                    c.update();
                    const dist = Math.hypot(c.x - player.x, c.y - player.y);
                    if (dist < player.radius + c.radius) {
                        health -= 15; 
                        rbc.splice(i, 1);
                        playSound('damage');
                        if (health <= 0) endGame();
                    }
                    if (c.y > height + 100) rbc.splice(i, 1);
                });
                if (Math.random() < 0.02) rbc.push(new RedBloodCell());
            }

            particles.forEach((p, i) => {
                p.update();
                if (p.alpha <= 0) particles.splice(i, 1);
            });

            healthBar.style.width = health + '%';
            scoreDisplay.innerText = score;

            // Balanced spawn rates for Phase 2: Slow growth and a cap on total pathogens
            if (phase === 1) {
                let spawnRate = 0.014 + (score / 15000); 
                if (Math.random() < spawnRate) pathogens.push(new Pathogen());
            } else {
                // Phase 2: Significantly lower rate and strict cap to avoid overwhelming player
                let spawnRate = 0.006 + (score / 120000); 
                if (Math.random() < spawnRate && pathogens.length < 5) {
                    pathogens.push(new Pathogen());
                }
            }
        }

        function startPhaseTwo() {
            if (phase === 2) return;
            phase = 2;
            phaseBadge.innerText = "PHASE 2: PHAGOCYTOSIS";
            phaseBadge.classList.replace('text-blue-600', 'text-red-600');
            
            phaseOverlay.style.opacity = '1';
            setTimeout(() => { phaseOverlay.style.opacity = '0'; }, 3000);
            
            pathogens = [];
        }

        function draw() {
            ctx.clearRect(0, 0, width, height);
            
            ctx.fillStyle = 'rgba(254, 215, 215, 0.3)';
            for(let i=0; i<3; i++) {
                ctx.beginPath();
                ctx.arc((i*width/3 + Date.now()/60)%width, (height/2 + Math.sin(Date.now()/1000 + i)*150), 60, 0, Math.PI*2);
                ctx.fill();
            }

            rbc.forEach(c => c.draw());
            pathogens.forEach(p => p.draw());
            particles.forEach(p => p.draw());
            player.draw();

            requestAnimationFrame(draw);
        }

        function startGame() {
            gameActive = true;
            score = 0;
            health = 100;
            phase = 1;
            pathogens = [];
            rbc = [];
            phaseBadge.innerText = "PHASE 1: SKIN DEFENSE";
            phaseBadge.classList.add('text-blue-600');
            phaseBadge.classList.remove('text-red-600');
            splash.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            hud.classList.remove('hidden');
            audioCtx.resume();
            player.x = width / 2;
            player.y = height - 150;
        }

        function endGame() {
            gameActive = false;
            hud.classList.add('hidden');
            gameOverScreen.classList.remove('hidden');
            finalScoreDisplay.innerText = score;
        }

        window.addEventListener('resize', resize);
        window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });
        window.addEventListener('touchmove', e => {
            mouse.x = e.touches[0].clientX;
            mouse.y = e.touches[0].clientY;
            e.preventDefault();
        }, { passive: false });

        document.getElementById('start-btn').addEventListener('click', startGame);
        document.getElementById('restart-btn').addEventListener('click', startGame);

        setInterval(update, 1000 / 60);
        resize();
        draw();
    </script>
</body>
</html>