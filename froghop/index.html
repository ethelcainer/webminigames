<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Froggy's Bouncy Math Adventure</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Fredoka', sans-serif;
            overflow: hidden;
            background: #38bdf8;
            touch-action: none;
            user-select: none;
        }

        /* WATER BACKGROUND */
        .water-bg {
            background: radial-gradient(circle at center, #38bdf8 0%, #0284c7 100%);
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 0;
            overflow: hidden;
        }

        .wave {
            position: absolute;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 40%;
            width: 200vw;
            height: 200vw;
            animation: rotate 25s linear infinite;
            left: -50%;
            top: 60%;
        }
        .wave:nth-child(2) {
            top: 65%;
            animation: rotate 30s linear infinite reverse;
            background: rgba(255, 255, 255, 0.08);
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .lotus-bg {
            position: absolute;
            opacity: 0.8;
            filter: drop-shadow(0 4px 0px rgba(219, 39, 119, 0.2)); 
        }

        #game-world {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* LILY PADS */
        .pad-row {
            position: absolute;
            width: 100%;
            height: 0; 
            display: flex;
            justify-content: center;
            pointer-events: none;
        }

        .lilypad {
            position: absolute;
            width: 150px;
            height: 110px;
            cursor: pointer;
            pointer-events: auto;
            transition: transform 0.1s;
            transform-origin: center center;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .lilypad:hover {
            transform: scale(1.1);
            filter: brightness(1.1);
        }
        .lilypad:active {
            transform: scale(0.95);
        }

        /* Text logic */
        .lilypad-text {
            font-size: 2.5rem;
            font-weight: 800;
            color: #ffffff; 
            -webkit-text-stroke: 4px #064e3b; 
            paint-order: stroke fill;
            z-index: 10;
            margin-top: -15px;
        }

        /* THE FROG */
        .frog-container {
            position: absolute;
            width: 100px;
            height: 100px;
            z-index: 50;
            pointer-events: none;
            left: 50%; 
            margin-left: -50px; 
            margin-top: -50px;
            transform-origin: bottom center;
            transition: opacity 0.3s;
        }

        /* UI ELEMENTS */
        .bubbly-panel {
            background: rgba(255, 255, 255, 0.95);
            border: 4px solid #fff;
            box-shadow: 0 10px 0px #0ea5e9, 0 20px 20px rgba(0,0,0,0.1); 
            border-radius: 2.5rem;
            backdrop-filter: blur(8px);
        }

        .hud-stat {
            background: white;
            padding: 8px 16px;
            border-radius: 999px;
            border: 3px solid #e0f2fe;
            box-shadow: 0 4px 0 #bae6fd;
            font-weight: 800;
            color: #0284c7;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .current-num-box {
            background: #dbeafe; 
            border: 4px solid #3b82f6;
            box-shadow: 0 6px 0 #1d4ed8;
            color: #1e3a8a;
            border-radius: 1.5rem;
            padding: 5px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
        }

        .main-rule-box {
            background: #fffbeb; 
            border: 5px solid #fbbf24;
            box-shadow: 0 8px 0 #d97706;
            color: #d97706;
            border-radius: 2rem;
            min-width: 150px;
        }
        
        .btn-bubbly {
            background: linear-gradient(to bottom, #4ade80 0%, #22c55e 100%);
            border: none;
            border-bottom: 6px solid #16a34a;
            border-radius: 1.5rem;
            color: white;
            font-weight: 800;
            font-size: 1.5rem;
            text-shadow: 0 2px 0 rgba(0,0,0,0.1);
            transition: all 0.1s;
        }
        .btn-bubbly:active {
            transform: translateY(6px);
            border-bottom: 0px solid transparent;
        }

        /* Tiny Mute Button in HUD */
        .mute-btn {
            background: white;
            border: 3px solid #e0f2fe;
            color: #0284c7;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 0 #bae6fd;
            transition: all 0.1s;
        }
        .mute-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 transparent;
        }

        .key-hint {
            position: absolute;
            bottom: -30px;
            font-size: 1rem;
            font-weight: 800;
            color: #064e3b;
            background: #a7f3d0;
            padding: 4px 12px;
            border-radius: 15px;
            white-space: nowrap;
            box-shadow: 0 2px 0 #34d399;
        }

        .invisible-frog {
            opacity: 0;
            transform: scale(0);
        }

        .floating-heart {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 2rem;
            font-weight: 900;
            color: #ef4444;
            pointer-events: none;
            z-index: 100;
            text-shadow: 0 2px 0 white;
            animation: floatUp 1.5s forwards;
        }
        
        @keyframes floatUp {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            20% { transform: translateY(-10px) scale(1.2); opacity: 1; }
            100% { transform: translateY(-50px) scale(1); opacity: 0; }
        }

    </style>
</head>
<body>

<div id="game-app" class="relative w-full h-screen overflow-hidden">
    
    <div class="water-bg">
        <div class="wave"></div>
        <div class="wave"></div>
        
        <div v-for="l in decoLilies" :key="l.id" class="lotus-bg" :style="{ top: l.y + '%', left: l.x + '%', transform: l.transform }">
            <svg width="80" height="80" viewBox="0 0 100 100">
                <path d="M50,85 C20,80 10,50 15,40 C30,15 50,10 50,10 C50,10 70,15 85,40 C90,50 80,80 50,85" fill="#f472b6" />
                <path d="M50,85 C35,80 25,60 30,50 C40,30 50,25 50,25 C50,25 60,30 70,50 C75,60 65,80 50,85" fill="#fbcfe8" />
                <circle cx="50" cy="60" r="10" fill="#fbbf24" />
            </svg>
        </div>
    </div>

    <div v-if="gameState === 'PLAYING'" class="absolute top-0 left-0 w-full p-4 z-50 flex flex-col md:flex-row justify-between items-start pointer-events-none gap-2">
        
        <div class="flex gap-3 pointer-events-auto mt-2">
            <div class="hud-stat text-red-500 relative">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor" class="drop-shadow-sm">
                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                </svg>
                <span class="text-2xl font-black">{{ lives }}</span>
                <div v-if="showHeartAnim" class="floating-heart">+1</div>
            </div>
            <div class="hud-stat text-sky-600">
                <span class="text-xs uppercase font-black tracking-widest">LVL</span>
                <span class="text-2xl font-black">{{ level }}</span>
            </div>
        </div>

        <div class="flex gap-4 items-center animate-bounce-small mt-2">
            <div class="current-num-box">
                <div class="text-[10px] font-black uppercase tracking-widest opacity-70">Start</div>
                <div class="text-4xl font-black">{{ currentNumber }}</div>
            </div>

            <div class="main-rule-box px-6 py-2 flex flex-col items-center">
                <div class="text-[10px] font-black uppercase tracking-widest opacity-70 mb-1">Rule</div>
                <div class="text-5xl font-black tracking-wider">{{ currentRule }}</div>
            </div>
        </div>

        <div class="flex gap-3 pointer-events-auto mt-2 self-end md:self-auto">
            <div class="hud-stat text-orange-500">
                <span class="text-xs uppercase font-black tracking-widest">Score</span>
                <span class="text-2xl font-black">{{ score }}</span>
            </div>
            
            <button @click="toggleAudio" class="mute-btn">
                <svg v-if="audioEnabled" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                </svg>
                <svg v-else width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73 4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                </svg>
            </button>
        </div>
    </div>

    <div v-if="gameState === 'MENU'" class="absolute inset-0 flex items-center justify-center z-50 bg-sky-400/30 backdrop-blur-sm">
        <div class="bubbly-panel p-10 text-center max-w-sm w-full animate-bounce-in">
            <div class="text-8xl mb-6 drop-shadow-md animate-bounce-small">üê∏</div>

            <h1 class="text-5xl font-black text-green-500 mb-2 drop-shadow-sm stroke-white">Froggy Hop</h1>
            <p class="text-gray-400 font-bold mb-8 text-xl">Math Adventure</p>
            
            <button @click="startGame" class="btn-bubbly w-full py-5 shadow-xl mb-6 transform hover:scale-105 transition">
                PLAY NOW
            </button>
            
            <button @click="toggleAudio" class="text-xs font-bold bg-gray-100 text-gray-500 px-4 py-2 rounded-full hover:bg-gray-200 transition">
                Sounds: {{ audioEnabled ? 'ON' : 'OFF' }}
            </button>
            
            <div class="mt-6 text-gray-400 text-sm font-bold">
                Use <span class="bg-white px-2 py-1 rounded text-sky-500 shadow-sm">Arrow Keys</span> or <span class="bg-white px-2 py-1 rounded text-sky-500 shadow-sm">A / D</span>
            </div>
        </div>
    </div>

    <div id="game-world" ref="worldContainer">
        
        <div v-for="row in rows" :key="row.id" class="pad-row" :style="{ transform: `translateY(${row.y}px)` }">
            
            <div class="lilypad"
                 :class="{ 'opacity-50 grayscale pointer-events-none': row.leftOption.isDead }"
                 :style="{ transform: `translateX(${row.leftX}px)` }" 
                 @click="handleChoice(row, row.leftOption)">
                
                <svg viewBox="0 0 140 100" class="w-full h-full drop-shadow-lg absolute top-0 left-0">
                    <path d="M70,15 C100,15 130,35 130,60 C130,90 90,90 75,75 L70,70 L65,75 C50,90 10,90 10,60 C10,35 40,15 70,15 Z" fill="#059669" />
                    <path d="M70,70 L30,45" stroke="#064e3b" stroke-width="3" opacity="0.3" stroke-linecap="round"/>
                    <path d="M70,70 L110,45" stroke="#064e3b" stroke-width="3" opacity="0.3" stroke-linecap="round"/>
                    <path d="M70,70 L70,30" stroke="#064e3b" stroke-width="3" opacity="0.3" stroke-linecap="round"/>
                </svg>
                
                <span class="lilypad-text absolute">{{ row.leftOption.val }}</span>
                <div class="key-hint" v-if="row.id === currentRowId">‚Üê A</div>
            </div>

            <div class="lilypad"
                 :class="{ 'opacity-50 grayscale pointer-events-none': row.rightOption.isDead }"
                 :style="{ transform: `translateX(${row.rightX}px)` }"
                 @click="handleChoice(row, row.rightOption)">
                 
                <svg viewBox="0 0 140 100" class="w-full h-full drop-shadow-lg absolute top-0 left-0">
                    <path d="M70,15 C100,15 130,35 130,60 C130,90 90,90 75,75 L70,70 L65,75 C50,90 10,90 10,60 C10,35 40,15 70,15 Z" fill="#059669" />
                    <path d="M70,70 L30,45" stroke="#064e3b" stroke-width="3" opacity="0.3" stroke-linecap="round"/>
                    <path d="M70,70 L110,45" stroke="#064e3b" stroke-width="3" opacity="0.3" stroke-linecap="round"/>
                    <path d="M70,70 L70,30" stroke="#064e3b" stroke-width="3" opacity="0.3" stroke-linecap="round"/>
                </svg>
                
                <span class="lilypad-text absolute">{{ row.rightOption.val }}</span>
                <div class="key-hint" v-if="row.id === currentRowId">D ‚Üí</div>
            </div>
        </div>

        <div v-if="showStartPad" class="lilypad pointer-events-none"
             :style="{ top: layout.startPadY + 'px', left: '50%', marginLeft: '-75px' }">
             <svg viewBox="0 0 140 100" class="w-full h-full opacity-60">
                <path d="M70,15 C100,15 130,35 130,60 C130,90 90,90 75,75 L70,70 L65,75 C50,90 10,90 10,60 C10,35 40,15 70,15 Z" fill="#047857"/>
            </svg>
        </div>

        <div ref="frogRef" class="frog-container" 
             :class="{ 'invisible-frog': gameState === 'MENU' }"
             :style="{ top: frogBaseY + 'px' }">
             
            <svg viewBox="0 0 100 100" class="w-full h-full filter drop-shadow-xl">
                <path d="M20,60 Q5,60 5,85" stroke="#4ade80" stroke-width="12" fill="none" stroke-linecap="round"/>
                <path d="M80,60 Q95,60 95,85" stroke="#4ade80" stroke-width="12" fill="none" stroke-linecap="round"/>
                <ellipse cx="50" cy="65" rx="42" ry="32" fill="#4ade80" />
                <path d="M25,65 Q50,90 75,65" stroke="#22c55e" stroke-width="4" fill="none" opacity="0.4"/>
                <g id="eyes-group">
                    <circle cx="30" cy="40" r="13" fill="white" stroke="#22c55e" stroke-width="2"/>
                    <circle class="pupil" cx="30" cy="40" r="6" fill="#0f172a" />
                    <circle cx="70" cy="40" r="13" fill="white" stroke="#22c55e" stroke-width="2"/>
                    <circle class="pupil" cx="70" cy="40" r="6" fill="#0f172a" />
                </g>
                <path d="M35,75 Q50,85 65,75" stroke="#15803d" stroke-width="4" fill="none" stroke-linecap="round"/>
                <circle cx="18" cy="72" r="6" fill="#fca5a5" opacity="0.8"/>
                <circle cx="82" cy="72" r="6" fill="#fca5a5" opacity="0.8"/>
            </svg>
        </div>

    </div>

    <div v-if="showLevelUp" class="absolute inset-0 flex flex-col items-center justify-center z-50 pointer-events-none">
        <div class="text-8xl font-black text-yellow-300 drop-shadow-[0_6px_0_rgba(0,0,0,0.2)] animate-bounce mb-4 text-stroke-orange">
            LEVEL UP!
        </div>
    </div>

    <div v-if="gameState === 'GAMEOVER'" class="absolute inset-0 flex items-center justify-center z-50 bg-red-500/40 backdrop-blur-md">
        <div class="bubbly-panel p-10 text-center animate-bounce-in border-red-400 max-w-md">
            <div class="text-7xl mb-4">ü•≤</div>

            <h2 class="text-5xl font-black text-red-500 mb-2">Oh no!</h2>
            <p class="text-xl text-gray-500 mb-8 font-bold">You fell in the water!</p>
            
            <div class="bg-white rounded-2xl p-6 mb-8 border-4 border-red-100 shadow-inner">
                <div class="text-red-300 uppercase text-xs font-black tracking-widest">Final Score</div>
                <div class="text-6xl font-black text-red-500">{{ score }}</div>
            </div>

            <button @click="startGame" class="btn-bubbly w-full py-5 shadow-xl filter hue-rotate-180">
                Try Again
            </button>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, reactive, onMounted, onUnmounted } = Vue;

    // --- ENHANCED AUDIO ENGINE ---
    class AudioEngine {
        constructor() {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            this.enabled = false;
            this.musicStarted = false;
        }

        // Renamed to setAudio to explicitly handle ON and OFF states
        setAudio(isActive) {
            this.enabled = isActive;
            
            if (isActive) {
                if (this.ctx.state === 'suspended') this.ctx.resume();
                this.startMusic();
            }
            // If isActive is false, the loop in startMusic will catch it and stop playing.
        }
        
        // --- BACKGROUND MUSIC ---
        startMusic() {
            if (this.musicStarted) return;
            this.musicStarted = true;
            
            const notes = [261.63, 293.66, 329.63, 392.00, 440.00, 523.25];
            
            const playNote = () => {
                // If muted, wait and check again later (silent loop)
                if (!this.enabled) {
                    setTimeout(playNote, 1000); 
                    return;
                }
                
                const freq = notes[Math.floor(Math.random() * notes.length)];
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                
                osc.frequency.value = freq;
                osc.type = 'sine'; 
                
                gain.gain.setValueAtTime(0, this.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0.03, this.ctx.currentTime + 1); 
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 4); 
                
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + 4);
                
                setTimeout(playNote, 2500 + Math.random() * 2000);
            };
            
            playNote();
        }

        // --- SFX ---
        playTone(freq, type, dur, vol = 0.1) {
            if (!this.enabled) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            gain.gain.setValueAtTime(0, this.ctx.currentTime);
            gain.gain.linearRampToValueAtTime(vol, this.ctx.currentTime + 0.01);
            gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + dur);
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            osc.start();
            osc.stop(this.ctx.currentTime + dur);
        }

        playJump() {
            if(!this.enabled) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.frequency.setValueAtTime(300, this.ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(600, this.ctx.currentTime + 0.2);
            gain.gain.setValueAtTime(0, this.ctx.currentTime);
            gain.gain.linearRampToValueAtTime(0.1, this.ctx.currentTime + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.2);
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            osc.start();
            osc.stop(this.ctx.currentTime + 0.2);
        }

        playSplash() {
            if(!this.enabled) return;
            const bufferSize = this.ctx.sampleRate * 0.5; 
            const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }
            const noise = this.ctx.createBufferSource();
            noise.buffer = buffer;
            const filter = this.ctx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 800;
            const gain = this.ctx.createGain();
            gain.gain.setValueAtTime(0.2, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.4);
            noise.connect(filter);
            filter.connect(gain);
            gain.connect(this.ctx.destination);
            noise.start();
        }

        playError() {
            if(!this.enabled) return;
            this.playSplash();
        }

        playLevelUp() {
            if(!this.enabled) return;
            [523.25, 659.25, 783.99, 1046.50].forEach((f, i) => {
                setTimeout(() => this.playTone(f, 'sine', 0.4, 0.1), i*100);
            });
        }
    }

    const audio = new AudioEngine();

    createApp({
        setup() {
            const gameState = ref('MENU'); 
            const score = ref(0);
            const level = ref(1);
            const lives = ref(5);
            const currentRule = ref('?');
            const currentNumber = ref(0);
            
            const frogBaseY = ref(window.innerHeight * 0.7); 
            const layout = reactive({ startPadY: window.innerHeight * 0.7 });
            const showStartPad = ref(true);

            const rows = ref([]); 
            const currentRowId = ref(0); 
            const decoLilies = ref([]);
            const audioEnabled = ref(false);
            const showLevelUp = ref(false);
            const showHeartAnim = ref(false);
            const frogRef = ref(null);
            const isJumping = ref(false); 
            
            for(let i=0; i<8; i++) {
                decoLilies.value.push({
                    id: i,
                    x: Math.random() * 100,
                    y: Math.random() * 100,
                    transform: `scale(${0.5 + Math.random()}) rotate(${Math.random()*360}deg)`
                });
            }

            const toggleAudio = () => {
                audioEnabled.value = !audioEnabled.value;
                audio.setAudio(audioEnabled.value);
            };

            const startGame = () => {
                score.value = 0;
                level.value = 1;
                lives.value = 5;
                isJumping.value = false;
                currentNumber.value = Math.floor(Math.random() * 5) + 1;
                rows.value = [];
                currentRowId.value = 0;
                
                frogBaseY.value = window.innerHeight * 0.7;
                layout.startPadY = frogBaseY.value;
                showStartPad.value = true;
                
                if(frogRef.value) {
                    gsap.set(frogRef.value, { x: 0, y: 0, rotation: 0, scale: 1, opacity: 1 });
                }
                
                gameState.value = 'PLAYING';
                addNextRow(0);
            };

            const addNextRow = (index) => {
                const ROW_HEIGHT = -170; 
                
                let op = '+';
                let num = 1;
                if (level.value < 3) num = Math.floor(Math.random() * 3) + 1;
                else if (level.value < 6) {
                    if (Math.random() > 0.7 && currentNumber.value > 5) op = '-';
                    num = Math.floor(Math.random() * 5) + 1;
                } else {
                    if (Math.random() > 0.6) op = '-';
                    num = Math.floor(Math.random() * 9) + 2;
                }
                
                currentRule.value = `${op} ${num}`;
                
                const correctVal = op === '+' ? currentNumber.value + num : currentNumber.value - num;
                let wrongVal = correctVal + (Math.random() > 0.5 ? 1 : -1) * Math.ceil(Math.random()*2);
                if (wrongVal === correctVal) wrongVal++;
                if (wrongVal < 0) wrongVal = 0;

                const isLeftCorrect = Math.random() > 0.5;
                
                let prevY;
                if (rows.value.length === 0) {
                     prevY = frogBaseY.value; 
                } else {
                     prevY = rows.value[rows.value.length-1].y;
                }

                const wobble = (Math.random() - 0.5) * 120; 

                rows.value.push({
                    id: index,
                    y: prevY + ROW_HEIGHT, 
                    leftX: -140 + wobble, 
                    rightX: 140 + wobble, 
                    leftOption: { val: isLeftCorrect ? correctVal : wrongVal, correct: isLeftCorrect, isDead: false },
                    rightOption: { val: isLeftCorrect ? wrongVal : correctVal, correct: !isLeftCorrect, isDead: false }
                });

                if (rows.value.length > 5) rows.value.shift();
            };

            const handleChoice = (row, option) => {
                if (gameState.value !== 'PLAYING') return;
                if (isJumping.value) return; 
                if (option.isDead) return; 

                const activeRow = rows.value[rows.value.length - 1];
                if (row.id !== activeRow.id) return;

                if (option.correct) {
                    isJumping.value = true;
                    audio.playJump();
                    currentNumber.value = option.val;
                    score.value += 10;
                    currentRowId.value = row.id + 1;

                    const targetX = option === row.leftOption ? row.leftX : row.rightX;

                    doJumpAnimation(targetX, () => {
                        if (score.value % 50 === 0) { 
                            lives.value = Math.min(lives.value + 1, 8); 
                            level.value++;
                            
                            showLevelUp.value = true;
                            showHeartAnim.value = true; 
                            
                            audio.playLevelUp();
                            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#f472b6', '#34d399', '#ffb700'] });
                            
                            setTimeout(() => {
                                showLevelUp.value = false;
                                showHeartAnim.value = false;
                            }, 2000);
                        }
                        
                        addNextRow(row.id + 1);
                        isJumping.value = false; 
                    });

                } else {
                    lives.value--;
                    audio.playError();
                    option.isDead = true; 
                    
                    gsap.to(frogRef.value, { x: "+=10", duration: 0.05, yoyo: true, repeat: 5 });
                    gsap.to("body", { backgroundColor: "#fecaca", duration: 0.1, yoyo: true, repeat: 1, onComplete: () => {
                        gsap.set("body", { backgroundColor: "#38bdf8" });
                    }});

                    if (lives.value <= 0) {
                        gameState.value = 'GAMEOVER';
                    }
                }
            };

            const doJumpAnimation = (targetX, onComplete) => {
                const tl = gsap.timeline({ onComplete });
                
                tl.to(frogRef.value, { scaleX: 1.3, scaleY: 0.7, duration: 0.1 });
                
                tl.to(frogRef.value, {
                    x: targetX,
                    scaleX: 1, scaleY: 1,
                    duration: 0.4,
                    ease: "power2.out"
                }, "jump");

                tl.to(frogRef.value, {
                    y: -150, 
                    duration: 0.2,
                    yoyo: true,
                    repeat: 1,
                    ease: "sine.out"
                }, "jump");
                
                tl.to(frogRef.value, { y: 10, duration: 0.1 }, "land");

                rows.value.forEach(r => {
                     gsap.to(r, { 
                         y: r.y + 170,
                         duration: 0.4,
                         ease: "power2.inOut"
                     });
                });

                gsap.to(layout, {
                    startPadY: layout.startPadY + 170,
                    duration: 0.4,
                    ease: "power2.inOut",
                    onComplete: () => {
                        if(layout.startPadY > window.innerHeight + 200) {
                            showStartPad.value = false;
                        }
                    }
                });
                
                decoLilies.value.forEach(l => {
                    const currentTop = l.y;
                    const newTop = currentTop + 15; 
                    
                    if (newTop > 110) {
                        gsap.set(l, { y: -10, x: Math.random() * 100 });
                        l.transform = `scale(${0.5 + Math.random()}) rotate(${Math.random()*360}deg)`;
                    } else {
                         gsap.to(l, { y: newTop, duration: 0.4, ease: "power2.inOut" });
                    }
                });
            };

            const handleKey = (e) => {
                if (gameState.value !== 'PLAYING') return;
                
                const activeRow = rows.value[rows.value.length - 1];
                
                if (e.key === 'ArrowLeft' || e.key.toLowerCase() === 'a') {
                    handleChoice(activeRow, activeRow.leftOption);
                }
                if (e.key === 'ArrowRight' || e.key.toLowerCase() === 'd') {
                    handleChoice(activeRow, activeRow.rightOption);
                }
            };

            const trackEyes = (e) => {
                const pupils = document.querySelectorAll('.pupil');
                pupils.forEach(pupil => {
                    const rect = pupil.getBoundingClientRect();
                    const x = (rect.left + rect.width/2);
                    const y = (rect.top + rect.height/2);
                    const angle = Math.atan2(e.clientY - y, e.clientX - x);
                    const dist = Math.min(3, Math.hypot(e.clientX - x, e.clientY - y)/20);
                    pupil.style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
                });
            };

            onMounted(() => {
                window.addEventListener('keydown', handleKey);
                window.addEventListener('mousemove', trackEyes);
            });
            
            onUnmounted(() => {
                window.removeEventListener('keydown', handleKey);
            });

            return {
                gameState, score, level, lives, currentRule, rows, decoLilies,
                frogRef, frogBaseY, currentNumber, currentRowId, layout, showStartPad,
                startGame, handleChoice, toggleAudio, audioEnabled, showLevelUp, showHeartAnim
            };
        }
    }).mount('#game-app');
</script>
</body>
</html>