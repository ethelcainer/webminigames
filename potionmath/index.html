<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Potion Math</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Fredoka One', cursive;
            background-color: #0f0a1e; /* Very Dark Purple */
            color: white;
            overflow: hidden;
            user-select: none;
            touch-action: none;
        }

        .cartoon-text {
            -webkit-text-stroke: 1.5px #000;
            text-shadow: 2px 2px 0 #000, 0 0 10px currentColor;
        }
        
        .fantasy-font {
            font-family: 'MedievalSharp', cursive;
        }

        #game-area {
            position: relative;
            width: 100vw;
            height: 100vh;
            /* Swirling magical background */
            background: 
                radial-gradient(circle at 20% 30%, rgba(129, 140, 248, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(236, 72, 153, 0.2) 0%, transparent 50%),
                linear-gradient(to bottom, #1e1b4b, #0f172a);
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
            transition: background 0.3s ease;
        }
        
        /* Ambient particles in background */
        .ambient-particle {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0.3;
            pointer-events: none;
            animation: float-ambient 10s infinite linear;
        }
        
        @keyframes float-ambient {
            0% { transform: translateY(0) translateX(0); opacity: 0; }
            50% { opacity: 0.5; }
            100% { transform: translateY(-100vh) translateX(50px); opacity: 0; }
        }

        /* --- UI Elements --- */
        #ui-bar {
            margin-top: 30px;
            display: flex;
            gap: 30px;
            z-index: 50;
        }

        .stat-box {
            background: linear-gradient(145deg, #312e81, #1e1b4b);
            border: 3px solid #a5b4fc;
            border-radius: 15px;
            padding: 12px 35px;
            font-size: 1.6rem;
            box-shadow: 0 8px 0 #1e1b4b, 0 0 20px rgba(165, 180, 252, 0.3);
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
            overflow: hidden;
        }
        
        /* Adds a subtle glow effect */
        .stat-box::before {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            pointer-events: none;
        }

        /* --- The Cauldron --- */
        #cauldron-container {
            position: absolute;
            bottom: 0; /* Anchored to bottom */
            width: 380px;
            height: 300px;
            z-index: 10;
            filter: drop-shadow(0 10px 30px rgba(0,0,0,0.6));
        }

        #cauldron-body {
            width: 100%;
            height: 100%;
            /* Cast Iron Texture */
            background: 
                linear-gradient(to right, rgba(0,0,0,0.3) 0%, transparent 30%, transparent 70%, rgba(0,0,0,0.3) 100%),
                linear-gradient(135deg, #2d3748, #1a202c);
            border-radius: 0 0 190px 190px;
            border: 5px solid #4a5568;
            border-top: none;
            position: relative;
            overflow: hidden;
        }
        
        /* Magical Rune glowing on the pot */
        #rune-glow {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 150px; height: 150px;
            background: radial-gradient(circle, rgba(74, 222, 128, 0.2) 0%, transparent 70%);
            pointer-events: none;
            animation: pulse-rune 3s infinite ease-in-out;
        }
        @keyframes pulse-rune { 0%, 100% { opacity: 0.5; scale: 1; } 50% { opacity: 1; scale: 1.1; } }


        #cauldron-rim {
            position: absolute;
            top: -25px;
            left: -20px;
            width: 420px;
            height: 50px;
            background: linear-gradient(to bottom, #4a5568, #2d3748);
            border-radius: 25px;
            border: 4px solid #2d3748;
            box-shadow: 0 5px 10px rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 25;
        }

        /* The Green Liquid */
        #liquid {
            position: absolute;
            top: 10px; /* Pushed down slightly */
            left: 20px;
            width: 340px;
            height: 60px; /* Elliptical surface */
            background: linear-gradient(to bottom, #4ade80, #22c55e);
            border-radius: 50%;
            box-shadow: 0 0 30px #4ade80, inset 0 0 20px rgba(255,255,255,0.5);
            animation: liquid-wobble 3s infinite ease-in-out;
            z-index: 20;
        }
        
        @keyframes liquid-wobble {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(1.1); }
        }

        /* Target Display on Cauldron Body */
        #target-display {
            position: absolute;
            top: 45%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 6rem;
            color: #86efac;
            z-index: 20;
            text-shadow: 0 0 30px #22c55e, 2px 2px 0 #000;
        }
        
        /* Current Sum on Rim */
        #current-sum-display {
            font-size: 1.8rem;
            color: #e2e8f0;
            text-shadow: 1px 1px 0 #000;
        }

        /* --- Bubbles --- */
        .bubble {
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            /* Magical glowing orb look */
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,1), rgba(167, 243, 208, 0.8) 40%, rgba(52, 211, 153, 0.6) 80%);
            border: 3px solid rgba(255,255,255,0.8);
            box-shadow: 0 0 25px rgba(52, 211, 153, 0.6), inset 0 0 10px rgba(255,255,255,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
            color: #064e3b;
            cursor: pointer;
            user-select: none;
            animation: float-up var(--duration) linear forwards, wobble 2s infinite ease-in-out;
            transition: transform 0.1s;
            z-index: 5; /* Behind cauldron rim/liquid */
        }
        
        .bubble:active { transform: scale(0.9) !important; filter: brightness(1.2); }
        
        @keyframes wobble {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(10px); }
        }

        @keyframes float-up {
            from { bottom: -100px; }
            to { bottom: 110vh; }
        }

        /* --- Effects --- */
        .stage-red {
            background: radial-gradient(circle at center, #7f1d1d 0%, #450a0a 100%) !important;
        }
        
        .stage-green {
            background: radial-gradient(circle at center, #052e16 0%, #022c22 100%) !important;
        }

        .sparkle {
            position: absolute;
            width: 15px; height: 15px;
            background: #fbbf24;
            border-radius: 50%;
            box-shadow: 0 0 10px #fbbf24;
            animation: fly-out 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            pointer-events: none;
            z-index: 100;
        }

        @keyframes fly-out {
            0% { transform: translate(0,0) scale(1) rotate(0deg); opacity: 1; }
            100% { transform: translate(var(--dx), var(--dy)) scale(0) rotate(360deg); opacity: 0; }
        }
        
        /* Modal */
        #start-modal {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        
        .modal-content {
            background: linear-gradient(145deg, #312e81, #1e1b4b);
            border: 4px solid #a5b4fc;
            box-shadow: 0 0 50px rgba(165, 180, 252, 0.4);
        }
    </style>
</head>
<body>

<div id="game-area">
    
    <div id="ui-bar">
        <div class="stat-box">
            <span class="text-3xl">üèÜ</span> <span id="score" class="cartoon-text text-yellow-300">0</span>
        </div>
        <div class="stat-box">
            <span class="fantasy-font text-xl">LEVEL</span> <span id="level" class="cartoon-text text-indigo-300">1</span>
        </div>
    </div>

    <div id="cauldron-container">
        <div id="cauldron-rim">
             <div id="current-sum-display" class="fantasy-font">In Pot: <span id="current-sum" class="cartoon-text text-green-300 text-2xl">0</span></div>
        </div>
        <div id="cauldron-body">
            <div id="rune-glow"></div>
            <div id="liquid"></div>
            <div id="target-display" class="cartoon-text fantasy-font">10</div>
        </div>
    </div>

</div>

<div id="start-modal">
    <div class="modal-content p-10 rounded-[3rem] text-center max-w-lg transform hover:scale-105 transition-transform">
        <h1 class="text-5xl text-yellow-300 mb-6 cartoon-text fantasy-font">üßô‚Äç‚ôÇÔ∏è Potion Math</h1>
        <p class="text-2xl text-indigo-100 mb-8 leading-relaxed fantasy-font">
            Help the wizard brew!
            <br>
            Pop bubbles to <b>ADD</b> numbers.
            <br>
            Match the <span class="text-green-400">TARGET</span> exactly!
        </p>
        <button onclick="startGame()" class="bg-green-500 hover:bg-green-400 text-white text-3xl py-4 px-12 rounded-full shadow-[0_8px_0_#15803d,0_0_20px_#22c55e] active:shadow-none active:translate-y-2 transition-all cartoon-text fantasy-font">
            Start Brewing!
        </button>
    </div>
</div>

<script>
    // --- Audio Synth ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        if (type === 'pop') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(400, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        } else if (type === 'magic') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(400, audioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(1200, audioCtx.currentTime + 0.4);
            gain.gain.setValueAtTime(0.4, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.5);
            osc.start(); osc.stop(audioCtx.currentTime + 0.5);
        } else if (type === 'fail') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(50, audioCtx.currentTime + 0.5);
            gain.gain.setValueAtTime(0.4, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.5);
            osc.start(); osc.stop(audioCtx.currentTime + 0.5);
        }
    }

    // --- State ---
    const gameArea = document.getElementById('game-area');
    const targetDisplay = document.getElementById('target-display');
    const currentSumDisplay = document.getElementById('current-sum');
    const scoreDisplay = document.getElementById('score');
    const levelDisplay = document.getElementById('level');
    
    let targetNumber = 10;
    let currentSum = 0;
    let score = 0;
    let level = 1;
    let isGameActive = false;
    let spawnRate = 2000;
    let bubbleInterval;

    // Add ambient particles
    for(let i=0; i<20; i++) {
        const p = document.createElement('div');
        p.classList.add('ambient-particle');
        p.style.left = Math.random() * 100 + 'vw';
        p.style.top = Math.random() * 100 + 'vh';
        p.style.width = p.style.height = (Math.random() * 5 + 2) + 'px';
        p.style.animationDelay = (Math.random() * 10) + 's';
        gameArea.appendChild(p);
    }

    // --- Game Logic ---

    function generateTarget() {
        if (level < 3) targetNumber = Math.floor(Math.random() * 6) + 5; 
        else if (level < 5) targetNumber = Math.floor(Math.random() * 10) + 10; 
        else targetNumber = Math.floor(Math.random() * 15) + 15; 
        
        targetDisplay.textContent = targetNumber;
        currentSum = 0;
        currentSumDisplay.textContent = currentSum;
        
        targetDisplay.style.transform = "translate(-50%, -50%) scale(1.3)";
        setTimeout(() => targetDisplay.style.transform = "translate(-50%, -50%) scale(1)", 300);
    }

    function spawnBubble() {
        if (!isGameActive) return;

        const bubble = document.createElement('div');
        bubble.classList.add('bubble');
        
        const val = Math.floor(Math.random() * Math.min(9, targetNumber)) + 1;
        
        bubble.innerHTML = `<span class="cartoon-text">${val}</span>`;
        bubble.dataset.value = val;

        const xPos = Math.random() * (window.innerWidth - 100) + 10;
        bubble.style.left = xPos + 'px';
        
        const duration = (Math.random() * 4 + 4) + 's';
        bubble.style.setProperty('--duration', duration);

        bubble.addEventListener('pointerdown', (e) => {
            popBubble(bubble, parseInt(bubble.dataset.value), e.clientX, e.clientY);
        });

        bubble.addEventListener('animationend', () => {
            bubble.remove();
        });

        gameArea.appendChild(bubble);
    }

    function popBubble(el, val, x, y) {
        playSound('pop');
        createSparkles(x, y, '#60a5fa'); 
        el.remove();
        
        currentSum += val;
        currentSumDisplay.textContent = currentSum;

        checkWinCondition();
    }

    function checkWinCondition() {
        if (currentSum === targetNumber) {
            // SUCCESS
            playSound('magic');
            score += 10;
            level++;
            
            scoreDisplay.textContent = score;
            levelDisplay.textContent = level;
            
            gameArea.classList.add('stage-green');
            createSparkles(window.innerWidth/2, window.innerHeight/2, '#4ade80', 40);
            
            document.querySelectorAll('.bubble').forEach(b => {
                createSparkles(b.offsetLeft + 40, b.offsetTop + 40, '#fff', 5);
                b.remove();
            });

            setTimeout(() => {
                gameArea.classList.remove('stage-green');
                generateTarget();
                clearInterval(bubbleInterval);
                spawnRate = Math.max(600, 2000 - (level * 120));
                bubbleInterval = setInterval(spawnBubble, spawnRate);
            }, 1200);

        } else if (currentSum > targetNumber) {
            // FAIL
            playSound('fail');
            
            gameArea.classList.add('stage-red');
            currentSumDisplay.classList.add('text-red-400');
            
            setTimeout(() => {
                gameArea.classList.remove('stage-red');
                currentSumDisplay.classList.remove('text-red-400');
                
                currentSum = 0;
                currentSumDisplay.textContent = 0;
            }, 800);
        }
    }

    function createSparkles(x, y, color, count = 12) {
        for(let i=0; i<count; i++) {
            const spark = document.createElement('div');
            spark.classList.add('sparkle');
            spark.style.backgroundColor = color;
            spark.style.boxShadow = `0 0 15px ${color}`;
            spark.style.left = x + 'px';
            spark.style.top = y + 'px';
            
            const angle = Math.random() * Math.PI * 2;
            const speed = Math.random() * 150 + 50;
            spark.style.setProperty('--dx', Math.cos(angle) * speed + 'px');
            spark.style.setProperty('--dy', Math.sin(angle) * speed + 'px');
            
            gameArea.appendChild(spark);
            setTimeout(() => spark.remove(), 800);
        }
    }

    function startGame() {
        document.getElementById('start-modal').style.display = 'none';
        isGameActive = true;
        generateTarget();
        
        if (bubbleInterval) clearInterval(bubbleInterval);
        bubbleInterval = setInterval(spawnBubble, spawnRate);
    }

</script>

</body>
</html>