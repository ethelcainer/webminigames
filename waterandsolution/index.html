<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H2O Master-Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --black: #000000;
            --yellow: #FFE600;
            --pink: #FF4DAA;
            --cyan: #00E5FF;
            --purple: #7B2CBF;
            --bg-outer: #FF4DAA;
        }
        
        @keyframes moveBg {
            from { background-position: 0 0; }
            to { background-position: 40px 40px; }
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background-color: var(--bg-outer);
            background-image: 
                radial-gradient(circle at 2px 2px, rgba(0,0,0,0.15) 2px, transparent 0);
            background-size: 40px 40px;
            animation: moveBg 8s linear infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        .game-cabinet {
            background: #FFFFFF;
            border: 2px solid var(--black);
            box-shadow: 8px 8px 0px var(--black);
            width: 95vw;
            max-width: 1000px;
            height: 90vh;
            max-height: 700px;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .brutal-border { border: 2px solid var(--black); }
        .brutal-shadow { box-shadow: 3px 3px 0px var(--black); }

        .btn-interact {
            transition: transform 0.1s, box-shadow 0.1s;
            cursor: pointer;
        }
        .btn-interact:active {
            transform: translate(2px, 2px);
            box-shadow: 0px 0px 0px var(--black);
        }

        .retro-font { font-family: 'Fredoka One', cursive; text-transform: uppercase; }
        
        .status-bar {
            height: 50px;
            border-bottom: 2px solid var(--black);
            background: var(--yellow);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 20px;
            z-index: 30;
        }

        .meter-container {
            flex-grow: 1;
            max-width: 250px;
            height: 18px;
            background: #FFF;
            border: 2px solid var(--black);
            position: relative;
            overflow: hidden;
        }
        .meter-fill {
            height: 100%;
            width: 70%;
            background: #22C55E;
            transition: width 0.3s ease;
        }

        .main-stage {
            flex-grow: 1;
            display: grid;
            grid-template-columns: 180px 1fr 220px;
            overflow: hidden;
        }

        .sidebar {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            border-right: 2px solid var(--black);
            background: #FAFAFA;
        }

        .control-panel {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            border-left: 2px solid var(--black);
            background: #FAFAFA;
        }

        .flask-stage {
            background: var(--cyan);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .flask-container {
            width: 300px;
            height: 400px;
            position: relative;
        }

        #lab-canvas {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5; pointer-events: none;
        }

        .order-box {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            background: white;
            border: 2px solid black;
            padding: 10px;
            z-index: 20;
            box-shadow: 4px 4px 0px black;
        }

        .timer-line {
            height: 6px;
            background: black;
            width: 100%;
            margin-top: 6px;
            transform-origin: left;
        }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
        }
        .shake-it { animation: shake 0.5s; }

        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            background: #eee;
            border: 1.5px solid black;
            outline: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--pink);
            border: 1.5px solid black;
            cursor: pointer;
        }
        
        .pause-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 50;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }
    </style>
</head>
<body>

    <div class="game-cabinet">
        <!-- Pause Overlay -->
        <div id="pause-screen" class="pause-overlay">
            <h2 class="retro-font text-5xl mb-6">LAB PAUSED</h2>
            <button onclick="togglePause()" class="btn-interact brutal-border brutal-shadow bg-yellow-400 text-black px-12 py-4 retro-font text-2xl">RESUME</button>
            <p class="mt-4 text-xs opacity-50 retro-font">Press SPACE to Resume</p>
        </div>

        <!-- Header / Stats -->
        <div class="status-bar">
            <div class="flex items-center gap-3">
                <span class="retro-font text-[10px]">REP:</span>
                <div class="meter-container">
                    <div id="sat-fill" class="meter-fill"></div>
                </div>
                <span id="sat-text" class="retro-font text-[10px]">70%</span>
            </div>
            
            <button onclick="togglePause()" class="btn-interact brutal-border brutal-shadow bg-white px-3 py-1 retro-font text-[9px] flex items-center gap-2">
                PAUSE
            </button>

            <div class="ml-auto">
                <div class="bg-white border-[2px] border-black px-3 py-1 retro-font text-[9px]">
                    SOLVED: <span id="orders-count">0</span>
                </div>
            </div>
        </div>

        <!-- Main Workspace -->
        <div class="main-stage">
            
            <!-- Left: Ingredients -->
            <div class="sidebar">
                <h3 class="retro-font text-[9px] mb-1 opacity-50">Solutes</h3>
                
                <button onclick="addParticle('salt')" class="btn-interact brutal-border brutal-shadow bg-white p-3 flex flex-col items-center gap-2 group">
                    <svg width="32" height="32" viewBox="0 0 40 40">
                        <rect x="5" y="5" width="30" height="30" fill="white" stroke="black" stroke-width="2"/>
                        <circle cx="12" cy="12" r="2" fill="black"/>
                        <circle cx="28" cy="28" r="2" fill="black"/>
                        <circle cx="20" cy="20" r="2" fill="black"/>
                    </svg>
                    <span class="text-[8px] font-black uppercase">Salt</span>
                </button>

                <button onclick="addParticle('sugar')" class="btn-interact brutal-border brutal-shadow bg-orange-50 p-3 flex flex-col items-center gap-2 group">
                    <svg width="32" height="32" viewBox="0 0 40 40">
                        <path d="M20 5 L35 20 L20 35 L5 20 Z" fill="white" stroke="black" stroke-width="2"/>
                    </svg>
                    <span class="text-[8px] font-black uppercase">Sugar</span>
                </button>

                <button onclick="addParticle('dye')" class="btn-interact brutal-border brutal-shadow bg-pink-100 p-3 flex flex-col items-center gap-2 group">
                    <svg width="32" height="32" viewBox="0 0 40 40">
                        <path d="M20 5 C12 20 12 25 12 30 A8 8 0 0 0 28 30 C28 25 28 20 20 5" fill="white" stroke="black" stroke-width="2"/>
                    </svg>
                    <span class="text-[8px] font-black uppercase">Dye</span>
                </button>
            </div>

            <!-- Center: Lab -->
            <div class="flask-stage">
                <div id="order-box" class="order-box">
                    <div class="flex justify-between items-center">
                        <span class="retro-font text-[8px] text-gray-400 italic">Order:</span>
                        <span id="order-timer-txt" class="retro-font text-[8px] bg-black text-white px-2">10s</span>
                    </div>
                    <p id="order-desc" class="retro-font text-xs leading-tight mt-1">Saturated Hot Dye</p>
                    <div id="order-timer-fill" class="timer-line"></div>
                </div>

                <div class="flask-container" id="flask-visual">
                    <canvas id="lab-canvas"></canvas>
                    <svg class="w-full h-full" viewBox="0 0 300 400">
                        <defs>
                            <clipPath id="flask-clip">
                                <path d="M110 40 L110 140 L50 350 Q50 380 80 380 L220 380 Q250 380 250 350 L190 140 L190 40 Z" />
                            </clipPath>
                        </defs>
                        <!-- Glass Shape -->
                        <path d="M110 40 L110 140 L50 350 Q50 380 80 380 L220 380 Q250 380 250 350 L190 140 L190 40 Z" fill="rgba(255,255,255,0.4)" stroke="black" stroke-width="2" />
                        
                        <g clip-path="url(#flask-clip)">
                            <!-- Liquid Bulb Area -->
                            <rect id="liquid-body" x="0" y="170" width="300" height="210" fill="#E0F7FF" style="transition: fill 0.8s ease;" />
                        </g>
                        <!-- Reflections -->
                        <path d="M125 50 L125 110" stroke="white" stroke-width="1.5" opacity="0.6" stroke-linecap="round" />
                    </svg>
                </div>
            </div>

            <!-- Right: Controls -->
            <div class="control-panel">
                <div class="flex flex-col gap-1">
                    <span class="retro-font text-[8px] opacity-50">Temperature</span>
                    <div class="brutal-border p-3 bg-white">
                        <div class="flex justify-between items-center mb-1">
                            <span id="temp-val" class="retro-font text-base">25°C</span>
                        </div>
                        <input type="range" id="temp-slider" min="5" max="95" value="25">
                    </div>
                </div>

                <div class="flex flex-col gap-2">
                    <span class="retro-font text-[8px] opacity-50">Solution Analyzer</span>
                    <div class="brutal-border p-3 bg-black text-white text-center">
                        <span id="conc-tag" class="retro-font text-[10px]">Unsaturated</span>
                    </div>
                    
                    <button onclick="checkGoal()" class="btn-interact brutal-border brutal-shadow bg-cyan-400 py-4 retro-font text-lg mt-1">
                        SERVE!
                    </button>
                </div>

                <div class="mt-auto">
                    <button onclick="resetLab()" class="w-full text-[8px] font-black uppercase text-center underline hover:text-pink-500 transition-colors">
                        Dump Lab
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Screen Overlays -->
    <div id="game-over" class="fixed inset-0 z-[100] bg-black hidden flex-col items-center justify-center text-white p-6">
        <h2 class="retro-font text-6xl mb-4 text-pink-500">YOU'RE FIRED!</h2>
        <p class="retro-font text-lg mb-10 text-center">Reputation reached 0. The potion shop is bankrupt!</p>
        <button onclick="location.reload()" class="btn-interact brutal-border brutal-shadow bg-cyan-400 text-black px-12 py-4 retro-font text-2xl">RE-APPLY</button>
    </div>

    <div id="intro-screen" class="fixed inset-0 z-[110] bg-purple-600 flex items-center justify-center p-8">
        <div class="brutal-border brutal-shadow p-10 bg-white max-w-lg text-center">
            <h1 class="retro-font text-5xl mb-6 leading-none">H2O MASTER</h1>
            <p class="font-bold text-base mb-8 leading-snug">Master the science of solutions! Mix, heat, and serve customers before they bail!</p>
            <button onclick="startGame()" class="btn-interact brutal-border brutal-shadow bg-yellow-400 py-6 px-16 retro-font text-3xl">START SHIFT</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('lab-canvas');
        const ctx = canvas.getContext('2d');
        const tempSlider = document.getElementById('temp-slider');
        const tempVal = document.getElementById('temp-val');
        const liquidBody = document.getElementById('liquid-body');
        const satFill = document.getElementById('sat-fill');
        const satText = document.getElementById('sat-text');
        const pauseScreen = document.getElementById('pause-screen');
        
        let particles = [];
        let solventLevel = 170; // Pixel Y coordinate where liquid starts
        let currentTemp = 25;
        
        // Tracking solutes dissolved
        let dissolvedStats = { salt: 0, sugar: 0, dye: 0 };
        let totalSolute = 0;
        
        let satisfaction = 70;
        let ordersCompleted = 0;
        let currentOrder = null;
        let orderTimeLeft = 100;
        let isGameRunning = false;
        let isPaused = false;

        const solutesList = ['salt', 'sugar', 'dye'];
        const tempsList = ['cold', 'warm', 'hot'];
        const concsList = ['dilute', 'concentrated', 'saturated'];

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSfx(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            
            if (type === 'click') {
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.1);
                osc.start(); osc.stop(now + 0.1);
            } else if (type === 'success') {
                osc.frequency.setValueAtTime(523.25, now);
                osc.frequency.setValueAtTime(659.25, now + 0.1);
                osc.frequency.setValueAtTime(783.99, now + 0.2);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                osc.start(); osc.stop(now + 0.5);
            } else if (type === 'fail') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(110, now);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(); osc.stop(now + 0.3);
            }
        }

        function startGame() {
            document.getElementById('intro-screen').style.display = 'none';
            isGameRunning = true;
            playSfx('success');
            initCanvas();
            newOrder();
            gameLoop();
            
            setInterval(() => {
                if(isGameRunning && !isPaused) updateSatisfaction(-0.1);
            }, 1000);
        }

        function togglePause() {
            if (!isGameRunning) return;
            isPaused = !isPaused;
            pauseScreen.style.display = isPaused ? 'flex' : 'none';
            playSfx('click');
        }

        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                togglePause();
            }
        });

        function initCanvas() {
            canvas.width = document.getElementById('flask-visual').offsetWidth;
            canvas.height = document.getElementById('flask-visual').offsetHeight;
        }

        function updateSatisfaction(delta) {
            satisfaction = Math.min(100, Math.max(0, satisfaction + delta));
            satFill.style.width = satisfaction + '%';
            satText.innerText = Math.round(satisfaction) + '%';
            satFill.style.backgroundColor = satisfaction > 60 ? "#22C55E" : (satisfaction > 30 ? "#FFE600" : "#EF4444");

            if (satisfaction <= 0) {
                isGameRunning = false;
                document.getElementById('game-over').style.display = 'flex';
            }
        }

        function newOrder() {
            const solute = solutesList[Math.floor(Math.random() * solutesList.length)];
            const temp = tempsList[Math.floor(Math.random() * tempsList.length)];
            const conc = concsList[Math.floor(Math.random() * concsList.length)];
            currentOrder = { solute, temp, conc };
            orderTimeLeft = 100;
            document.getElementById('order-desc').innerText = `${temp} ${conc} ${solute}`.toUpperCase();
        }

        class Particle {
            constructor(type) {
                this.type = type;
                this.x = (canvas.width / 2) - 3 + Math.random() * 6;
                this.y = 0; 
                this.size = type === 'dye' ? 10 : 6;
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = 8 + Math.random() * 3; // Fast fall
                this.color = type === 'salt' ? '#BBB' : type === 'sugar' ? '#FFF' : '#FF4DAA';
                this.dissolved = false;
                this.timer = 0;
                this.opacity = 1;
            }
            update() {
                if (!this.dissolved) {
                    this.y += this.vy;
                    this.x += this.vx;
                    
                    if (this.y >= solventLevel) {
                        this.vy *= 0.3; // Water friction
                        
                        let dissolveRate = (currentTemp / 1000) + 0.02;
                        if (this.type === 'dye') dissolveRate *= 3;
                        
                        // Limit based on solubility
                        const limit = 120 + (currentTemp * 2.5);
                        
                        if (totalSolute < limit) {
                            this.timer += dissolveRate;
                            this.opacity -= 0.04; // Dissolving visual
                            if (this.opacity <= 0 && !this.dissolved) {
                                this.dissolved = true;
                                dissolvedStats[this.type]++;
                                totalSolute++;
                            }
                        } else {
                            // Precipitate - Visible at bottom
                            const bottom = 370;
                            if (this.y < bottom) {
                                this.y += 1.5;
                                if(this.x < 85) this.x += 1;
                                if(this.x > 215) this.x -= 1;
                            } else {
                                this.y = bottom;
                                this.vy = 0;
                                this.vx *= 0.8; // Slow down horizontal movement at bottom
                            }
                        }
                    }
                }
            }
            draw() {
                if (this.opacity <= 0) return;
                ctx.save();
                ctx.globalAlpha = Math.max(0, this.opacity);
                ctx.fillStyle = this.color;
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 1.0;
                if(this.type === 'dye') {
                    ctx.beginPath(); ctx.arc(this.x, this.y, this.size/2, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                } else {
                    ctx.fillRect(this.x - this.size/2, this.y - this.size/2, this.size, this.size); 
                    ctx.strokeRect(this.x - this.size/2, this.y - this.size/2, this.size, this.size);
                }
                ctx.restore();
            }
        }

        function addParticle(type) {
            if (isPaused) return;
            playSfx('click');
            for(let i=0; i<8; i++) particles.push(new Particle(type));
        }

        function checkGoal() {
            if (!currentOrder || isPaused) return;
            playSfx('click');

            const limit = 120 + (currentTemp * 2.5);
            const perc = (totalSolute / limit) * 100;
            
            // Re-checked Thresholds
            let curConc = 'dilute';
            if (totalSolute === 0) curConc = 'none';
            else if (perc >= 30 && perc < 90) curConc = 'concentrated';
            else if (perc >= 90) curConc = 'saturated';

            // Temperature Ranges
            let curTemp = 'cold';
            if (currentTemp > 30 && currentTemp <= 70) curTemp = 'warm';
            else if (currentTemp > 70) curTemp = 'hot';

            const hasTargetSolute = dissolvedStats[currentOrder.solute] > (totalSolute * 0.5);

            if (curConc === currentOrder.conc && curTemp === currentOrder.temp && hasTargetSolute) {
                playSfx('success');
                updateSatisfaction(20);
                ordersCompleted++;
                document.getElementById('orders-count').innerText = ordersCompleted;
                newOrder();
                resetLab();
            } else {
                playSfx('fail');
                updateSatisfaction(-12);
                document.getElementById('flask-visual').classList.add('shake-it');
                setTimeout(() => document.getElementById('flask-visual').classList.remove('shake-it'), 500);
            }
        }

        function resetLab() {
            if (isPaused) return;
            particles = [];
            totalSolute = 0;
            dissolvedStats = { salt: 0, sugar: 0, dye: 0 };
            liquidBody.style.fill = "#E0F7FF";
        }

        tempSlider.addEventListener('input', (e) => {
            if (isPaused) return;
            currentTemp = parseInt(e.target.value);
            tempVal.innerText = currentTemp + "°C";
        });

        function gameLoop() {
            if(!isGameRunning) return;
            
            if (!isPaused) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Filter out dissolved particles, keep only visible ones or precipitate
                particles = particles.filter(p => p.opacity > 0 || (totalSolute >= 120 + (currentTemp * 2.5) && !p.dissolved));
                
                particles.forEach(p => { p.update(); p.draw(); });

                orderTimeLeft -= 0.03; 
                document.getElementById('order-timer-fill').style.transform = `scaleX(${Math.max(0, orderTimeLeft / 100)})`;
                document.getElementById('order-timer-txt').innerText = Math.ceil(orderTimeLeft / 10) + 's';
                
                if (orderTimeLeft <= 0) {
                    playSfx('fail');
                    updateSatisfaction(-10);
                    newOrder();
                }

                const limit = 120 + (currentTemp * 2.5);
                const perc = (totalSolute / limit) * 100;
                const tag = document.getElementById('conc-tag');
                if (totalSolute === 0) tag.innerText = "EMPTY";
                else if (perc < 30) tag.innerText = "DILUTE";
                else if (perc < 90) tag.innerText = "CONCENTRATED";
                else tag.innerText = "SATURATED!";

                // Intelligent Color Blending
                const intensity = Math.min(1, perc / 100);
                if (dissolvedStats.dye > dissolvedStats.salt && dissolvedStats.dye > dissolvedStats.sugar) {
                    liquidBody.style.fill = `rgba(255, 77, 170, ${0.1 + intensity * 0.9})`;
                } else if (dissolvedStats.sugar > 10) {
                    liquidBody.style.fill = `rgba(255, 230, 0, ${0.1 + intensity * 0.5})`;
                } else if (dissolvedStats.salt > 10) {
                    liquidBody.style.fill = `rgba(200, 230, 255, ${0.1 + intensity * 0.4})`;
                } else {
                    liquidBody.style.fill = "#E0F7FF";
                }
            }

            requestAnimationFrame(gameLoop);
        }
    </script>
</body>
</html>