<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Body Quest! - Ultimate Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF9F43;
            --primary-dark: #E67E22;
            --secondary: #2ECC71;
            --secondary-dark: #27AE60;
            --accent: #54A0FF;
            --panel-bg: #FFFFFF;
            --placeholder: rgba(200, 200, 200, 0.3);
            --carbs: #f1c40f;
            --protein: #e67e22;
            --health: #2ecc71;
        }

        * { box-sizing: border-box; user-select: none; touch-action: none; }

        body {
            margin: 0;
            font-family: 'Fredoka', sans-serif;
            background-color: #d4e0ed;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            overflow: hidden;
        }

        #svg-defs { position: absolute; width: 0; height: 0; }

        #scenery-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            overflow: hidden;
            background: linear-gradient(to bottom, #48dbfb, #81ecec);
        }
        .bg-element { position: absolute; }
        #sun { top: 30px; right: 30px; width: 80px; height: 80px; animation: pulseSun 4s infinite alternate; }
        #cloud1 { top: 60px; left: 10%; width: 130px; animation: moveCloud 25s linear infinite; opacity: 0.8; }
        #cloud2 { top: 140px; left: 60%; width: 110px; animation: moveCloud 35s linear infinite reverse; opacity: 0.9; }
        #mountains { bottom: 0; left: 0; width: 100%; height: auto; }
        
        @keyframes moveCloud { from { transform: translateX(-200px); } to { transform: translateX(100vw); } }
        @keyframes pulseSun { from { transform: scale(1); } to { transform: scale(1.1); filter: brightness(1.1); } }

        #game-stage {
            max-width: 1100px;
            width: 100%;
            background: var(--panel-bg);
            padding: 20px;
            border-radius: 40px;
            border: 10px solid white;
            box-shadow: 0 20px 0 rgba(0,0,0,0.05), 0 15px 35px rgba(0,0,0,0.1);
            min-height: 580px;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            justify-content: center;
        }

        header { margin-bottom: 10px; text-align: center; }
        h1 { font-family: 'Fredoka', cursive; font-size: 2.8rem; color: white; text-shadow: 4px 4px 0px var(--primary-dark); margin: 0; letter-spacing: 2px; }

        .screen { display: none; flex-direction: column; align-items: center; justify-content: center; width: 100%; animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .screen.active { display: flex; }

        @keyframes pop { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }

        .teeth-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; width: 100%; max-width: 800px; margin-bottom: 20px; }
        .tooth-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 25px;
            border: 4px solid #e9ecef;
            cursor: pointer;
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-align: center;
            box-shadow: 0 8px 0 #dee2e6;
        }
        .tooth-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .tooth-card:active { transform: translateY(4px); box-shadow: none; }
        .tooth-card.selected { background: #fff3e0; border-color: var(--primary); box-shadow: 0 8px 0 var(--primary-dark); }
        .tooth-card.correct { opacity: 0.6; border-color: var(--secondary); pointer-events: none; box-shadow: none; transform: none; }
        .tooth-card.correct h3::after { content: ' ‚ú®'; }
        .tooth-card h3 { font-family: 'Fredoka'; margin: 8px 0 0 0; font-size: 1.2rem; color: #5a6e85; }
        .tooth-card svg { width: 100%; height: 100px; }

        .level-container { display: flex; width: 100%; gap: 15px; align-items: center; justify-content: center; }
        .organ-tray, .food-tray {
            flex: 0 0 240px;
            background: #fff9db;
            padding: 10px;
            border-radius: 30px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-height: 480px;
            border: 4px dashed #fab005;
            align-items: center;
            justify-content: center;
        }

        .food-tray {
            display: grid;
            grid-template-columns: 1fr 1fr;
            padding: 15px;
            gap: 15px; /* Increased gap */
        }

        .organ-item, .food-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; width: 100%; }
        .organ-item span, .food-item span { font-size: 0.75rem; font-weight: 700; color: #d35400; margin-top: 5px; text-align: center;}

        .canvas-area {
            flex: 1;
            position: relative;
            background: #f1f3f5;
            border-radius: 35px;
            height: 480px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 4px solid #e9ecef;
            max-width: 480px;
        }
        .canvas-area svg { height: 90%; width: auto; overflow: visible; }

        .draggable-organ {
            width: 100%; 
            height: 70px;
            cursor: grab;
            filter: drop-shadow(0 4px 3px rgba(0,0,0,0.1));
            transition: transform 0.2s;
        }

        /* Updated size for the food items on the tray */
        .draggable-food {
            width: 100%; 
            height: 95px;
            cursor: grab;
            filter: drop-shadow(0 4px 3px rgba(0,0,0,0.1));
            transition: transform 0.2s;
        }

        .draggable-organ:hover, .draggable-food:hover { transform: scale(1.1); }

        .organ-placeholder { fill: #e0e0e0; stroke: #adb5bd; stroke-width: 3; stroke-dasharray: 8, 8; opacity: 0.5; }

        /* Level 3 Specific Bars - Horizontal Buffet Style */
        .diet-status { 
            display: flex;
            width: 100%; 
            max-width: 900px; 
            gap: 20px;
            margin-bottom: 10px; 
            background: #f8f9fa;
            padding: 15px;
            border-radius: 20px;
            border: 1.5px solid #e9ecef;
        }
        .status-block { flex: 1; }
        .bar-container { width: 100%; height: 14px; background: #eee; border-radius: 10px; overflow: hidden; border: 1.5px solid #ddd; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.4s ease; border-radius: 8px; }
        .bar-label { font-size: 0.75rem; font-weight: 700; margin-bottom: 4px; display: flex; justify-content: space-between; }

        .game-btn {
            padding: 15px 30px;
            font-family: 'Fredoka', cursive;
            font-weight: 700;
            font-size: 1.1rem;
            border: none;
            border-radius: 50px;
            color: white;
            background: var(--secondary);
            cursor: pointer;
            box-shadow: 0 8px 0 #1E8449;
            margin: 8px;
            transition: all 0.1s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .game-btn:hover { filter: brightness(1.1); transform: translateY(-2px); }
        .game-btn:active { transform: translateY(6px); box-shadow: 0 2px 0 #1E8449; }
        
        .btn-start { font-size: 1.8rem; background: var(--primary); box-shadow: 0 10px 0 #c0392b; padding: 20px 50px; }
        .btn-start:active { box-shadow: 0 3px 0 #c0392b; }

        /* Style for the Serve Plate button */
        .btn-serve {
            background: var(--accent);
            box-shadow: 0 8px 0 #2980b9;
            margin-top: 15px;
        }
        .btn-serve:active { box-shadow: 0 2px 0 #2980b9; }

        .info-dialog {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 220px;
            background: white;
            padding: 15px;
            border-radius: 20px;
            border: 4px solid var(--primary);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            font-size: 0.85rem;
            color: #2d3436;
            display: none;
            z-index: 50;
            animation: pop 0.3s ease;
        }
        .info-dialog b { color: var(--primary-dark); display: block; margin-bottom: 5px; font-size: 1rem; }

        .particle {
            position: absolute;
            width: 10px; height: 10px;
            border-radius: 50%;
            pointer-events: none;
            animation: explode 0.8s forwards;
        }
        @keyframes explode { 
            0% { transform: translate(0,0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }
        
        h2 { font-family: 'Fredoka'; color: #2d3436; font-size: 1.8rem; margin-top: 0; }
        p { color: #636e72; font-weight: 500; }
    </style>
</head>
<body>

<div id="scenery-bg">
    <svg id="sun" class="bg-element" viewBox="0 0 100 100">
        <circle cx="50" cy="50" r="40" fill="#FDCB6E" stroke="#F39C12" stroke-width="2"/><circle cx="50" cy="50" r="30" fill="#FFEAA7"/>
    </svg>
    <svg id="cloud1" class="bg-element" viewBox="0 0 150 80">
        <path d="M20 60 C 20 30, 50 30, 60 40 C 70 20, 110 20, 120 40 C 140 40, 140 70, 120 70 L 20 70 C 0 70, 0 60, 20 60 Z" fill="#FFFFFF"/>
    </svg>
    <svg id="cloud2" class="bg-element" viewBox="0 0 120 70">
        <path d="M15 50 C 15 25, 40 25, 50 35 C 60 15, 95 15, 105 35 C 120 35, 120 60, 105 60 L 15 60 C 0 60, 0 50, 15 50 Z" fill="#FFFFFF"/>
    </svg>
    <svg id="mountains" class="bg-element" viewBox="0 0 1000 200" preserveAspectRatio="none">
        <path d="M0 200 L0 100 C 100 50, 200 150, 300 80 C 400 10, 500 100, 600 50 C 700 0, 800 120, 900 60 C 950 30, 1000 80, 1000 150 L 1000 200 Z" fill="#54a0ff" opacity="0.5"/>
    </svg>
</div>

<svg id="svg-defs">
    <defs>
        <radialGradient id="crown-grad" cx="50%" cy="30%" r="70%">
            <stop offset="0%" style="stop-color:#ffffff" /><stop offset="100%" style="stop-color:#e8e3d9" />
        </radialGradient>
        <linearGradient id="root-grad" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#f4f1e8" /><stop offset="100%" style="stop-color:#e0d0b8" />
        </linearGradient>
        <linearGradient id="body-grad" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#fce3d6" /><stop offset="100%" style="stop-color:#f2d2c2" />
        </linearGradient>
        <radialGradient id="liver-grad"><stop offset="0%" style="stop-color:#ff5252" /><stop offset="100%" style="stop-color:#b71c1c" /></radialGradient>
        <radialGradient id="stomach-grad"><stop offset="0%" style="stop-color:#ff80ab" /><stop offset="100%" style="stop-color:#ad1457" /></radialGradient>
        <linearGradient id="oes-grad" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#f8bbd0" /><stop offset="50%" style="stop-color:#fce4ec" /><stop offset="100%" style="stop-color:#f8bbd0" /></linearGradient>
        <linearGradient id="large-grad"><stop offset="0%" style="stop-color:#4dd0e1" /><stop offset="100%" style="stop-color:#00838f" /></linearGradient>
        <radialGradient id="small-grad"><stop offset="0%" style="stop-color:#f8bbd0" /><stop offset="100%" style="stop-color:#ec407a" /></radialGradient>
        <linearGradient id="panc-grad"><stop offset="0%" style="stop-color:#fff176" /><stop offset="100%" style="stop-color:#fbc02d" /></linearGradient>
        
        <radialGradient id="apple-grad"><stop offset="0%" style="stop-color:#ff5e57" /><stop offset="100%" style="stop-color:#c0392b" /></radialGradient>
        <linearGradient id="bread-grad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" style="stop-color:#ffda79" /><stop offset="100%" style="stop-color:#cc8e35" /></linearGradient>
        <linearGradient id="steak-grad"><stop offset="0%" style="stop-color:#ff4d4d" /><stop offset="100%" style="stop-color:#7d0606" /></linearGradient>
        <linearGradient id="banana-grad"><stop offset="0%" style="stop-color:#fff200" /><stop offset="100%" style="stop-color:#f1c40f" /></linearGradient>
        <radialGradient id="broccoli-grad"><stop offset="0%" style="stop-color:#2ecc71" /><stop offset="100%" style="stop-color:#1e8449" /></radialGradient>
        <radialGradient id="potato-grad"><stop offset="0%" style="stop-color:#d1ccc0" /><stop offset="100%" style="stop-color:#84817a" /></radialGradient>
        <radialGradient id="egg-grad"><stop offset="30%" style="stop-color:#f1c40f" /><stop offset="100%" style="stop-color:#ffffff" /></radialGradient>
    </defs>
</svg>

<header><h1>SUPER BODY QUEST!</h1></header>

<div id="game-stage">
    <div id="particle-layer" style="position:absolute; inset:0; pointer-events:none; z-index:100;"></div>
    <div id="info-box" class="info-dialog"></div>

    <div id="screen-start" class="screen active">
        <h2 style="font-size: 2.5rem; color:var(--primary-dark);">Hello, Young Doctor!</h2>
        <p style="font-size: 1.2rem;">Ready to explore how our body handles food?</p>
        <button class="game-btn btn-start" onclick="nextScreen('screen-L1')">START MISSION</button>
    </div>

    <div id="screen-L1" class="screen">
        <h2>Level 1: The Tooth Team</h2>
        <p>First, match each tooth to its special job!</p>
        <div class="teeth-grid">
            <div class="tooth-card" id="card-molar" onclick="selectTooth('molar', this)">
                <svg viewBox="0 0 200 300">
                    <path style="fill:url(#root-grad); stroke:#c7b299;" d="M60,140 C60,140 40,250 50,280 C55,295 75,290 85,270 L100,220 L115,270 C125,290 145,295 150,280 C160,250 140,140 140,140 L60,140 Z" />
                    <path style="fill:url(#crown-grad); stroke:#c0cdd8;" d="M40,150 C30,120 35,80 45,60 C55,40 70,35 90,45 C110,35 125,40 135,60 C145,80 170,120 160,150 C150,180 50,180 40,150 Z" />
                </svg>
                <h3>Molar</h3>
            </div>
            <div class="tooth-card" id="card-canine" onclick="selectTooth('canine', this)">
                <svg viewBox="0 0 200 300">
                    <path style="fill:url(#root-grad); stroke:#c7b299;" d="M70,150 C70,150 65,220 85,280 C95,300 105,300 115,280 C135,220 130,150 130,150 L70,150 Z" />
                    <path style="fill:url(#crown-grad); stroke:#c0cdd8;" d="M60,160 C55,130 70,100 100,30 C130,100 145,130 140,160 C135,185 65,185 60,160 Z" />
                </svg>
                <h3>Canine</h3>
            </div>
            <div class="tooth-card" id="card-incisor" onclick="selectTooth('incisor', this)">
                <svg viewBox="0 0 200 300">
                    <path style="fill:url(#root-grad); stroke:#c7b299;" d="M75,150 C75,150 75,240 90,280 C95,295 105,295 110,280 C125,240 125,150 125,150 L75,150 Z" />
                    <path style="fill:url(#crown-grad); stroke:#c0cdd8;" d="M65,160 C65,130 60,80 55,50 L145,50 C140,80 135,130 135,160 C130,185 70,185 65,160 Z" />
                </svg>
                <h3>Incisor</h3>
            </div>
        </div>
        <div class="btn-group">
            <button class="game-btn" onclick="matchTooth('tear')">Tears Food</button>
            <button class="game-btn" onclick="matchTooth('cut')">Cuts Food</button>
            <button class="game-btn" onclick="matchTooth('grind')">Grinds Food</button>
        </div>
    </div>

    <div id="screen-L2" class="screen">
        <h2 style="margin-bottom: 5px;">Level 2: The Flow of Food</h2>
        <div class="level-container">
            <div class="organ-tray" id="organ-tray-left"></div>
            <div class="canvas-area">
                <svg viewBox="0 0 600 950" id="body-svg">
                    <path style="fill:url(#body-grad); stroke:#e0b0a0; stroke-width:2;" d="M300,30 C240,30 200,70 200,130 C200,170 220,200 240,220 C180,250 140,350 130,500 C120,650 140,780 190,830 L220,830 L240,720 L360,720 L380,830 L410,830 C460,780 480,650 470,500 C460,350 420,250 360,220 C380,200 400,170 400,130 C400,70 360,30 300,30 Z" />
                    <g id="body-placeholders"></g>
                    <rect id="target-oesophagus" x="270" y="180" width="60" height="200" fill="transparent" />
                    <rect id="target-stomach" x="280" y="400" width="130" height="150" fill="transparent" />
                    <rect id="target-liver" x="150" y="350" width="150" height="150" fill="transparent" />
                    <rect id="target-large" x="240" y="570" width="120" height="200" fill="transparent" />
                    <rect id="target-pancreas" x="300" y="480" width="100" height="80" fill="transparent" />
                </svg>
            </div>
            <div class="organ-tray" id="organ-tray-right"></div>
        </div>
    </div>

    <div id="screen-L3" class="screen">
        <h2 style="margin-bottom: 5px;">Level 3: The Fuel Plate</h2>
        <div class="diet-status">
            <div class="status-block">
                <div class="bar-label"><span>Energy (Carbs)</span><span id="label-carbs">0%</span></div>
                <div class="bar-container"><div id="bar-carbs" class="bar-fill" style="background:var(--carbs)"></div></div>
            </div>
            <div class="status-block">
                <div class="bar-label"><span>Growth (Proteins)</span><span id="label-protein">0%</span></div>
                <div class="bar-container"><div id="bar-protein" class="bar-fill" style="background:var(--protein)"></div></div>
            </div>
            <div class="status-block">
                <div class="bar-label"><span>Health (Vitamins)</span><span id="label-health">0%</span></div>
                <div class="bar-container"><div id="bar-health" class="bar-fill" style="background:var(--health)"></div></div>
            </div>
        </div>
        <div class="level-container">
            <div class="food-tray" id="food-tray-left"></div>
            <div class="canvas-area">
                <svg viewBox="0 0 400 400" id="plate-svg">
                    <circle cx="200" cy="200" r="180" fill="white" stroke="#bdc3c7" stroke-width="6" />
                    <circle cx="200" cy="200" r="150" fill="none" stroke="#ecf0f1" stroke-width="1.5" stroke-dasharray="8,8" />
                    <circle id="target-plate" cx="200" cy="200" r="150" fill="transparent" />
                </svg>
            </div>
            <div class="food-tray" id="food-tray-right"></div>
        </div>
        <button class="game-btn btn-serve" onclick="nextScreen('screen-win')">SERVE MEAL üçΩÔ∏è</button>
    </div>

    <div id="screen-win" class="screen">
        <h2 style="font-size:3.5rem; color:var(--secondary-dark); margin:0;">QUEST COMPLETE!</h2>
        <p style="font-size:1.5rem;">You're a Body Biology Expert now!</p>
        <button class="game-btn btn-start" onclick="location.reload()">PLAY AGAIN</button>
    </div>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playTone(freq, type, dur) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type; osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + dur);
    }

    let selectedTooth = null;
    let l1Solved = 0;
    let l2Solved = 0;
    let l3Progress = { carbs: 0, protein: 0, health: 0 };

    const organData = [
        { id: 'oesophagus', name: 'Esophagus', desc: 'A long tube that carries food from your mouth down to your stomach.', path: 'M285,180 L285,390 Q285,410 300,415 L320,415 Q335,410 335,390 L335,180 Z', color: 'url(#oes-grad)', stroke: '#db7093' },
        { id: 'stomach', name: 'Stomach', desc: 'A muscular bag that mixes food with acids to break it into liquid.', path: 'M310,400 C360,400 400,430 415,480 C425,540 380,580 330,585 C270,590 260,530 285,490 C295,475 305,470 310,400 Z', color: 'url(#stomach-grad)', stroke: '#c51162' },
        { id: 'liver', name: 'Liver', desc: 'Creates bile to help digest fats and cleans your blood.', path: 'M280,350 C210,350 160,390 150,450 C145,490 170,530 230,540 C280,545 340,510 370,450 C390,410 350,360 280,350 Z', color: 'url(#liver-grad)', stroke: '#8e0000' },
        { id: 'large', name: 'Large Intestine', desc: 'Absorbs water and prepares waste to leave the body.', path: 'M260,570 C240,570 230,590 240,610 C230,630 240,650 250,660 C240,680 250,700 260,710 C250,730 260,760 280,770 L320,770 C340,760 350,730 340,710 C350,700 360,680 350,660 C360,650 370,630 360,610 C370,590 360,570 340,570 L260,570 Z M290,770 L290,810 C290,830 310,830 310,810 L310,770 Z', color: 'url(#large-grad)', stroke: '#007c91' },
        { id: 'pancreas', name: 'Pancreas', desc: 'Makes juices that help the body break down sugar and protein.', path: 'M320,500 C340,490 370,500 400,510 C430,520 450,540 440,555 C430,570 390,565 350,550 C320,540 300,520 320,500 Z', color: 'url(#panc-grad)', stroke: '#c49000' }
    ];

    const foodData = [
        { id: 'bread', type: 'carbs', name: 'Bread', desc: 'Carbohydrates give you the energy to run and play!', path: 'M120,220 Q120,150 200,150 Q280,150 280,220 L280,280 Q280,300 260,300 L140,300 Q120,300 120,280 Z', color: 'url(#bread-grad)', stroke: '#b33939' },
        { id: 'rice', type: 'carbs', name: 'Rice', desc: 'Rice is a great source of energy for your brain!', path: 'M120,300 Q200,180 280,300 Z', color: '#f7f1e3', stroke: '#d1ccc0' },
        { id: 'potato', type: 'carbs', name: 'Potato', desc: 'Potatoes are heavy with complex carbs for all-day energy.', path: 'M120,250 Q120,180 200,180 Q280,180 280,250 Q280,320 200,320 Q120,320 120,250', color: 'url(#potato-grad)', stroke: '#574b90' },
        { id: 'pasta', type: 'carbs', name: 'Pasta', desc: 'Pasta is a favorite fuel for long races and play.', path: 'M150,150 L180,350 M220,150 L250,350 M120,200 Q200,220 280,200', color: '#ffeaa7', stroke: '#fab1a0' },
        { id: 'fish', type: 'protein', name: 'Fish', desc: 'Fish has protein to help your muscles grow strong!', path: 'M120,220 Q200,140 280,220 Q200,300 120,220 M280,220 L320,180 L320,260 Z', color: '#74b9ff', stroke: '#0984e3' },
        { id: 'chicken', type: 'protein', name: 'Chicken', desc: 'Protein from meat builds and repairs your body.', path: 'M180,280 Q140,280 140,230 Q140,180 220,180 Q300,180 300,230 L310,310 L280,320 Z', color: '#cd84f1', stroke: '#8e44ad' },
        { id: 'steak', type: 'protein', name: 'Steak', desc: 'Beef protein helps keep your body strong and healthy.', path: 'M140,200 Q140,140 220,140 Q300,140 320,200 Q320,300 240,320 Q140,300 140,200', color: 'url(#steak-grad)', stroke: '#3d3d3d' },
        { id: 'egg', type: 'protein', name: 'Egg', desc: 'Eggs are small but packed with perfect protein.', path: 'M200,320 Q130,320 130,240 Q130,140 200,140 Q270,140 270,240 Q270,320 200,320', color: 'url(#egg-grad)', stroke: '#d1ccc0' },
        { id: 'apple', type: 'health', name: 'Apple', desc: 'Apples have vitamins to keep you from getting sick!', path: 'M200,300 C120,300 120,180 200,180 C280,180 280,300 200,300', color: 'url(#apple-grad)', stroke: '#630d0d' },
        { id: 'carrot', type: 'health', name: 'Carrot', desc: 'Carrots have Vitamin A which is great for your eyes!', path: 'M180,150 L240,350 Q200,380 160,350 Z', color: '#ff793f', stroke: '#cd6133' },
        { id: 'broccoli', type: 'health', name: 'Broccoli', desc: 'Broccoli is a superfood that protects your body!', path: 'M160,300 L240,300 L215,350 L185,350 Z M200,300 C150,300 130,230 200,230 C270,230 250,300 200,300', color: 'url(#broccoli-grad)', stroke: '#1b8d2a' },
        { id: 'banana', type: 'health', name: 'Banana', desc: 'Bananas are full of minerals for a happy heart.', path: 'M140,200 Q160,320 300,340 Q180,340 140,200', color: 'url(#banana-grad)', stroke: '#d35400' }
    ];

    function nextScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'screen-L2') initLevel2();
        if(id === 'screen-L3') initLevel3();
    }

    function selectTooth(type, el) {
        playTone(400, 'sine', 0.1);
        selectedTooth = type;
        document.querySelectorAll('.tooth-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
    }

    function matchTooth(job) {
        const map = { 'molar': 'grind', 'canine': 'tear', 'incisor': 'cut' };
        if(!selectedTooth) return;
        if(map[selectedTooth] === job) {
            playTone(800, 'sine', 0.2);
            document.getElementById('card-' + selectedTooth).classList.add('correct');
            selectedTooth = null;
            l1Solved++;
            if(l1Solved === 3) setTimeout(() => nextScreen('screen-L2'), 800);
        } else {
            playTone(200, 'sawtooth', 0.2);
        }
    }

    function initLevel2() {
        const trayL = document.getElementById('organ-tray-left');
        const trayR = document.getElementById('organ-tray-right');
        const pGroup = document.getElementById('body-placeholders');
        trayL.innerHTML = trayR.innerHTML = pGroup.innerHTML = '';

        organData.forEach((org, idx) => {
            const p = document.createElementNS("http://www.w3.org/2000/svg", "path");
            p.setAttribute("d", org.path); p.classList.add('organ-placeholder');
            p.id = 'placeholder-' + org.id; pGroup.appendChild(p);

            const item = document.createElement('div'); item.className = 'organ-item';
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("viewBox", "0 0 600 950"); svg.classList.add('draggable-organ');
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", org.path); path.style.fill = org.color;
            path.style.stroke = org.stroke; path.style.strokeWidth = "12px";
            const label = document.createElement('span'); label.innerText = org.name;
            svg.appendChild(path); item.appendChild(svg); item.appendChild(label);
            (idx < 3 ? trayL : trayR).appendChild(item);
            item.onclick = () => showInfo(org.name, org.desc);
            makeDraggable(svg, 'target-' + org.id, () => {
                const clone = path.cloneNode(true); clone.style.strokeWidth = "2px";
                document.getElementById('body-svg').appendChild(clone);
                document.getElementById('placeholder-' + org.id).remove();
                l2Solved++; if(l2Solved === 5) setTimeout(() => nextScreen('screen-L3'), 1000);
            });
        });
    }

    function initLevel3() {
        const trayL = document.getElementById('food-tray-left');
        const trayR = document.getElementById('food-tray-right');
        trayL.innerHTML = trayR.innerHTML = '';
        l3Progress = { carbs: 0, protein: 0, health: 0 }; updateBars();

        foodData.forEach((food, idx) => {
            const item = document.createElement('div'); item.className = 'food-item';
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("viewBox", "0 0 400 400"); svg.classList.add('draggable-food');
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", food.path); path.style.fill = food.color;
            path.style.stroke = food.stroke; path.style.strokeWidth = "1.5px";
            const label = document.createElement('span'); label.innerText = food.name;
            svg.appendChild(path); item.appendChild(svg); item.appendChild(label);
            (idx < 6 ? trayL : trayR).appendChild(item);
            item.onclick = () => showInfo(food.name, food.desc);
            
            makeDraggable(svg, 'target-plate', () => {
                const clone = svg.cloneNode(true); clone.style.position = 'absolute';
                // Increased the dropped food size from 60px to 95px
                clone.style.width = '95px'; clone.style.height = '95px';
                clone.style.left = 'calc(50% + ' + (Math.random()*80-40) + 'px)';
                clone.style.top = 'calc(50% + ' + (Math.random()*80-40) + 'px)';
                clone.style.pointerEvents = 'none'; // So they don't block future drops
                document.querySelector('#screen-L3 .canvas-area').appendChild(clone);
                l3Progress[food.type] += 25; updateBars();
                
                // Keep the auto-win if they happen to fill everything
                if(l3Progress.carbs >= 100 && l3Progress.protein >= 100 && l3Progress.health >= 100)
                    setTimeout(() => nextScreen('screen-win'), 1000);
            });
        });
    }

    function updateBars() {
        ['carbs', 'protein', 'health'].forEach(t => {
            const v = Math.min(100, l3Progress[t]);
            document.getElementById('bar-' + t).style.width = v + '%';
            document.getElementById('label-' + t).innerText = v + '%';
        });
    }

    function showInfo(n, d) {
        const b = document.getElementById('info-box');
        b.style.display = 'block'; b.innerHTML = `<b>${n}</b>${d}`;
        playTone(500, 'sine', 0.05);
    }

    function makeDraggable(el, tId, onS) {
        let isD = false, sX, sY;
        el.onpointerdown = (e) => {
            isD = true; el.setPointerCapture(e.pointerId);
            const r = el.getBoundingClientRect(); sX = e.clientX - r.left; sY = e.clientY - r.top;
            el.style.position = 'fixed'; 
            el.style.width = '120px'; // Size while dragging
            el.style.height = '120px'; 
            el.style.zIndex = '1000';
            playTone(600, 'sine', 0.05);
        };
        el.onpointermove = (e) => { if (isD) { el.style.left = (e.clientX - sX) + 'px'; el.style.top = (e.clientY - sY) + 'px'; } };
        el.onpointerup = (e) => {
            if (!isD) return; isD = false; el.releasePointerCapture(e.pointerId);
            const t = document.getElementById(tId), tR = t.getBoundingClientRect(), eR = el.getBoundingClientRect();
            if (eR.left < tR.right && eR.right > tR.left && eR.top < tR.bottom && eR.bottom > tR.top) {
                onS(e.clientX, e.clientY); el.parentElement.remove();
                document.getElementById('info-box').style.display = 'none';
                playTone(1000, 'sine', 0.2); burst(e.clientX, e.clientY);
            } else {
                el.style.position = 'static'; el.style.width = ''; el.style.height = '';
                playTone(100, 'sawtooth', 0.2);
            }
        };
    }

    function burst(x, y) {
        const l = document.getElementById('particle-layer');
        for(let i=0; i<20; i++) {
            const p = document.createElement('div'); p.classList.add('particle');
            p.style.background = `hsl(${Math.random()*360}, 80%, 60%)`;
            p.style.left = x + 'px'; p.style.top = y + 'px';
            p.style.setProperty('--tx', (Math.random()-0.5)*300 + 'px');
            p.style.setProperty('--ty', (Math.random()-0.5)*300 + 'px');
            l.appendChild(p); setTimeout(() => p.remove(), 1000);
        }
    }
</script>
</body>
</html>