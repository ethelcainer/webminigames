<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Science Lab: Mission Mastery Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361EE;
            --secondary: #3F37C9;
            --accent: #F72585;
            --success: #4CC9F0;
            --bg: #f8fafc;
            --card-bg: rgba(255, 255, 255, 0.9);
            --text: #1e293b;
            --glass-size: 160px;
        }

        * { box-sizing: border-box; font-family: 'Fredoka', sans-serif; }

        body {
            margin: 0;
            background: #bae6fd; /* Sky Blue */
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* --- BACKGROUND SCENERY --- */
        .background-scene {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .cloud {
            position: absolute;
            background: white;
            border-radius: 50px;
            opacity: 0.8;
            animation: moveClouds linear infinite;
        }
        .cloud::after, .cloud::before {
            content: ''; position: absolute; background: white; border-radius: 50%;
        }
        .c1 { width: 120px; height: 40px; top: 10%; left: -150px; animation-duration: 25s; }
        .c1::after { width: 60px; height: 60px; top: -30px; left: 20px; }
        .c2 { width: 100px; height: 30px; top: 25%; left: -150px; animation-duration: 35s; animation-delay: 5s; }
        .c2::after { width: 50px; height: 50px; top: -25px; left: 15px; }
        .c3 { width: 150px; height: 45px; top: 15%; left: -150px; animation-duration: 45s; animation-delay: 15s; }
        .c3::after { width: 70px; height: 70px; top: -35px; left: 30px; }

        @keyframes moveClouds {
            from { transform: translateX(-200px); }
            to { transform: translateX(calc(100vw + 200px)); }
        }

        .hills {
            position: absolute;
            bottom: 0; width: 100%; height: 250px;
            fill: #4ade80;
            z-index: -1;
        }

        /* --- SCREENS --- */
        .full-screen-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(67, 97, 238, 0.95);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            padding: 20px;
        }

        #game-over-screen { display: none; background: rgba(15, 23, 42, 0.98); }

        .logo-box {
            background: white;
            padding: 30px;
            border-radius: 40px;
            margin-bottom: 30px;
            box-shadow: 0 15px 0 rgba(0,0,0,0.2);
        }

        /* --- GAME UI --- */
        #game-container {
            display: none; /* Hidden until Start is clicked */
            flex-direction: column;
            align-items: center;
            z-index: 10;
        }

        #game-header {
            width: 900px;
            margin-bottom: 15px;
            padding: 12px 25px;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.8);
        }

        .mission-title { font-weight: 600; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; }

        .progress-container { width: 200px; height: 10px; background: #e2e8f0; border-radius: 10px; overflow: hidden; }
        #progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); transition: width 0.6s ease; }

        #game-viewport {
            width: 900px;
            height: 600px;
            position: relative;
        }

        .phase-panel {
            background: var(--card-bg);
            backdrop-filter: blur(15px);
            width: 100%;
            height: 100%;
            border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.7);
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 30px;
            position: absolute;
            top: 0;
            left: 0;
        }

        .phase-panel.active { display: flex; animation: slideUp 0.5s ease-out; }

        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        h2 { margin: 0 0 10px 0; font-size: 1.6rem; color: var(--secondary); }
        p { margin: 0 0 20px 0; color: #475569; font-size: 1rem; text-align: center; }

        /* --- Phase 1: Observation --- */
        #observation-container {
            position: relative;
            width: 500px; 
            height: 400px;
            background: #ffffff;
            border-radius: 25px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
            cursor: crosshair;
        }

        .hotspot {
            position: absolute;
            width: 40px;
            height: 40px;
            background: rgba(67, 97, 238, 0.1);
            border: 2px dashed var(--primary);
            border-radius: 50%;
            z-index: 60;
            display: none;
            animation: pulse 1.5s infinite;
            transform: translate(-20px, -20px); 
        }

        @keyframes pulse { 0% { transform: translate(-20px, -20px) scale(1); opacity: 1; } 50% { transform: translate(-20px, -20px) scale(1.2); opacity: 0.5; } 100% { transform: translate(-20px, -20px) scale(1); opacity: 1; } }

        #magnifier {
            position: absolute;
            width: var(--glass-size);
            height: var(--glass-size);
            border: 6px solid #334155;
            border-radius: 50%;
            box-shadow: 0 0 0 4000px rgba(0,0,0,0.1), 0 10px 30px rgba(0,0,0,0.2);
            pointer-events: none;
            z-index: 55;
            overflow: hidden;
            display: none;
        }

        /* --- Phase 2: Measuring --- */
        .measurement-lab { 
            display: flex; 
            gap: 40px; 
            width: 100%; 
            justify-content: center; 
            align-items: center; 
            position: relative;
            padding: 40px;
            background: rgba(255,255,255,0.4);
            border-radius: 20px;
        }
        
        .digital-scale-v2 {
            width: 320px;
            height: 220px;
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            position: relative;
            padding-bottom: 25px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.02);
        }

        #scale-plate { 
            width: 240px; height: 8px; background: #94a3b8; border-radius: 4px; 
            position: absolute; top: 40px;
        }

        #scale-reading {
            background: #1e293b;
            color: #4ade80;
            font-family: 'Courier New', monospace;
            font-size: 3rem;
            padding: 5px 25px;
            border-radius: 12px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
        }

        /* --- Phase 3: Classifying --- */
        #animal-bank {
            background: white;
            padding: 15px;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            width: 100%;
        }

        .drop-zone {
            flex: 1;
            border: 3px dashed #cbd5e1;
            border-radius: 24px;
            background: rgba(255, 255, 255, 0.8);
            min-height: 240px;
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
            gap: 12px;
            justify-content: center;
            transition: 0.3s;
            position: relative;
        }

        #zone-gills { background: linear-gradient(180deg, #f0f9ff 0%, #e0f2fe 100%); border-color: #7dd3fc; }
        #zone-lungs { background: linear-gradient(180deg, #fff1f2 0%, #ffe4e6 100%); border-color: #fda4af; }

        .animal-card {
            width: 110px;
            padding: 12px;
            background: white;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            cursor: grab;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: 0.2s;
        }

        /* --- Phase 4: Prediction --- */
        #p4-monitor {
            width: 100%;
            height: 320px;
            background: #0f172a;
            border-radius: 25px;
            border: 10px solid #334155;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.4);
        }

        #p4-monitor::before {
            content: "";
            position: absolute;
            width: 100%;
            height: 2px;
            background: rgba(76, 201, 240, 0.4);
            top: 0;
            animation: scanLine 3s linear infinite;
            z-index: 5;
        }

        @keyframes scanLine { from { top: 0%; } to { top: 100%; } }

        /* --- Buttons --- */
        .btn {
            padding: 14px 35px;
            border: none;
            border-radius: 16px;
            background: var(--primary);
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 6px 0 var(--secondary);
        }

        .btn:hover { background: var(--secondary); transform: translateY(-2px); }
        .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 var(--secondary); }
        .btn-large { font-size: 1.5rem; padding: 20px 50px; }

        #feedback {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: white;
            padding: 35px;
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            z-index: 1200;
            width: 350px;
            border: 2px solid var(--primary);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #feedback.show { transform: translate(-50%, -50%) scale(1); }

        /* --- NEW: Error Toast --- */
        #error-toast {
            position: fixed;
            bottom: 30px;
            background: #ef4444;
            color: white;
            padding: 15px 30px;
            border-radius: 12px;
            font-weight: 600;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            transform: translateY(100px);
            opacity: 0;
            transition: 0.3s;
            z-index: 2000;
        }
        #error-toast.active { transform: translateY(0); opacity: 1; }
    </style>
</head>
<body>

<div class="background-scene">
    <div class="cloud c1"></div>
    <div class="cloud c2"></div>
    <div class="cloud c3"></div>
    <svg class="hills" viewBox="0 0 1440 320" preserveAspectRatio="none">
        <path d="M0,192L48,197.3C96,203,192,213,288,192C384,171,480,117,576,112C672,107,768,149,864,165.3C960,181,1056,171,1152,149.3C1248,128,1344,96,1392,80L1440,64L1440,320L1392,320L1248,320L1152,320L1056,320L960,320L864,320L768,320L672,320L576,320L480,320L288,320L192,320L96,320L48,320L0,320Z"></path>
    </svg>
</div>

<div id="start-screen" class="full-screen-overlay">
    <div class="logo-box">
        <svg width="120" height="120" viewBox="0 0 100 100">
            <path d="M30 80 L70 80 L85 30 L15 30 Z" fill="none" stroke="#4361EE" stroke-width="4"/>
            <path d="M35 70 L65 70" stroke="#F72585" stroke-width="6" stroke-linecap="round"/>
            <circle cx="50" cy="45" r="8" fill="#4CC9F0" opacity="0.6"/>
            <circle cx="40" cy="55" r="5" fill="#4CC9F0" opacity="0.4"/>
        </svg>
    </div>
    <h1 style="font-size: 3rem; margin: 0;">MISSION MASTERY PRO</h1>
    <p style="color: #e2e8f0; font-size: 1.2rem; max-width: 500px; margin-bottom: 40px;">Become the ultimate Junior Scientist. Observe, measure, and predict your way through the Grand Science Lab!</p>
    <button class="btn btn-large" onclick="startGame()">START MISSION</button>
</div>

<div id="game-over-screen" class="full-screen-overlay">
    <h1 style="font-size: 3.5rem; color: #4CC9F0; margin: 0;">MISSION COMPLETE!</h1>
    <div style="font-size: 1.5rem; margin: 20px 0 40px 0;">
        You scored: <span id="final-score" style="color: #F72585; font-size: 3rem; font-weight: 600;">0</span> Points
    </div>
    <button class="btn btn-large" onclick="location.reload()">PLAY AGAIN</button>
</div>

<div id="game-container">
    <div id="game-header">
        <div class="mission-title" id="phase-label" style="color: var(--primary)">Mission 1: Observing</div>
        <div class="progress-container"><div id="progress-bar"></div></div>
        <div id="score-display" style="font-size: 1.2rem; font-weight: 600;">Points: 0</div>
    </div>

    <div id="game-viewport">
        
        <div id="phase-1" class="phase-panel active">
            <h2>Discovery Under the Lens</h2>
            <p>Details are hidden! Move your Pro-Lens over the leaf and click circles to log observations.</p>
            
            <div id="observation-container">
                <div id="normal-svg-host" style="width:100%; height:100%;"></div>
                
                <div id="hotspot-0" class="hotspot" style="left: 140px; top: 160px;" onclick="logDetail(0)"></div>
                <div id="hotspot-1" class="hotspot" style="left: 400px; top: 120px;" onclick="logDetail(1)"></div>
                <div id="hotspot-2" class="hotspot" style="left: 330px; top: 280px;" onclick="logDetail(2)"></div>

                <div id="magnifier">
                    <div id="magnifier-zoom-content" style="position: absolute;"></div>
                </div>
            </div>

            <div id="p1-log-entries" style="display:flex; gap:10px; margin-top:20px;"></div>
        </div>

        <div id="phase-2" class="phase-panel">
            <h2>Precision Laboratory</h2>
            <p>1. Drag Dish to scale. 2. Log mass. 3. Drag Specimen into dish. 4. Log total.</p>
            
            <div class="measurement-lab">
                <div style="display:flex; flex-direction:column; gap:20px;">
                    <div id="dish-tool" class="draggable-tool" draggable="true" ondragstart="drag(event)">
                        <svg width="100" height="60" viewBox="0 0 100 60"><path d="M5 20 L95 20 L85 55 L15 55 Z" fill="#e2e8f0" stroke="#94a3b8" stroke-width="2"/></svg>
                        <p style="text-align:center; font-weight:600; font-size:0.9rem; margin:0;">Petri Dish</p>
                    </div>
                    <div id="specimen-tool" class="draggable-tool" draggable="true" ondragstart="drag(event)" style="visibility:hidden;">
                        <svg width="100" height="60" viewBox="0 0 100 60"><circle cx="50" cy="30" r="22" fill="#F72585"/><path d="M40 20 Q50 5 60 20" stroke="white" stroke-width="2" fill="none"/></svg>
                        <p style="text-align:center; font-weight:600; font-size:0.9rem; margin:0;">Specimen</p>
                    </div>
                </div>

                <div class="digital-scale-v2" ondrop="dropScale(event)" ondragover="allowDrop(event)">
                    <div id="scale-plate"></div>
                    <div id="scale-content-svg" style="position:absolute; top:-40px; pointer-events:none;"></div>
                    <div id="scale-reading">0.0g</div>
                </div>

                <div style="background:rgba(241, 245, 249, 0.8); padding:20px; border-radius:20px; width:200px; border:1px solid #cbd5e1;">
                    <button class="btn" id="record-dish-btn" onclick="recordMass('dish')" disabled style="width:100%;">Log Dish</button>
                    <div id="dish-log-val" style="font-weight:600; text-align:center; margin:10px 0; color:var(--primary);">---</div>
                    <button class="btn" id="record-total-btn" onclick="recordMass('total')" disabled style="width:100%;">Log Total</button>
                    <div id="total-log-val" style="font-weight:600; text-align:center; margin:10px 0; color:var(--primary);">---</div>
                </div>
            </div>
            
            <div id="p2-quiz" style="margin-top:20px; display:none; background:#ecfdf5; padding:20px; border-radius:20px; width:100%; border:1px solid #10b981;">
                <h3 style="text-align:center; margin-top:0;">Specimen Mass Calculation:</h3>
                <div id="p2-options" style="display:flex; justify-content:center; gap:20px;"></div>
            </div>
        </div>

        <div id="phase-3" class="phase-panel">
            <h2>Biological Classification</h2>
            <p>Sort creatures into breathing groups based on their organs!</p>
            <div id="animal-bank" style="display:flex; flex-wrap:wrap; gap:15px; margin-bottom:20px; justify-content:center;"></div>
            <div style="display:flex; gap:30px; width:100%;">
                <div id="zone-gills" class="drop-zone" ondrop="dropClassify(event)" ondragover="allowDrop(event)">
                    <h3 style="color:#0ea5e9; width:100%; text-align:center;">GILLS (Water)</h3>
                    <svg width="40" height="40" style="position:absolute; bottom:10px; right:10px; opacity:0.1" viewBox="0 0 100 100"><path d="M10 50 Q30 30 50 50 T90 50" stroke="black" fill="none" stroke-width="5"/></svg>
                </div>
                <div id="zone-lungs" class="drop-zone" ondrop="dropClassify(event)" ondragover="allowDrop(event)">
                    <h3 style="color:#f43f5e; width:100%; text-align:center;">LUNGS (Air)</h3>
                    <svg width="40" height="40" style="position:absolute; bottom:10px; right:10px; opacity:0.1" viewBox="0 0 100 100"><circle cx="50" cy="50" r="30" stroke="black" fill="none" stroke-width="5"/></svg>
                </div>
            </div>
        </div>

        <div id="phase-4" class="phase-panel">
            <h2>Prediction Lab</h2>
            <div id="p4-monitor">
                <div id="p4-svg-container"></div>
            </div>
            <h3 id="p4-question-text" style="margin-bottom:20px; font-size:1.1rem; text-align:center;"></h3>
            <div id="p4-choices" style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; width:100%;"></div>
        </div>

    </div>
</div>

<div id="feedback">
    <h2 id="feedback-title">Awesome!</h2>
    <p id="feedback-msg"></p>
    <button class="btn" id="next-btn" onclick="closeFeedback()">Next Step</button>
</div>

<div id="error-toast">Try again!</div>

<script>
    let currentPhase = 1;
    let score = 0;
    let itemsFound = [];
    let p4Questions = [];
    let p4CurrentIndex = 0;

    // --- SOUND ENGINE ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playSound(type) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        const now = audioCtx.currentTime;

        if (type === 'success') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(400, now);
            osc.frequency.exponentialRampToValueAtTime(800, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.2);
            osc.start(); osc.stop(now + 0.2);
        } else if (type === 'error') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(150, now);
            osc.frequency.linearRampToValueAtTime(50, now + 0.2);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.3);
            osc.start(); osc.stop(now + 0.3);
        } else if (type === 'clink') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(1000, now);
            gain.gain.setValueAtTime(0.05, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
            osc.start(); osc.stop(now + 0.1);
        } else if (type === 'win') {
            [523.25, 659.25, 783.99].forEach((f, i) => {
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.connect(g); g.connect(audioCtx.destination);
                o.frequency.setValueAtTime(f, now + (i * 0.1));
                g.gain.setValueAtTime(0.1, now + (i * 0.1));
                g.gain.linearRampToValueAtTime(0, now + (i * 0.1) + 0.3);
                o.start(now + (i * 0.1)); o.stop(now + (i * 0.1) + 0.3);
            });
        }
    }

    // --- CUSTOM UI ALERTS ---
    function showError(msg) {
        playSound('error');
        const toast = document.getElementById('error-toast');
        toast.innerText = msg;
        toast.classList.add('active');
        setTimeout(() => toast.classList.remove('active'), 2500);
    }

    const leafHotspots = [
        { text: "Insect damage detected" },
        { text: "Detailed vein system" },
        { text: "Surface fungal spores" }
    ];

    const animalData = [
        {n: "Clownfish", t: "gills", svg: '<path d="M10 30 Q30 10 60 30 T90 30" stroke="#fb923c" stroke-width="8" fill="none"/><circle cx="25" cy="25" r="3" fill="black"/>'},
        {n: "Crab", t: "gills", svg: '<rect x="25" y="30" width="50" height="30" rx="15" fill="#ef4444"/><path d="M20 30 L10 20 M80 30 L90 20" stroke="#ef4444" stroke-width="5"/>'},
        {n: "Elephant", t: "lungs", svg: '<circle cx="50" cy="40" r="25" fill="#94a3b8"/><path d="M30 40 Q20 40 20 60" stroke="#94a3b8" stroke-width="10" fill="none"/>'},
        {n: "Dolphin", t: "lungs", svg: '<path d="M10 50 Q40 10 90 50" stroke="#38bdf8" stroke-width="8" fill="none"/>'},
        {n: "Tadpole", t: "gills", svg: '<circle cx="30" cy="30" r="15" fill="#334155"/><path d="M45 30 Q70 30 90 50" stroke="#334155" stroke-width="5" fill="none"/>'},
        {n: "Human", t: "lungs", svg: '<circle cx="50" cy="25" r="12" fill="#fdba74"/><rect x="40" y="37" width="20" height="20" rx="5" fill="#3b82f6"/>'}
    ];

    const scenarios = [
        {
            text: "A plant is locked in a dark room. Predict the outcome.",
            svg: `<svg width="400" height="250" viewBox="0 0 400 250">
                    <rect x="0" y="0" width="400" height="180" fill="#87CEEB"/>
                    <rect x="0" y="180" width="400" height="70" fill="#4CAF50"/>
                    <circle cx="340" cy="45" r="30" fill="#FFD700"/> <rect x="50" y="70" width="160" height="140" fill="#2d3436" rx="5"/>
                    
                    <rect x="110" y="170" width="40" height="15" fill="#713f12" rx="2"/> <rect x="127" y="140" width="6" height="30" fill="#22c55e"/> <circle cx="130" cy="130" r="12" fill="#F72585"/> <text x="130" y="200" fill="white" font-size="12" text-anchor="middle">No Sunlight Zone</text>
                  </svg>`,
            choices: ["Grows faster", "Turns yellow and wilts", "Flowers immediately", "Turns blue"],
            ans: 1
        },
        {
            text: "Two magnets with SAME poles meet. What happens?",
            svg: `<svg width="300" height="220" viewBox="0 0 300 220">
                    <rect x="30" y="90" width="100" height="40" rx="5" fill="#ef4444"/>
                    <rect x="30" y="90" width="30" height="40" rx="5" fill="#3b82f6"/>
                    <text x="110" y="115" fill="white" font-weight="bold">N</text>
                    <rect x="170" y="90" width="100" height="40" rx="5" fill="#ef4444"/>
                    <rect x="240" y="90" width="30" height="40" rx="5" fill="#3b82f6"/>
                    <text x="180" y="115" fill="white" font-weight="bold">N</text>
                    <path d="M140 100 Q150 90 160 100 M140 110 Q150 120 160 110" stroke="#4CC9F0" fill="none" stroke-width="3" opacity="0.8"/>
                    <path d="M130 105 L115 105 M170 105 L185 105" stroke="white" stroke-width="2" stroke-linecap="round"/>
                  </svg>`,
            choices: ["Stick together", "Repel (push away)", "Explode", "Melt"],
            ans: 1
        },
        {
            text: "Ice cubes left under a blazing sun.",
            svg: `<svg width="300" height="220" viewBox="0 0 300 220">
                    <circle cx="250" cy="45" r="30" fill="#FFD700"/>
                    <path d="M250 5 L250 15 M290 45 L280 45 M250 85 L250 75 M210 45 L220 45" stroke="#fbbf24" stroke-width="4"/>
                    
                    <rect x="0" y="180" width="300" height="40" fill="#d1d5db"/>
                    <path d="M110 80 L190 80 L175 180 L125 180 Z" fill="#ffffff" opacity="0.5" stroke="#cbd5e1"/>
                    
                    <rect x="130" y="145" width="25" height="25" rx="4" fill="#7dd3fc"/>
                    <rect x="145" y="155" width="25" height="25" rx="4" fill="#e0f2fe"/>
                  </svg>`,
            choices: ["Melts into liquid", "Turns into ice cream", "Freezes harder", "Disappears"],
            ans: 0
        }
    ];

    function startGame() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        playSound('success');
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('game-container').style.display = 'flex';
        initPhase(1);
    }

    function endGame() {
        playSound('win');
        document.getElementById('game-container').style.display = 'none';
        document.getElementById('final-score').innerText = score;
        document.getElementById('game-over-screen').style.display = 'flex';
    }

    function updateProgress() {
        const percent = (currentPhase / 4) * 100;
        document.getElementById('progress-bar').style.width = percent + '%';
        document.getElementById('score-display').innerText = `Points: ${score}`;
    }

    function showFeedback(title, msg) {
        playSound('win');
        document.getElementById('feedback-title').innerText = title;
        document.getElementById('feedback-msg').innerText = msg;
        document.getElementById('feedback').classList.add('show');
    }

    function closeFeedback() {
        playSound('clink');
        document.getElementById('feedback').classList.remove('show');
        
        if (currentPhase === 4 && p4CurrentIndex === p4Questions.length - 1) {
            endGame();
            return;
        }

        if (currentPhase === 4 && p4CurrentIndex < p4Questions.length - 1) {
            p4CurrentIndex++;
            renderP4Question();
            return;
        }
        if (currentPhase < 4) {
            document.getElementById(`phase-${currentPhase}`).classList.remove('active');
            currentPhase++;
            document.getElementById(`phase-${currentPhase}`).classList.add('active');
            document.getElementById('phase-label').innerText = `Mission ${currentPhase}: ${getPhaseName(currentPhase)}`;
            initPhase(currentPhase);
        }
        updateProgress();
    }

    function getPhaseName(p) { return ["", "Observing", "Measuring", "Classifying", "Predicting"][p]; }

    function initPhase1() {
        const baseLeafSVG = `<svg viewBox="0 0 500 400" width="100%" height="100%">
            <defs>
                <linearGradient id="leafGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#4ade80"/><stop offset="100%" style="stop-color:#166534"/>
                </linearGradient>
            </defs>
            <path d="M250 40 C400 40 460 150 460 250 C460 380 350 380 250 380 C150 380 40 380 40 250 C40 150 100 40 250 40" fill="url(#leafGrad)" stroke="#064e3b" stroke-width="3"/>
            <path d="M250 40 L250 380" stroke="#064e3b" stroke-width="2" opacity="0.4"/>
            <path d="M250 120 L380 80 M250 220 L420 180 M250 320 L380 360" stroke="#064e3b" stroke-width="1.5" opacity="0.3"/>
            <path d="M250 120 L120 80 M250 220 L80 180 M250 320 L120 360" stroke="#064e3b" stroke-width="1.5" opacity="0.3"/>
        </svg>`;

        const detailedLeafSVG = `<svg viewBox="0 0 500 400" width="100%" height="100%">
            <defs>
                <linearGradient id="leafGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#4ade80"/><stop offset="100%" style="stop-color:#166534"/>
                </linearGradient>
            </defs>
            <path d="M250 40 C400 40 460 150 460 250 C460 380 350 380 250 380 C150 380 40 380 40 250 C40 150 100 40 250 40" fill="url(#leafGrad)" stroke="#064e3b" stroke-width="3"/>
            <path d="M250 40 L250 380" stroke="#064e3b" stroke-width="2" opacity="0.4"/>
            <path d="M250 120 L380 80 M250 220 L420 180 M250 320 L380 360" stroke="#064e3b" stroke-width="1.5" opacity="0.3"/>
            <path d="M250 120 L120 80 M250 220 L80 180 M250 320 L120 360" stroke="#064e3b" stroke-width="1.5" opacity="0.3"/>

            <g id="detail-0"> <circle cx="140" cy="160" r="10" fill="#3f2e1b" opacity="0.7"/> </g>
            <g id="detail-1"> <path d="M385 110 L415 130 M385 130 L415 110" stroke="#064e3b" stroke-width="2" opacity="0.8"/> </g>
            <g id="detail-2"> <circle cx="330" cy="280" r="4" fill="#fbbf24"/><circle cx="338" cy="275" r="3" fill="#fbbf24"/> </g>
        </svg>`;
        
        document.getElementById('normal-svg-host').innerHTML = baseLeafSVG;
        document.getElementById('magnifier-zoom-content').innerHTML = detailedLeafSVG;

        const container = document.getElementById('observation-container');
        const glass = document.getElementById('magnifier');
        const zoom = document.getElementById('magnifier-zoom-content');
        zoom.style.width = '1000px'; zoom.style.height = '800px';

        container.onmousemove = (e) => {
            const rect = container.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            glass.style.display = 'block';
            glass.style.left = (x - 80) + 'px';
            glass.style.top = (y - 80) + 'px';
            zoom.style.left = (-x * 2 + 80) + 'px';
            zoom.style.top = (-y * 2 + 80) + 'px';

            [0,1,2].forEach(i => {
                const h = document.getElementById(`hotspot-${i}`);
                const hX = parseInt(h.style.left);
                const hY = parseInt(h.style.top);
                const dist = Math.sqrt((x-hX)**2 + (y-hY)**2);
                h.style.display = (dist < 60 && !itemsFound.includes(i)) ? 'block' : 'none';
            });
        };
        container.onmouseleave = () => glass.style.display = 'none';
    }

    function logDetail(idx) {
        playSound('success');
        itemsFound.push(idx);
        const log = document.createElement('div');
        log.style = "background:rgba(255,255,255,0.8); padding:8px 15px; border-radius:10px; border:1px solid #cbd5e1; font-weight:500; font-size:0.9rem;";
        log.innerText = leafHotspots[idx].text;
        document.getElementById('p1-log-entries').appendChild(log);
        score += 20; updateProgress();
        if(itemsFound.length === 3) showFeedback("Observation Complete", "All details logged.");
    }

    let dishOnScale = false;
    let specInDish = false;
    let loggedDish = 0;
    
    function drag(ev) { 
        ev.dataTransfer.setData("text", ev.target.id); 
    }
    function allowDrop(ev) { ev.preventDefault(); }
    
    function dropScale(ev) {
        ev.preventDefault();
        const id = ev.dataTransfer.getData("text");
        const reading = document.getElementById('scale-reading');
        const scaleContent = document.getElementById('scale-content-svg');

        if (id === 'dish-tool' && !dishOnScale) {
            playSound('clink');
            dishOnScale = true;
            document.getElementById('dish-tool').style.visibility = 'hidden';
            scaleContent.innerHTML = `<svg width="140" height="80"><path d="M10 40 L130 40 L120 75 L20 75 Z" fill="#f8fafc" stroke="#94a3b8" stroke-width="2"/></svg>`;
            reading.innerText = "25.0g";
            document.getElementById('record-dish-btn').disabled = false;
        } else if (id === 'specimen-tool' && dishOnScale && !specInDish) {
            playSound('clink');
            specInDish = true;
            document.getElementById('specimen-tool').style.visibility = 'hidden';
            scaleContent.innerHTML += `<svg width="140" height="80" style="position:absolute; top:0; left:0;"><circle cx="70" cy="58" r="18" fill="#F72585"/></svg>`;
            reading.innerText = "62.0g";
            document.getElementById('record-total-btn').disabled = false;
        }
    }

    function recordMass(type) {
        playSound('success');
        if (type === 'dish') {
            loggedDish = 25;
            document.getElementById('dish-log-val').innerText = "25.0g";
            document.getElementById('specimen-tool').style.visibility = 'visible';
            document.getElementById('record-dish-btn').disabled = true;
        } else {
            document.getElementById('total-log-val').innerText = "62.0g";
            document.getElementById('record-total-btn').disabled = true;
            showP2Quiz();
        }
    }

    function showP2Quiz() {
        const q = document.getElementById('p2-quiz');
        q.style.display = 'block';
        const opts = document.getElementById('p2-options');
        opts.innerHTML = '';
        [37, 42, 25].forEach(m => {
            const b = document.createElement('button');
            b.className = 'btn'; b.innerText = m + ".0g";
            b.onclick = () => {
                if(m === 37) { 
                    score += 30; 
                    showFeedback("Accurate Calculation", "62g minus 25g equals 37g."); 
                }
                else showError("Check your math again!");
            };
            opts.appendChild(b);
        });
    }

    function initPhase3() {
        const bank = document.getElementById('animal-bank');
        bank.innerHTML = '';
        animalData.sort(() => Math.random()-0.5).forEach(a => {
            const d = document.createElement('div');
            d.className = 'animal-card'; d.draggable = true; d.id = `a-${a.n}-${a.t}`;
            d.innerHTML = `<svg width="60" height="40" viewBox="0 0 100 60">${a.svg}</svg><span style="font-size:0.85rem">${a.n}</span>`;
            d.ondragstart = drag;
            bank.appendChild(d);
        });
    }

    function dropClassify(ev) {
        ev.preventDefault();
        const data = ev.dataTransfer.getData("text");
        const type = data.split('-')[2];
        const zone = ev.currentTarget.id.split('-')[1];
        if (type === zone) {
            playSound('success');
            ev.currentTarget.appendChild(document.getElementById(data));
            score += 15; updateProgress();
            if(document.getElementById('animal-bank').children.length === 0) showFeedback("Taxonomist", "Classification sorted.");
        } else {
            showError("Review habitat and organs!");
        }
    }

    function initPhase4() {
        p4Questions = [...scenarios].sort(() => Math.random() - 0.5);
        p4CurrentIndex = 0;
        renderP4Question();
    }

    function renderP4Question() {
        const q = p4Questions[p4CurrentIndex];
        document.getElementById('p4-question-text').innerText = q.text;
        document.getElementById('p4-svg-container').innerHTML = q.svg;
        const choices = document.getElementById('p4-choices');
        choices.innerHTML = '';
        q.choices.forEach((c, idx) => {
            const b = document.createElement('button');
            b.className = 'btn'; b.innerText = c;
            b.onclick = () => {
                if(idx === q.ans) {
                    score += 25;
                    showFeedback("Prediction Successful", p4CurrentIndex === p4Questions.length-1 ? "Final mission complete." : "Analysis correct.");
                } else {
                    showError("Review the scientific evidence!");
                }
            };
            choices.appendChild(b);
        });
    }

    function initPhase(p) {
        if(p === 1) initPhase1();
        if(p === 3) initPhase3();
        if(p === 4) initPhase4();
    }

    updateProgress();
</script>
</body>
</html>