<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lexicon Valley: Survival Garden</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        /* Import Fredoka (Bubbly) and Patrick Hand (Notes) */
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&family=Patrick+Hand&display=swap');

        /* --- 1. CORE STYLES --- */
        body {
            font-family: 'Fredoka', sans-serif;
            overflow: hidden; /* Prevent scrolling */
            background: linear-gradient(to bottom, #87CEEB 0%, #E0F6FF 50%, #90EE90 100%);
            touch-action: manipulation;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 3px solid rgba(255, 255, 255, 1);
            box-shadow: 0 10px 40px -10px rgba(31, 38, 135, 0.2);
        }

        /* --- 2. ANIMATIONS & FONTS --- */
        
        /* Bubbly Font for Scrambled Word */
        .scrambled-text {
            font-family: 'Fredoka', sans-serif;
            font-weight: 700; /* Bold makes it bubblier */
            letter-spacing: 0.1em;
            color: #475569;
        }

        /* Handwritten Definition */
        .def-text {
            font-family: 'Patrick Hand', cursive;
            font-size: 1.25rem;
        }

        /* Floating points animation */
        .float-anim { animation: floatUp 0.8s ease-out forwards; pointer-events: none; }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-40px) scale(1.2); opacity: 0; }
        }

        /* Flower Sway */
        .flower-sway { transform-origin: bottom center; animation: sway 3s ease-in-out infinite alternate; }
        @keyframes sway { from { transform: rotate(-3deg); } to { transform: rotate(3deg); } }

        /* Clouds */
        .cloud { position: absolute; opacity: 0.8; animation: floatCloud linear infinite; pointer-events: none; }
        @keyframes floatCloud { from { transform: translateX(-200px); } to { transform: translateX(100vw); } }

        /* Shake Effect */
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-3px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-5px, 0, 0); }
            40%, 60% { transform: translate3d(5px, 0, 0); }
        }

        /* Timer Bar */
        .timer-bar-bg { width: 100%; height: 10px; background: rgba(0,0,0,0.1); border-radius: 99px; overflow: hidden; margin-top: 8px;}
        .timer-bar-fill { height: 100%; background: #ec4899; width: 100%; transition: width 0.1s linear, background-color 0.3s; }
        
        /* Dialogue Box Style for Start/Game Over */
        .dialogue-box {
            background: white;
            border-radius: 2rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border: 4px solid #fce7f3; /* Light pink border */
            max-width: 90%;
            width: 400px;
        }
    </style>
</head>
<body class="h-screen w-screen relative flex flex-col items-center justify-start pt-6">

    <div id="sky-layer" class="absolute inset-0 z-0 pointer-events-none"></div>

    <div class="z-50 w-full max-w-xl px-4 mb-2">
        <div class="flex justify-between items-center glass-panel rounded-full px-6 py-3">
            <div class="text-center leading-none">
                <div class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Level</div>
                <div id="level-display" class="text-xl font-bold text-slate-700">1</div>
            </div>
            
            <div class="flex-grow mx-6 text-center">
                <div class="flex justify-between items-end mb-1 px-1">
                    <span class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Time</span>
                    <span class="text-lg font-bold text-pink-500 leading-none tabular-nums" id="timer-text">20s</span>
                </div>
                <div class="timer-bar-bg"><div id="timer-bar" class="timer-bar-fill"></div></div>
            </div>

            <button id="pause-btn" class="p-2 rounded-full hover:bg-slate-100 transition text-slate-400 hover:text-slate-600">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <rect x="6" y="4" width="4" height="16" rx="1" />
                    <rect x="14" y="4" width="4" height="16" rx="1" />
                </svg>
            </button>
        </div>

        <div class="absolute -bottom-10 right-8 bg-white shadow-md rounded-full px-4 py-1 text-sm font-bold text-green-600 border border-green-100 transform rotate-2">
            Score: <span id="score-display">0</span>
        </div>
    </div>

    <div id="game-card" class="z-40 w-full max-w-2xl px-4 mt-8 transition-all duration-300 transform">
        <div class="glass-panel rounded-[2rem] p-5 text-center relative">
            
            <div id="api-loader" class="absolute top-4 right-4 text-pink-400 animate-spin hidden">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                    <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                </svg>
            </div>

            <div id="hint-display" class="h-6 text-lg font-bold text-blue-500 mb-1 tracking-wide font-mono"></div>

            <div id="scrambled-word" class="scrambled-text text-5xl md:text-6xl mb-2 drop-shadow-sm min-h-[60px] select-none">???</div>
            
            <div class="bg-white/50 rounded-xl p-3 mb-4 inline-block w-full border border-white">
                <p id="definition-text" class="def-text text-slate-700 leading-snug">
                    Welcome to Lexicon Valley.
                </p>
            </div>
            
            <div class="relative w-full mb-4">
                <input type="text" id="word-input" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false"
                    class="w-full text-center text-3xl p-3 rounded-2xl border-4 border-transparent focus:border-pink-300 focus:bg-white focus:outline-none bg-white/60 text-slate-700 placeholder-slate-400 uppercase shadow-inner transition-all"
                    placeholder="TYPE HERE" disabled>
            </div>

            <div id="game-controls" class="flex gap-3 opacity-50 pointer-events-none transition-opacity">
                <button onclick="useHint()" class="flex-1 bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-3 rounded-xl shadow-[0_4px_0_rgb(202,138,4)] active:shadow-none active:translate-y-[4px] transition-all text-sm uppercase tracking-wide">
                    ðŸ’¡ Hint (-3s)
                </button>
                <button onclick="autoSolve()" class="flex-1 bg-slate-400 hover:bg-slate-500 text-white font-bold py-3 rounded-xl shadow-[0_4px_0_rgb(71,85,105)] active:shadow-none active:translate-y-[4px] transition-all text-sm uppercase tracking-wide">
                    âš¡ Skip (0pts)
                </button>
            </div>
        </div>
    </div>

    <div id="garden-container" class="absolute bottom-0 w-full h-48 z-10 flex items-end justify-center px-4 pointer-events-none">
        </div>
    <div class="absolute bottom-0 w-full h-16 bg-gradient-to-t from-green-600 to-green-400 z-20"></div>

    <div id="start-overlay" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-black/20 backdrop-blur-sm p-4">
        <div class="dialogue-box p-8 text-center flex flex-col items-center animate-bounce-in">
            <h1 class="text-4xl font-bold text-pink-500 mb-2">Lexicon Valley</h1>
            <div class="w-16 h-1 bg-green-400 rounded-full mb-4"></div>
            <p class="text-slate-600 mb-8 font-medium text-lg">Unscramble words to grow your garden before time runs out!</p>
            
            <button id="start-btn" class="w-full bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white font-bold py-4 rounded-xl shadow-lg transform transition hover:scale-[1.02] active:scale-95 text-xl">
                ðŸŒ± Start Game
            </button>
        </div>
    </div>

    <div id="pause-overlay" class="hidden absolute inset-0 z-50 flex flex-col items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4">
        <div class="dialogue-box p-8 text-center">
            <h2 class="text-3xl font-bold text-slate-700 mb-6">Game Paused</h2>
            <button id="resume-btn" class="w-full bg-blue-500 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:bg-blue-600 active:scale-95 text-lg">Resume</button>
        </div>
    </div>

    <div id="game-over-overlay" class="hidden absolute inset-0 z-50 flex flex-col items-center justify-center bg-red-900/60 backdrop-blur-md p-4">
        <div class="dialogue-box p-8 text-center shadow-2xl border-red-100">
            <h2 class="text-4xl font-bold text-slate-800 mb-2">Time's Up!</h2>
            <p class="text-slate-500 mb-6">Your garden is beautiful.</p>
            
            <div class="bg-slate-100 rounded-xl p-4 mb-8">
                <div class="flex justify-between border-b border-slate-200 pb-2 mb-2">
                    <span class="text-slate-600">Final Score</span>
                    <span id="final-score" class="font-bold text-2xl text-pink-600">0</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-slate-600">Flowers Grown</span>
                    <span id="final-flowers" class="font-bold text-2xl text-green-600">0</span>
                </div>
            </div>
            
            <button onclick="location.reload()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-xl shadow-xl text-lg transform active:scale-95 transition">
                Play Again â†º
            </button>
        </div>
    </div>

    <script>
        // --- 1. CONFIG & STATE ---
        const FALLBACK_WORDS = [
            { word: "CAT", def: "A small domesticated carnivorous mammal." },
            { word: "DOG", def: "A domesticated carnivorous mammal." },
            { word: "SUN", def: "The star around which the earth orbits." },
            { word: "TREE", def: "A woody perennial plant." },
            { word: "BLUE", def: "A color intermediate between green and violet." },
            { word: "MOON", def: "The natural satellite of the earth." },
            { word: "FISH", def: "A limbless cold-blooded vertebrate animal with gills." },
            { word: "BIRD", def: "A warm-blooded egg-laying vertebrate distinguished by the possession of feathers." }
        ];

        let state = {
            isPlaying: false,
            isPaused: false,
            isGameOver: false,
            score: 0,
            level: 1,
            timeLeft: 20,
            maxTime: 20,
            flowers: 0,
            wordBuffer: [...FALLBACK_WORDS],
            currentWord: null,
            hintIndex: 0 
        };

        const DOM = {
            input: document.getElementById('word-input'),
            scrambled: document.getElementById('scrambled-word'),
            def: document.getElementById('definition-text'),
            timerText: document.getElementById('timer-text'),
            timerBar: document.getElementById('timer-bar'),
            score: document.getElementById('score-display'),
            level: document.getElementById('level-display'),
            hint: document.getElementById('hint-display'),
            loader: document.getElementById('api-loader'),
            garden: document.getElementById('garden-container'),
            controls: document.getElementById('game-controls'),
            
            startScreen: document.getElementById('start-overlay'),
            pauseScreen: document.getElementById('pause-overlay'),
            gameOverScreen: document.getElementById('game-over-overlay'),
            finalScore: document.getElementById('final-score'),
            finalFlowers: document.getElementById('final-flowers')
        };

        // --- 2. AUDIO SYSTEM ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'correct') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(500, now);
                osc.frequency.exponentialRampToValueAtTime(1000, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'hint') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(600, now);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'error') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.2);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            }
        }

        // --- 3. LIVE WORD API ---
        async function fetchWords() {
            if (state.wordBuffer.length > 5) return;
            DOM.loader.style.display = 'block';
            
            // DIFFICULTY SETTINGS
            // Levels 1-2: Max length 4
            // Levels 3-5: Max length 5
            // Levels 6+: Max length 7
            const maxLen = state.level < 3 ? 4 : (state.level < 6 ? 5 : 7);
            const minLen = 3;

            try {
                const randomChar = String.fromCharCode(97 + Math.floor(Math.random() * 26));
                const response = await fetch(`https://api.datamuse.com/words?sp=${randomChar}*&md=d&max=20`); // Get more to filter
                const data = await response.json();
                
                // UPDATED: Added filter to block 'XXX' or bad words
                const cleanWords = data
                    .filter(item => {
                        return item.defs && 
                               item.defs.length > 0 && 
                               item.word.length >= minLen && 
                               item.word.length <= maxLen && 
                               /^[a-zA-Z]+$/.test(item.word) &&
                               !['XXX', 'SEX', 'PORN'].includes(item.word.toUpperCase()); // SAFETY FILTER
                    })
                    .map(item => {
                        let def = item.defs[0].replace(/^.\t/, ''); 
                        return { word: item.word.toUpperCase(), def: def };
                    });

                if (cleanWords.length > 0) {
                    state.wordBuffer.push(...cleanWords);
                }
            } catch (e) {
                console.log("API Error, using fallback");
            } finally {
                DOM.loader.style.display = 'none';
            }
        }

        // --- 4. FLOWER GENERATOR (TALLER!) ---
        function getPlantSVG() {
            const colors = ['#FF69B4', '#FFA500', '#9370DB', '#FF6347', '#40E0D0', '#F08080'];
            const petalColor = colors[Math.floor(Math.random() * colors.length)];
            const numPetals = 5 + Math.floor(Math.random() * 3);
            
            let petals = `<g transform="translate(50,60)">`;
            for (let i = 0; i < numPetals; i++) {
                const angle = (360 / numPetals) * i;
                petals += `<ellipse cx="0" cy="-20" rx="10" ry="25" fill="${petalColor}" transform="rotate(${angle})" />`;
            }
            petals += `<circle r="12" fill="#FFFACD" /></g>`;

            return `<svg width="100" height="280" viewBox="0 0 100 280" class="flower-sway" style="margin-left:-25px; filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.15));">
                <path d="M50,250 Q50,200 ${45 + Math.random()*10},60" stroke="#228B22" stroke-width="5" fill="none" />
                
                <path d="M50,180 Q20,160 20,180 T50,180" fill="#32CD32" />
                <path d="M50,140 Q80,120 80,140 T50,140" fill="#32CD32" />
                
                ${petals}
            </svg>`;
        }

        // --- 5. GAME LOGIC ---
        
        function shuffleText(word) {
            let arr = word.split('');
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            if (arr.join('') === word && word.length > 1) return shuffleText(word);
            return arr.join('');
        }

        function nextWord() {
            if (state.wordBuffer.length === 0) {
                state.wordBuffer = [...FALLBACK_WORDS];
            }
            state.currentWord = state.wordBuffer.shift();
            state.hintIndex = 0; 
            
            DOM.scrambled.innerText = shuffleText(state.currentWord.word);
            DOM.def.innerText = state.currentWord.def;
            DOM.input.value = '';
            DOM.hint.innerText = '';
            DOM.input.focus();

            fetchWords();
        }

        function adjustTime(amount) {
            state.timeLeft += amount;
            if(state.timeLeft > 40) state.timeLeft = 40;
            updateTimerUI();
            
            const color = amount > 0 ? '#22c55e' : '#ef4444';
            const rect = DOM.timerText.getBoundingClientRect();
            floatText(amount > 0 ? `+${amount}s` : `${amount}s`, color, rect.left, rect.top + 30);
        }

        function floatText(text, color, x, y) {
            const el = document.createElement('div');
            el.innerText = text;
            el.style.cssText = `position:fixed; left:${x}px; top:${y}px; color:${color}; font-weight:bold; font-size:1.5rem; z-index:100; font-family:'Fredoka';`;
            el.className = 'float-anim';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 900);
        }

        // --- BUTTON ACTIONS ---

        window.useHint = function() {
            if (state.timeLeft <= 3) return; 
            if (state.hintIndex >= state.currentWord.word.length) return; 

            adjustTime(-3); 
            playSound('hint');
            
            state.hintIndex++;
            const revealed = state.currentWord.word.substring(0, state.hintIndex);
            
            DOM.hint.innerText = `Hint: ${revealed}...`;
        };

        window.autoSolve = function() {
            DOM.input.value = state.currentWord.word;
            setTimeout(() => {
                state.flowers++;
                plantFlower();
                nextWord();
            }, 500);
        };

        function plantFlower() {
            const plant = document.createElement('div');
            plant.innerHTML = getPlantSVG();
            DOM.garden.appendChild(plant);
            if(DOM.garden.childElementCount > 10) {
                DOM.garden.removeChild(DOM.garden.firstChild);
            }
        }

        function handleCorrect() {
            playSound('correct');
            state.score += 10 + state.level;
            state.flowers++;
            DOM.score.innerText = state.score;
            
            adjustTime(10); 
            plantFlower();
            
            confetti({ particleCount: 40, spread: 60, origin: { y: 0.8 }, colors: ['#ff0000', '#00ff00', '#0000ff'] });

            if (state.flowers % 5 === 0) {
                state.level++;
                DOM.level.innerText = state.level;
                confetti({ particleCount: 100, spread: 100, origin: { y: 0.5 } });
            }

            DOM.input.classList.add('bg-green-100');
            setTimeout(() => DOM.input.classList.remove('bg-green-100'), 200);
            
            nextWord();
        }

        // --- GAME LOOP ---

        function updateTimerUI() {
            DOM.timerText.innerText = Math.ceil(state.timeLeft) + 's';
            let pct = (state.timeLeft / 40) * 100;
            if(pct > 100) pct = 100;
            DOM.timerBar.style.width = pct + '%';
            
            if (state.timeLeft <= 5) {
                DOM.timerBar.style.backgroundColor = '#ef4444';
                DOM.timerText.classList.add('text-red-500');
            } else {
                DOM.timerBar.style.backgroundColor = '#ec4899';
                DOM.timerText.classList.remove('text-red-500');
            }
        }

        function gameLoop() {
            if (!state.isPlaying || state.isPaused || state.isGameOver) return;
            state.timeLeft -= 0.1;
            if (state.timeLeft <= 0) {
                state.timeLeft = 0;
                gameOver();
            }
            updateTimerUI();
        }

        let loopInterval = null;

        function togglePause() {
            if (state.isGameOver || !state.isPlaying) return;
            state.isPaused = !state.isPaused;
            if (state.isPaused) {
                DOM.pauseScreen.classList.remove('hidden');
                DOM.input.disabled = true;
            } else {
                DOM.pauseScreen.classList.add('hidden');
                DOM.input.disabled = false;
                DOM.input.focus();
            }
        }

        function gameOver() {
            state.isGameOver = true;
            state.isPlaying = false;
            clearInterval(loopInterval);
            DOM.gameOverScreen.classList.remove('hidden');
            DOM.finalScore.innerText = state.score;
            DOM.finalFlowers.innerText = state.flowers;
        }

        // --- INIT & LISTENERS ---

        DOM.input.addEventListener('keydown', (e) => {
            if (state.isPaused) return;
            if (e.key === 'Enter') {
                const val = DOM.input.value.trim().toUpperCase();
                if (val === state.currentWord.word) {
                    handleCorrect();
                } else {
                    playSound('error');
                    DOM.input.parentElement.classList.add('shake');
                    setTimeout(() => DOM.input.parentElement.classList.remove('shake'), 500);
                }
            }
        });

        function startGame() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            state.isPlaying = true;
            state.timeLeft = 20;
            state.score = 0;
            state.level = 1;
            state.flowers = 0;
            state.isGameOver = false;
            
            DOM.startScreen.style.display = 'none';
            DOM.controls.classList.remove('opacity-50', 'pointer-events-none');
            DOM.input.disabled = false;
            DOM.garden.innerHTML = ''; // clear previous garden
            
            // Sky
            const sky = document.getElementById('sky-layer');
            sky.innerHTML = '';
            for(let i=0; i<6; i++) {
                const c = document.createElement('div');
                c.className = 'cloud';
                c.innerHTML = `<svg width="100" height="60" viewBox="0 0 100 60" fill="white"><path d="M25,50 a20,20 0 0,1 0,-40 a25,25 0 0,1 45,0 a20,20 0 0,1 0,40 z" /></svg>`;
                c.style.top = Math.random() * 50 + '%';
                c.style.left = Math.random() * 100 + '%';
                c.style.animationDuration = (30 + Math.random() * 30) + 's';
                sky.appendChild(c);
            }

            nextWord();
            loopInterval = setInterval(gameLoop, 100);
        }

        document.getElementById('start-btn').addEventListener('click', startGame);
        document.getElementById('pause-btn').addEventListener('click', togglePause);
        document.getElementById('resume-btn').addEventListener('click', togglePause);

    </script>
</body>
</html>