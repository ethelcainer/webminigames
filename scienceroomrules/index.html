<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Guardian: Science Room Rules</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/canvas-confetti/1.6.0/confetti.browser.min.js"></script>
    
    <style>
        :root {
            --bright-blue: #4cc9f0;
            --sunny-yellow: #ffd166;
            --vibrant-green: #06d6a0;
            --fun-pink: #ef476f;
            --cheerful-orange: #ff9f1c;
            --light-bg: #f0f8ff;
            --panel-bg: rgba(255, 255, 255, 0.95);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
        
        body { 
            font-family: 'Comic Neue', cursive; 
            background: var(--light-bg);
            color: #333; 
            overflow: hidden; 
            height: 100vh;
        }

        #world { position: relative; width: 100vw; height: 100vh; }

        /* --- UI & BOT --- */
        #hint-bot {
            position: fixed; bottom: 20px; left: 20px; width: 450px;
            z-index: 2000; display: flex; align-items: flex-end; gap: 15px; pointer-events: none;
        }

        .bot-avatar {
            width: 90px; height: 90px; flex-shrink: 0;
            background: white; border: 4px solid var(--bright-blue); border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); animation: bounceRobot 2s ease-in-out infinite;
        }

        .hint-bubble {
            background: var(--panel-bg); border: 4px solid var(--bright-blue);
            padding: 15px 25px; border-radius: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            pointer-events: auto; font-size: 1.1rem; transition: all 0.3s ease;
        }

        /* --- STAGES --- */
        .stage {
            position: absolute; inset: 0; display: none;
            flex-direction: column; align-items: center; justify-content: center; overflow: hidden;
        }
        .stage.active { display: flex; }

        .mission-header {
            position: absolute; top: 40px; left: 40px; z-index: 100;
            background: rgba(255,255,255,0.9); padding: 15px 30px; border-radius: 20px;
            border: 3px solid var(--sunny-yellow); box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        .mission-header h1 { font-family: 'Fredoka One', cursive; font-size: 1.5rem; color: var(--bright-blue); }

        .scenery-bg { position: absolute; inset: 0; z-index: 0; }

        /* --- DRAGGABLES --- */
        .drag-item {
            width: 80px; height: 110px; cursor: grab; position: absolute;
            z-index: 100; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
        }
        .drag-item:active { cursor: grabbing; scale: 1.1; }
        .hazard, .decoy { position: absolute; cursor: pointer; z-index: 100; }
        
        @keyframes redPulse {
            0% { filter: drop-shadow(0 0 2px rgba(255, 0, 0, 0.5)); }
            50% { filter: drop-shadow(0 0 15px rgba(255, 0, 0, 0.8)); }
            100% { filter: drop-shadow(0 0 2px rgba(255, 0, 0, 0.5)); }
        }
        .hazard-glow { animation: redPulse 1.5s infinite ease-in-out; }

        @keyframes waterFlow {
            0% { height: 0; opacity: 0; }
            50% { height: 100px; opacity: 0.8; }
            100% { height: 0; opacity: 0; }
        }
        .water-animation {
            width: 20px; background: #00f2ff; position: fixed;
            border-radius: 0 0 15px 15px; display: none; z-index: 50;
            box-shadow: 0 0 10px #00f2ff;
        }

        /* --- TRANSITIONS --- */
        #transition-overlay {
            position: fixed; inset: 0; background: white; z-index: 5000;
            display: flex; justify-content: center; align-items: center;
            transform: scaleX(0); transform-origin: left;
        }
        #transition-text { font-family: 'Fredoka One'; font-size: 3rem; color: var(--bright-blue); }

        #success-seal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            z-index: 4000; pointer-events: none;
        }

        .btn-action {
            background: var(--sunny-yellow); border: 4px solid var(--cheerful-orange);
            color: #333; padding: 15px 50px; font-family: 'Fredoka One', cursive;
            font-size: 1.5rem; border-radius: 30px; cursor: pointer;
            box-shadow: 0 8px 0 var(--cheerful-orange); transition: transform 0.1s;
        }
        .btn-action:active { transform: translateY(4px); box-shadow: 0 4px 0 var(--cheerful-orange); }

        @keyframes bounceRobot { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    </style>
</head>
<body>

    <div id="transition-overlay">
        <h1 id="transition-text">STARTING... ‚ú®</h1>
    </div>

    <div id="success-seal">
        <svg width="200" height="200" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="45" fill="var(--vibrant-green)" stroke="white" stroke-width="5"/>
            <path d="M30 50 L45 65 L70 35" fill="none" stroke="white" stroke-width="8" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </div>

    <div id="world">
        <div class="mission-header">
            <h1 id="mission-title">Science Lab Adventure</h1>
            <p id="mission-desc" style="font-weight: bold; color: #666; margin-top: 5px;">Academy Level: Standard 3</p>
        </div>

        <div class="stage active" id="stage-0" style="background: linear-gradient(to bottom, #87ceeb, #e0f7fa);">
            <div style="text-align: center;">
                <h2 style="font-family: 'Fredoka One'; font-size: 5.5rem; color: var(--bright-blue); -webkit-text-stroke: 2px white; text-shadow: 6px 6px 0px var(--sunny-yellow);">LAB GUARDIAN</h2>
                <p style="font-size: 1.5rem; margin-bottom: 40px; font-weight: bold; color: #444;">Keep the Science Room safe and clean!</p>
                <button class="btn-action" onclick="startProtocol()">START ADVENTURE</button>
            </div>
        </div>

        <div class="stage" id="stage-1">
            <svg class="scenery-bg" viewBox="0 0 1000 600" preserveAspectRatio="xMidYMid slice">
                <rect width="1000" height="600" fill="#fdfcdc"/>
                <rect y="400" width="1000" height="200" fill="#e9edc9"/>
                <line x1="0" y1="400" x2="1000" y2="400" stroke="#ccd5ae" stroke-width="5"/>
                <g transform="translate(50, 100)">
                    <rect width="200" height="300" fill="#a8dadc" stroke="#457b9d" stroke-width="3"/>
                    <line x1="100" y1="0" x2="100" y2="300" stroke="#457b9d" stroke-width="3"/>
                    <rect x="20" y="30" width="60" height="20" fill="#f1faee"/><circle cx="170" cy="150" r="10" fill="#1d3557"/>
                    <rect x="120" y="30" width="60" height="20" fill="#f1faee"/><circle cx="70" cy="150" r="10" fill="#1d3557"/>
                </g>
                <g transform="translate(750, 100)">
                    <rect width="200" height="180" fill="#d4a373" stroke="#bc6c25" stroke-width="4"/>
                    <rect x="20" y="20" width="160" height="140" fill="#fefae0"/>
                    <rect x="40" y="40" width="40" height="40" fill="#ffadad" transform="rotate(-5, 60, 60)"/>
                    <rect x="110" y="70" width="40" height="40" fill="#a0c4ff" transform="rotate(10, 130, 90)"/>
                </g>
                <g transform="translate(350, 80)">
                    <rect width="220" height="320" fill="#90be6d" stroke="#4361ee" stroke-width="5"/>
                    <rect x="20" y="20" width="180" height="100" fill="#d8f3dc" stroke="#4361ee" stroke-width="3"/>
                    <text x="110" y="80" font-family="Fredoka One" font-size="24" fill="#4361ee" text-anchor="middle">SCIENCE LAB</text>
                    <circle cx="190" cy="200" r="12" fill="#ffd60a"/>
                </g>
            </svg>
            <div id="student-container" style="width: 100%; height: 100%; position: relative; z-index: 60;"></div>
            <div id="hallway-zone" style="width: 500px; height: 110px; border: 4px dashed var(--vibrant-green); background: rgba(6, 214, 160, 0.2); position: absolute; bottom: 50px; border-radius: 55px; display: flex; align-items: center; justify-content: center;">
                <span style="font-family: 'Fredoka One'; font-size: 1.2rem; color: var(--vibrant-green);">LINE UP HERE!</span>
            </div>
        </div>

        <div class="stage" id="stage-2">
            <svg class="scenery-bg" viewBox="0 0 1000 600" preserveAspectRatio="xMidYMid slice">
                <rect width="1000" height="600" fill="#ffe5ec"/>
                <rect y="450" width="1000" height="150" fill="#c9ada7"/>
                <rect y="350" width="1000" height="100" fill="#a8dadc" stroke="#457b9d" stroke-width="3"/> 
                <g transform="translate(50, 50)">
                    <rect width="400" height="250" fill="#b7e4c7" stroke="#fff" stroke-width="5"/>
                    <path d="M0 200 Q 100 150 200 200 T 400 200 V 250 H 0 Z" fill="#52b788"/>
                    <circle cx="100" cy="180" r="40" fill="#74c69d"/><circle cx="300" cy="180" r="50" fill="#74c69d"/>
                    <line x1="200" y1="0" x2="200" y2="250" stroke="#fff" stroke-width="5"/>
                </g>
                <g transform="translate(100, 390)" id="witness-group">
                    <g transform="translate(0,0)">
                        <circle r="22" cy="-35" fill="#ffdbac"/>
                        <circle class="eye" cx="-6" cy="-38" r="3" fill="black"/>
                        <circle class="eye" cx="10" cy="-38" r="3" fill="black"/>
                        <rect y="-15" x="-18" width="36" height="50" fill="#4cc9f0" rx="5"/>
                    </g>
                    <g transform="translate(80,0)">
                        <circle r="22" cy="-35" fill="#ffdbac"/>
                        <circle class="eye" cx="74" cy="-38" r="3" fill="black"/>
                        <circle class="eye" cx="90" cy="-38" r="3" fill="black"/>
                        <rect y="-15" x="62" width="36" height="50" fill="#ef476f" rx="5"/>
                    </g>
                </g>
                <g transform="translate(650, 50)">
                    <rect width="320" height="240" fill="#4a4e69" stroke="#22223b" stroke-width="5" rx="10"/>
                    <text x="160" y="45" font-family="Fredoka One" font-size="24" fill="#ffd166" text-anchor="middle">Hazard Check!</text>
                    <text x="30" y="90" font-family="Comic Neue" font-size="18" fill="white">1. Sandwich on table ü•™</text>
                    <text x="30" y="130" font-family="Comic Neue" font-size="18" fill="white">2. Running in lab üèÉ‚Äç‚ôÇÔ∏è</text>
                    <text x="30" y="170" font-family="Comic Neue" font-size="18" fill="white">3. Broken glass üß™</text>
                </g>
            </svg>
            <div id="hazard-field" style="width: 100%; height: 100%; position: relative; z-index: 60;"></div>
        </div>

        <div class="stage" id="stage-3">
            <svg class="scenery-bg" viewBox="0 0 1000 600" preserveAspectRatio="xMidYMid slice">
                <rect width="1000" height="600" fill="#e0fbfc"/>
                <rect y="400" width="1000" height="200" fill="#cfd8dc"/>
                
                <g id="sink-group" transform="translate(50, 200)">
                    <rect width="320" height="180" fill="#90a4ae" rx="10"/>
                    <rect x="30" y="40" width="260" height="110" fill="#263238" rx="20"/>
                    <text x="160" y="-40" font-family="Fredoka One" font-size="22" fill="#263238" text-anchor="middle">1. CLEANING</text>
                    <path id="sink-tap" d="M145 40 L145 -30 Q160 -50 175 -30 L175 40" fill="#b0bec5" stroke="#455a64" stroke-width="2"/>
                </g>

                <g id="rack-group" transform="translate(420, 230)">
                    <rect width="200" height="150" fill="#eceff1" stroke="#b0bec5" stroke-width="3" rx="5"/>
                    <text x="100" y="-70" font-family="Fredoka One" font-size="22" fill="#263238" text-anchor="middle">2. DRYING</text>
                    <line x1="20" y1="130" x2="180" y2="130" stroke="#90a4ae" stroke-width="12" stroke-linecap="round"/>
                </g>

                <g id="shelf-group" transform="translate(680, 80)">
                    <rect width="280" height="350" fill="#d4a373" stroke="#5d4037" stroke-width="8"/>
                    <line x1="0" y1="110" x2="280" y2="110" stroke="#5d4037" stroke-width="5"/>
                    <line x1="0" y1="220" x2="280" y2="220" stroke="#5d4037" stroke-width="5"/>
                    <text x="140" y="-30" font-family="Fredoka One" font-size="22" fill="#5d4037" text-anchor="middle">3. STORING</text>
                </g>
            </svg>
            <div id="scrub-field" style="width: 100%; height: 100%; position: relative; z-index: 60;"></div>
            <div class="water-animation" id="water-fx"></div>
        </div>

        <div id="stage-4" class="stage" style="background: radial-gradient(circle, var(--sunny-yellow), var(--cheerful-orange));">
            <div style="text-align: center; color: white;">
                <h1 style="font-family: 'Fredoka One'; font-size: 5.5rem; text-shadow: 4px 4px 0px rgba(0,0,0,0.2);">MISSION ACCOMPLISHED!</h1>
                <p style="font-size: 2rem; margin-bottom: 50px; font-weight: bold;">You are a certified Lab Guardian!</p>
                <button class="btn-action" onclick="location.reload()">PLAY AGAIN</button>
            </div>
        </div>

        <div id="hint-bot">
            <div class="bot-avatar">
                <svg width="70" height="70" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="#e0f7fa" stroke="#4cc9f0" stroke-width="3"/>
                    <circle cx="35" cy="40" r="8" fill="#333"/><circle cx="65" cy="40" r="8" fill="#333"/>
                    <path d="M30 65 Q50 85 70 65" stroke="#ff9f1c" stroke-width="5" fill="none" stroke-linecap="round"/>
                </svg>
            </div>
            <div class="hint-bubble" id="bot-bubble">
                <h4 style="font-family: 'Fredoka One'; color: var(--bright-blue); font-size: 1rem; margin-bottom: 5px;">A.I.D.E.N. says:</h4>
                <p id="bot-text" style="font-weight: bold;">Safety first, buddy!</p>
            </div>
        </div>
    </div>

    <script>
        const state = { stage: 0, count: 0, audioStarted: false };
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSfx(f, t='sine', d=0.3) {
            if(!state.audioStarted) return;
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.type = t; o.frequency.value = f; g.gain.value = 0.05;
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + d); o.stop(audioCtx.currentTime + d);
        }

        function startMusic() {
            if(state.audioStarted) return; state.audioStarted = true;
            const playNote = () => {
                const notes = [261.63, 329.63, 392.00, 523.25];
                playSfx(notes[Math.floor(Math.random()*notes.length)], 'sine', 1.5);
                setTimeout(playNote, 2500);
            };
            playNote();
        }

        const Assets = {
            student: (id, color) => `<div class="drag-item" id="st-${id}"><svg viewBox="0 0 100 150"><rect x="20" y="60" width="60" height="70" rx="10" fill="${color}"/><circle cx="50" cy="35" r="30" fill="#ffdbac"/><circle cx="40" cy="30" r="4" fill="black"/><circle cx="60" cy="30" r="4" fill="black"/><path d="M40 50 Q50 60 60 50" stroke="black" stroke-width="3" fill="none" stroke-linecap="round"/></svg></div>`,
            sandwich: `<svg viewBox="0 0 120 80" class="hazard-glow"><ellipse cx="60" cy="65" rx="50" ry="12" fill="#ddd"/><path d="M20 45 Q60 25 100 45 L100 65 Q60 85 20 65 Z" fill="#f4a261"/><rect x="22" y="50" width="76" height="5" fill="#2a9d8f"/><circle cx="10" cy="65" r="3" fill="#f4a261"/></svg>`,
            // FIXED: BIGGER Runner and proper ViewBox
            runner: `<svg viewBox="-20 0 140 150" id="the-runner" class="hazard-glow"><g transform="skewX(-15)"><rect x="20" y="60" width="60" height="70" rx="10" fill="#ef476f"/><circle cx="50" cy="35" r="30" fill="#ffdbac"/><circle cx="40" cy="30" r="4" fill="black"/><circle cx="60" cy="30" r="4" fill="black"/><path d="M40 50 Q50 60 60 50" stroke="black" stroke-width="3" fill="none" stroke-linecap="round"/></g></svg>`,
            glass: `<svg viewBox="0 0 120 100" class="hazard-glow"><path d="M10 90 L30 40 L60 95" stroke="#457b9d" stroke-width="2" fill="#a8dadc" opacity="0.8"/><path d="M70 90 L90 50 L110 95" stroke="#457b9d" stroke-width="2" fill="#a8dadc" opacity="0.8"/></svg>`,
            beaker: (id, status) => `<div class="drag-item" id="bk-${id}" style="width: 70px; height: 100px;"><svg viewBox="0 0 100 120"><path d="M30 10 L30 100 Q30 115 50 115 Q70 115 70 100 L70 10 Z" fill="${status === 'dirty' ? 'rgba(100,80,60,0.8)' : 'rgba(168,218,220,0.4)'}" stroke="white" stroke-width="4"/>${status === 'dirty' ? '<path d="M35 80 L65 80 L65 100 Q50 110 35 100 Z" fill="#5D4037"/>' : ''}${status === 'wet' ? '<circle cx="35" cy="90" r="4" fill="#00f2ff"/><circle cx="60" cy="100" r="3" fill="#00f2ff"/>' : ''}</svg></div>`,
            plant: `<svg viewBox="0 0 100 120"><rect x="35" y="80" width="30" height="30" fill="#bc6c25"/><path d="M50 80 Q30 40 50 10 Q70 40 50 80" fill="#06d6a0"/></svg>`,
            notebook: `<svg viewBox="0 0 80 100"><rect x="10" y="10" width="60" height="80" fill="#fff" stroke="#333" stroke-width="2"/><rect x="5" y="15" width="10" height="70" fill="#ffca3a"/></svg>`
        };

        function showSuccess() {
            gsap.fromTo("#success-seal", { scale: 0, rotation: -45 }, { scale: 1.2, rotation: 0, duration: 0.6, ease: "back.out", onComplete: () => {
                setTimeout(() => gsap.to("#success-seal", { scale: 0, duration: 0.3 }), 800);
            }});
        }

        function transition(to) {
            const overlay = document.getElementById('transition-overlay');
            const text = document.getElementById('transition-text');
            text.innerText = to === 4 ? "ALL DONE! ‚ú®" : `MISSION ${to}: LOADING...`;
            
            gsap.to(overlay, { scaleX: 1, duration: 0.5, ease: "power2.inOut", onComplete: () => {
                document.querySelectorAll('.stage').forEach(s => s.style.display = 'none');
                document.getElementById('stage-' + to).style.display = 'flex';
                state.stage = to; state.count = 0;
                if(to === 1) initMission1();
                if(to === 2) initMission2();
                if(to === 3) initMission3();
                if(to === 4) confetti({ particleCount: 500, spread: 200, origin: {y: 0.6} });
                gsap.to(overlay, { scaleX: 0, transformOrigin: "right", duration: 0.5, delay: 0.5 });
            }});
        }

        function setupDrag(el, onDrop) {
            let isDragging = false; let startX, startY;
            const onStart = (e) => {
                isDragging = true; el.style.zIndex = 1000;
                const c = e.touches ? e.touches[0] : e;
                const r = el.getBoundingClientRect();
                startX = c.clientX - r.left; startY = c.clientY - r.top;
            };
            const onMove = (e) => {
                if(!isDragging) return;
                const c = e.touches ? e.touches[0] : e;
                gsap.set(el, { x: c.clientX - startX, y: c.clientY - startY });
            };
            const onEnd = () => {
                if(!isDragging) return; isDragging = false;
                const res = onDrop(el.getBoundingClientRect());
                if(res) {
                    gsap.to(el, { x: res.x, y: res.y, duration: 0.3 });
                    if(res.lock) { 
                        el.onmousedown = el.ontouchstart = null; 
                        el.style.pointerEvents = "none"; 
                        el.style.zIndex = 50;
                    }
                } else {
                    gsap.to(el, { x: gsap.getProperty(el, "x"), y: gsap.getProperty(el, "y"), duration: 0.3 });
                }
            };
            el.onmousedown = el.ontouchstart = onStart;
            window.addEventListener('mousemove', onMove); window.addEventListener('touchmove', onMove);
            window.addEventListener('mouseup', onEnd); window.addEventListener('touchend', onEnd);
        }

        function updateBot(msg) {
            const bubble = document.getElementById('bot-bubble');
            gsap.to(bubble, { scale: 0.9, opacity: 0, duration: 0.2, onComplete: () => {
                document.getElementById('bot-text').innerText = msg;
                gsap.to(bubble, { scale: 1, opacity: 1, duration: 0.3 });
            }});
        }

        function initMission1() {
            updateBot("Students must line up before entering! Rule: Always enter orderly.");
            const container = document.getElementById('student-container');
            const zone = document.getElementById('hallway-zone').getBoundingClientRect();
            container.innerHTML = '';
            const colors = ['#ff595e', '#ffca3a', '#8ac926', '#1982c4'];
            for(let i=0; i<4; i++) {
                container.insertAdjacentHTML('beforeend', Assets.student(i, colors[i]));
                const s = document.getElementById('st-' + i);
                gsap.set(s, { x: 50 + (i*100), y: 150 });
                setupDrag(s, (rect) => {
                    const cx = rect.left + rect.width/2; const cy = rect.top + rect.height/2;
                    if(cx > zone.left && cx < zone.right && cy > zone.top && cy < zone.bottom) {
                        state.count++; playSfx(400 + (state.count*100));
                        if(state.count === 4) { showSuccess(); setTimeout(() => transition(2), 1500); }
                        return { x: zone.left + (state.count * 100) - 70, y: zone.top - 20, lock: true };
                    }
                    return null;
                });
            }
        }

        function initMission2() {
            updateBot("The lab is messy! Click the items that break the rules.");
            const field = document.getElementById('hazard-field');
            field.innerHTML = '';
            // FIXED PLACEMENTS ON TABLE/GROUND
            const hazards = [
                { t: 'sandwich', x: -100, y: 450, m: "Rule: No food! It ruins experiments." },
                { t: 'runner', x: -150, y: 600, m: "Rule: No running! Walk carefully." },
                { t: 'glass', x: 450, y: 450, m: "Rule: Broken glass! Report to teacher." }
            ];

            hazards.forEach(h => {
                const div = document.createElement('div');
                div.className = 'hazard'; 
                // BIGGER RUNNER
                div.style.width = h.t === 'runner' ? '120px' : '100px'; 
                div.innerHTML = Assets[h.t];
                gsap.set(div, { x: h.x, y: h.y });
                
                if(h.t === 'runner') {
                    const runnerAnim = gsap.to(div, { x: 1100, duration: 7, repeat: -1, ease: "none" });
                    div.onclick = () => { state.count++; runnerAnim.kill(); hClick(div, h.m); };
                } else {
                    div.onclick = () => { state.count++; hClick(div, h.m); };
                }
                field.appendChild(div);
            });

            function hClick(el, msg) {
                playSfx(200, 'square'); updateBot(msg); gsap.to(el, { scale: 0, opacity: 0 });
                if(state.count === 3) { showSuccess(); setTimeout(() => transition(3), 2000); }
            }
            const decoys = [{t:'plant', x:750, y:280}, {t:'notebook', x:100, y:340}];
            decoys.forEach(d => {
                const div = document.createElement('div'); div.className='decoy'; div.style.width='110px'; div.innerHTML=Assets[d.t];
                gsap.set(div, {x:d.x, y:d.y}); field.appendChild(div);
            });
        }

        function initMission3() {
            updateBot("Clean, Dry, and Store! Drag tools through the 3 stations.");
            const field = document.getElementById('scrub-field');
            field.innerHTML = '';
            const getBox = (id) => document.getElementById(id).getBoundingClientRect();

            for(let i=0; i<3; i++) {
                field.insertAdjacentHTML('beforeend', Assets.beaker(i, 'dirty'));
                const b = document.getElementById('bk-'+i);
                gsap.set(b, { x: 100 + (i*100), y: 480 });

                let bState = 'dirty';
                setupDrag(b, (rect) => {
                    const cx = rect.left + rect.width/2; const cy = rect.top + rect.height/2;
                    const sink = getBox('sink-group'); const rack = getBox('rack-group'); const shelf = getBox('shelf-group');
                    
                    // Logic for CLEANING (Drop inside basin)
                    if(bState === 'dirty' && cx > sink.left && cx < sink.right && cy > sink.top && cy < sink.bottom) {
                        bState = 'cleaning'; playSfx(300, 'sawtooth', 1);
                        const fx = document.getElementById('water-fx'); 
                        const tap = document.getElementById('sink-tap').getBoundingClientRect();
                        
                        gsap.set(fx, { left: tap.left + (tap.width/2) - 10, top: tap.bottom }); 
                        fx.style.display = 'block'; fx.style.animation = 'waterFlow 1s';
                        
                        setTimeout(() => { 
                            b.innerHTML = Assets.beaker(i, 'wet'); bState = 'wet'; fx.style.display = 'none'; 
                            updateBot("Cleaned! Now move it to the rack to dry.");
                        }, 1000);
                        return { x: sink.left + 43 + (i*50), y: sink.top + 80, lock: false };
                    }
                    
                    // Logic for DRYING (Drop on top of bar)
                    if(bState === 'wet' && cx > rack.left && cx < rack.right && cy > rack.top && cy < rack.bottom) {
                        bState = 'dry'; playSfx(600); b.innerHTML = Assets.beaker(i, 'dry');
                        updateBot("Dried! Finally, store it in the cupboard.");
                        return { x: rack.left + 48 + (i*50), y: rack.top + 180, lock: false };
                    }
                    
                    // Logic for STORING (Place on shelves)
                    if(bState === 'dry' && cx > shelf.left && cx < shelf.right && cy > shelf.top && cy < shelf.bottom) {
                        state.count++; playSfx(1000); updateBot("Stored safely!");
                        
                        // FIXED: Position neatly ON wooden shelf lines
                        let shelfX = shelf.left + 50 + (i*60);
                        let shelfY = (i === 2) ? shelf.top + 300 : shelf.top + 300;
                        
                        if(state.count === 3) { showSuccess(); setTimeout(() => transition(4), 2000); }
                        return { x: shelfX, y: shelfY, lock: true };
                    }
                    return null;
                });
            }
        }

        function startProtocol() { startMusic(); transition(1); }
    </script>
</body>
</html>