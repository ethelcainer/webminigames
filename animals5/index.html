<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eco-Link: Survival Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --energy: #f9c74f; }
        body { font-family: 'Fredoka', sans-serif; margin: 0; overflow: hidden; touch-action: none; background: #000; }

        /* --- Cross-Fading Environment Layers --- */
        .game-screen { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
        .habitat-layer { position: absolute; inset: 0; width: 100%; height: 100%; }

        .bg-paddy { background: linear-gradient(to bottom, #89f7fe 0%, #66a6ff 100%); }
        .bg-savanna { background: linear-gradient(to bottom, #ff9a9e 0%, #fecfef 100%); }
        .bg-forest { background: linear-gradient(to bottom, #a8e063 0%, #56ab2f 100%); }

        .ground {
            position: absolute; bottom: 0; width: 100%; height: 25%; z-index: 5;
            border-radius: 50% 50% 0 0 / 20% 20% 0 0; transform: scaleX(1.1); 
        }

        .cloud { position: absolute; background: white; border-radius: 50px; opacity: 0.5; animation: floatCloud 40s linear infinite; }
        @keyframes floatCloud { from { transform: translateX(-200px); } to { transform: translateX(110vw); } }

        .habitat-fade-enter-active, .habitat-fade-leave-active { transition: opacity 1.5s ease-in-out; }
        .habitat-fade-enter-from, .habitat-fade-leave-to { opacity: 0; }

        /* --- Animations --- */
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }
        .animate-bounce-in { animation: bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        /* --- UI Panels --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px);
            border: 4px solid white; border-radius: 2.5rem; box-shadow: 0 12px 24px rgba(0,0,0,0.1);
        }
        .nature-note-bar { height: 90px; flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; }

        /* --- Game Objects --- */
        .organism { position: absolute; width: 100px; height: 100px; z-index: 20; cursor: grab; }
        .floating { animation: floatAnim 3s ease-in-out infinite; }
        @keyframes floatAnim { 0%, 100% { transform: translateY(0) rotate(0); } 50% { transform: translateY(-15px) rotate(2deg); } }
        
        .energy-line {
            fill: none; stroke: var(--energy); stroke-width: 6; stroke-dasharray: 12;
            stroke-linecap: round; animation: energyFlow 1s linear infinite;
        }
        @keyframes energyFlow { to { stroke-dashoffset: -24; } }
        .snap-glow { filter: drop-shadow(0 0 15px var(--energy)); transform: scale(1.15); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* --- Overlays --- */
        .overlay { position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; }
        .bubbly-card { background: white; padding: 3rem; border-radius: 4rem; border: 10px solid var(--energy); text-align: center; max-width: 550px; }
        .start-screen-bg { background: linear-gradient(45deg, #11998e, #38ef7d); }
    </style>
</head>
<body>

<div id="app">
    <div v-if="screen === 'start'" class="overlay start-screen-bg">
        <div class="bubbly-card shadow-2xl">
            <h1 class="text-5xl font-bold text-green-600 mb-6">Eco-Link Survival</h1>
            <div class="text-left space-y-4 mb-10 text-gray-600 font-semibold text-lg">
                <p>⭐ Select animals from the left tray.</p>
                <p>⭐ Drag a Predator onto its Prey.</p>
                <p>⭐ Complete the Food Web to balance the habitat!</p>
            </div>
            <button @click="startFirstLevel" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-5 px-16 rounded-3xl text-2xl shadow-xl active:scale-95 transition-all">
                Enter Wilderness
            </button>
        </div>
    </div>

    <div v-if="screen !== 'start'" class="game-screen">
        
        <transition name="habitat-fade">
            <div :key="currentLevelData.id" :class="['habitat-layer', 'bg-' + currentLevelData.id]">
                <div v-for="c in 4" :key="'c'+c" class="cloud" :style="{ top: (c*15)+'%', width: (150+c*20)+'px', height: '60px', animationDelay: (c*-10)+'s' }"></div>
                
                <div class="absolute bottom-[20%] w-full flex justify-around opacity-40 px-20">
                    <div v-if="currentLevelData.id === 'forest'" v-for="n in 3" class="w-0 h-0 border-l-[60px] border-r-[60px] border-b-[180px] border-green-900 border-transparent"></div>
                    <div v-if="currentLevelData.id === 'savanna'" v-for="n in 2" class="w-3 h-24 bg-amber-900 relative rounded-full"><div class="absolute -top-6 -left-10 w-24 h-8 bg-green-700 rounded-full"></div></div>
                    <div v-if="currentLevelData.id === 'paddy'" v-for="n in 5" class="w-2 h-32 bg-green-600 rounded-full"></div>
                </div>
                <div class="ground" :style="{ background: currentLevelData.groundColor }"></div>
            </div>
        </transition>

        <div class="absolute top-8 left-0 right-0 px-10 flex gap-6 items-start z-[100]">
            <div class="glass-panel p-4 flex gap-3 max-w-[450px] flex-wrap justify-center">
                <button v-for="(item, key) in currentLevelData.items" :key="key" 
                        @click="spawn(key)" 
                        class="w-14 h-14 glass-panel p-2 hover:bg-yellow-100 active:scale-90 transition-all flex items-center justify-center">
                    <div v-html="item.svg" class="w-full h-full"></div>
                </button>
            </div>

            <div class="glass-panel nature-note-bar px-10">
                <div v-if="activeNote" class="flex items-center gap-6 animate-[popIn_0.4s]">
                    <div class="w-14 h-14" v-html="activeNote.svg"></div>
                    <p class="text-gray-700 font-bold text-lg">{{ activeNote.text }}</p>
                </div>
                <p v-else class="text-gray-400 font-bold italic text-center">Drag a predator to its food!</p>
            </div>

            <div class="glass-panel px-8 py-5 text-center min-w-[140px]">
                <div class="text-xs font-bold text-gray-400 uppercase tracking-widest">Stability</div>
                <div class="text-4xl font-bold text-blue-500">{{ Math.round(progress) }}%</div>
            </div>
        </div>

        <svg class="absolute inset-0 w-full h-full pointer-events-none z-10">
            <path v-for="link in connections" :key="link.id" :d="getLinePath(link)" class="energy-line" />
        </svg>

        <div v-for="org in activeOrganisms" :key="org.instanceId" 
             :id="org.instanceId"
             class="organism" 
             :class="{ 'floating': !org.isDragging, 'snap-glow': org.isGlowing }"
             :style="{ left: org.x + 'px', top: org.y + 'px' }"
             @mousedown="startDrag($event, org)"
             @touchstart="startDrag($event.touches[0], org)">
            <div v-html="org.svg" class="w-full h-full"></div>
            <div class="absolute -bottom-6 w-full text-center font-bold text-gray-600 text-xs bg-white/60 rounded-full px-2">
                {{ org.name }}
            </div>
        </div>

        <div v-if="showSuccessPopup" class="overlay">
            <div class="bubbly-card shadow-2xl animate-bounce-in">
                <h1 class="text-5xl font-bold text-green-500 mb-4">Habitat Balanced!</h1>
                <p class="text-gray-600 text-xl font-bold mb-8">You've successfully restored the {{ currentLevelData.name }}.</p>
                <button @click="nextLevel" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-5 px-16 rounded-3xl text-2xl shadow-xl active:scale-95 transition-all">
                    Next Habitat
                </button>
            </div>
        </div>

        <div v-if="screen === 'win'" class="overlay">
            <div class="bubbly-card shadow-2xl animate-bounce-in">
                <h1 class="text-5xl font-bold text-yellow-500 mb-4">Nature Expert!</h1>
                <p class="text-gray-600 text-xl font-bold mb-10">You've balanced every single ecosystem!</p>
                <button @click="resetAll" class="bg-green-500 hover:bg-green-600 text-white font-bold py-5 px-16 rounded-3xl text-2xl shadow-xl active:scale-95 transition-all">
                    Play Again
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp, ref, computed } = Vue;

const SOUNDS = {
    pop: new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3'),
    thud: new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3'),
    soft: new Audio('https://assets.mixkit.co/active_storage/sfx/2570/2570-preview.mp3')
};

const ALL_LEVELS = [
    {
        id: 'paddy', name: 'Paddy Field', groundColor: '#90be6d',
        items: {
            padi: { id: 'padi', name: 'Padi', prey: null, fact: "Padi plants are Producers! They make energy from the sun.", 
                svg: `<svg viewBox="0 0 100 100"><path d="M50 95 V45" stroke="#386641" stroke-width="4"/><path d="M50 85 Q30 75 25 85 M50 75 Q70 65 75 75 M50 65 Q35 55 30 65" stroke="#6a994e" stroke-width="3" fill="none"/><g fill="#ffd166"><ellipse cx="48" cy="40" rx="3" ry="6" transform="rotate(-20 48 40)"/><ellipse cx="55" cy="35" rx="3" ry="6" transform="rotate(10 55 35)"/><ellipse cx="45" cy="28" rx="3" ry="6" transform="rotate(-15 45 28)"/><ellipse cx="52" cy="20" rx="3" ry="6" transform="rotate(5 52 20)"/></g></svg>` },
            beluncas: { id: 'beluncas', name: 'Caterpillar', prey: 'padi', fact: "Caterpillars eat padi leaves to grow big.", 
                svg: `<svg viewBox="0 0 100 100"><g fill="#aacc00"><circle cx="25" cy="65" r="12"/><circle cx="42" cy="68" r="11"/><circle cx="58" cy="65" r="12"/><circle cx="75" cy="60" r="14"/></g><g fill="#386641"><circle cx="25" cy="78" r="3"/><circle cx="42" cy="80" r="3"/><circle cx="58" cy="78" r="3"/></g><circle cx="78" cy="55" r="2" fill="black"/><circle cx="84" cy="55" r="2" fill="black"/><path d="M75 48 Q70 40 65 42 M80 46 Q85 38 90 40" stroke="#aacc00" stroke-width="2" fill="none"/></svg>` },
            katak: { id: 'katak', name: 'Frog', prey: 'beluncas', fact: "Frogs use their long tongues to catch caterpillars!", 
                svg: `<svg viewBox="0 0 100 100"><ellipse cx="50" cy="70" rx="35" ry="25" fill="#588157"/><ellipse cx="35" cy="45" rx="10" ry="12" fill="#588157"/><ellipse cx="65" cy="45" rx="10" ry="12" fill="#588157"/><circle cx="35" cy="42" r="5" fill="white"/><circle cx="65" cy="42" r="5" fill="white"/><circle cx="35" cy="42" r="2" fill="black"/><circle cx="65" cy="42" r="2" fill="black"/><path d="M40 75 Q50 85 60 75" stroke="#386641" stroke-width="3" fill="none"/><path d="M20 75 Q10 65 15 85 M80 75 Q90 65 85 85" stroke="#588157" stroke-width="6" stroke-linecap="round"/></svg>` },
            ular: { id: 'ular', name: 'Snake', prey: 'katak', fact: "Snakes hunt frogs to keep the population in check.", 
                svg: `<svg viewBox="0 0 100 100"><path d="M30 85 Q 10 60, 30 40 T 70 40 Q 90 60, 70 85" stroke="#bc4749" stroke-width="18" fill="none" stroke-linecap="round"/><path d="M30 85 Q 10 60, 30 40 T 70 40 Q 90 60, 70 85" stroke="#f2e8cf" stroke-width="6" fill="none" stroke-linecap="round" stroke-dasharray="4 8"/><circle cx="70" cy="85" r="12" fill="#bc4749"/><ellipse cx="75" cy="82" rx="3" ry="2" fill="white"/><circle cx="76" cy="82" r="1" fill="black"/><path d="M60 88 L50 92 L60 96" stroke="#bc4749" stroke-width="3" fill="none"/></svg>` }
        }
    },
    {
        id: 'savanna', name: 'Savanna', groundColor: '#f4d35e',
        items: {
            grass: { id: 'grass', name: 'Grass', prey: null, fact: "Grass is the primary food source in the savanna.", 
                svg: `<svg viewBox="0 0 100 100"><g stroke="#e9c46a" stroke-width="2" fill="none"><path d="M20 95 Q25 30 15 10"/><path d="M35 95 Q45 20 40 5"/><path d="M55 95 Q50 10 65 15"/><path d="M75 95 Q80 30 90 20"/></g><g fill="#e9c46a"><circle cx="15" cy="10" r="2"/><circle cx="40" cy="5" r="2"/><circle cx="65" cy="15" r="2"/><circle cx="90" cy="20" r="2"/></g></svg>` },
            zebra: { id: 'zebra', name: 'Zebra', prey: 'grass', fact: "Zebras graze on grass in large herds.", 
                svg: `<svg viewBox="0 0 100 100">
                    <ellipse cx="35" cy="25" rx="8" ry="15" fill="white" stroke="black" stroke-width="2" transform="rotate(-20 35 25)" />
                    <ellipse cx="65" cy="25" rx="8" ry="15" fill="white" stroke="black" stroke-width="2" transform="rotate(20 65 25)" />
                    <path d="M40 22 L50 5 L60 22" fill="black" />
                    <path d="M30 30 L40 12 L50 25" fill="black" />
                    <path d="M50 25 L60 12 L70 30" fill="black" />
                    <circle cx="50" cy="55" r="35" fill="white" stroke="black" stroke-width="2" />
                    <ellipse cx="50" cy="75" rx="20" ry="12" fill="#444" />
                    <circle cx="45" cy="75" r="2" fill="#666" />
                    <circle cx="55" cy="75" r="2" fill="#666" />
                    <circle cx="35" cy="50" r="5" fill="black" />
                    <circle cx="65" cy="50" r="5" fill="black" />
                    <circle cx="37" cy="48" r="1.5" fill="white" />
                    <circle cx="67" cy="48" r="1.5" fill="white" />
                    <g stroke="black" stroke-width="4" stroke-linecap="round">
                        <path d="M22 55 L35 55" />
                        <path d="M78 55 L65 55" />
                        <path d="M25 70 L40 65" />
                        <path d="M75 70 L60 65" />
                        <path d="M50 30 L50 42" />
                    </g>
                </svg>` },
            gazelle: { id: 'gazelle', name: 'Gazelle', prey: 'grass', fact: "Gazelles are very fast herbivores.", 
                svg: `<svg viewBox="0 0 100 100"><path d="M35 60 Q40 85 45 95 M65 60 Q70 85 75 95" stroke="#c18c5d" stroke-width="4"/><ellipse cx="50" cy="60" rx="25" ry="15" fill="#c18c5d"/><path d="M65 55 L75 35 Q80 30 85 35 L75 50" fill="#c18c5d"/><path d="M75 35 Q70 10 60 20 M78 35 Q73 10 63 20" stroke="black" stroke-width="3" fill="none"/><circle cx="80" cy="32" r="2" fill="black"/></svg>` },
            lion: { id: 'lion', name: 'Lion', prey: 'zebra', fact: "Lions are powerful predators that hunt zebras.", 
                svg: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="35" fill="#9c6644"/><circle cx="50" cy="50" r="25" fill="#dda15e"/><circle cx="40" cy="45" r="4" fill="black"/><circle cx="60" cy="45" r="4" fill="black"/><path d="M45 60 Q50 65 55 60" stroke="black" stroke-width="2" fill="none"/><path d="M35 55 L20 50 M35 60 L20 60 M35 65 L20 70 M65 55 L80 50 M65 60 L80 60 M65 65 L80 70" stroke="black" stroke-width="1"/></svg>` },
            cheetah: { id: 'cheetah', name: 'Cheetah', prey: 'gazelle', fact: "Cheetahs are the fastest land animals!", 
                svg: `<svg viewBox="0 0 100 100"><ellipse cx="45" cy="65" rx="30" ry="18" fill="#ffb703"/><path d="M35 83 L30 95 M55 83 L60 95" stroke="#ffb703" stroke-width="6"/><circle cx="70" cy="45" r="14" fill="#ffb703"/><path d="M68 45 Q70 52 70 55 M72 45 Q70 52 70 55" stroke="black" stroke-width="1.5" fill="none"/><circle cx="66" cy="42" r="2" fill="black"/><circle cx="74" cy="42" r="2" fill="black"/><g fill="black" opacity="0.8"><circle cx="35" cy="60" r="2"/><circle cx="45" cy="70" r="2"/><circle cx="55" cy="58" r="2"/><circle cx="40" cy="65" r="1.5"/><circle cx="50" cy="62" r="1.5"/></g><path d="M20 60 Q10 55 5 70" stroke="#ffb703" stroke-width="4" fill="none"/></svg>` }
        }
    },
    {
        id: 'forest', name: 'Wild Forest', groundColor: '#2d6a4f',
        items: {
            berry: { id: 'berry', name: 'Berries', prey: null, fact: "Wild berries are a sweet snack for many animals.", 
                svg: `<svg viewBox="0 0 100 100"><path d="M50 90 V40 M40 60 L20 50 M60 60 L80 50" stroke="#386641" stroke-width="5" stroke-linecap="round"/><circle cx="20" cy="50" r="10" fill="#d90429"/><circle cx="80" cy="50" r="10" fill="#d90429"/><circle cx="50" cy="30" r="12" fill="#ef233c"/><path d="M15 45 Q20 40 25 45 M75 45 Q80 40 85 45" stroke="#ff8fa3" stroke-width="2" fill="none"/></svg>` },
            flower: { id: 'flower', name: 'Flower', prey: null, fact: "Flowers provide nectar for small creatures.", 
                svg: `<svg viewBox="0 0 100 100"><path d="M50 90 V50" stroke="#386641" stroke-width="4"/><ellipse cx="30" cy="70" rx="15" ry="8" fill="#6a994e" transform="rotate(-20 30 70)"/><ellipse cx="70" cy="70" rx="15" ry="8" fill="#6a994e" transform="rotate(20 70 70)"/><circle cx="50" cy="50" r="15" fill="#ffca3a"/><circle cx="50" cy="25" r="12" fill="#ff595e"/><circle cx="75" cy="50" r="12" fill="#ff595e"/><circle cx="50" cy="75" r="12" fill="#ff595e"/><circle cx="25" cy="50" r="12" fill="#ff595e"/></svg>` },
            rabbit: { id: 'rabbit', name: 'Rabbit', prey: 'berry', fact: "Rabbits love to forage for forest berries.", 
                svg: `<svg viewBox="0 0 100 100"><ellipse cx="50" cy="70" rx="25" ry="20" fill="#e0e1dd"/><ellipse cx="65" cy="50" rx="15" ry="12" fill="#e0e1dd"/><ellipse cx="60" cy="30" rx="5" ry="15" fill="#e0e1dd"/><ellipse cx="70" cy="30" rx="5" ry="15" fill="#e0e1dd"/><ellipse cx="60" cy="30" rx="2" ry="10" fill="pink"/><ellipse cx="70" cy="30" rx="2" ry="10" fill="pink"/><circle cx="68" cy="48" r="2" fill="black"/><circle cx="25" cy="70" r="8" fill="white"/></svg>` },
            eagle: { id: 'eagle', name: 'Eagle', prey: 'rabbit', fact: "Eagles have powerful wings to hunt from the sky.", 
                svg: `<svg viewBox="0 0 100 100"><path d="M10 50 Q50 15 90 50 L75 75 Q50 65 25 75 Z" fill="#432818"/><circle cx="50" cy="40" r="12" fill="#f4f1de"/><circle cx="47" cy="38" r="1.5" fill="black"/><path d="M58 40 L70 45 L58 50 Z" fill="#ffb703"/><g stroke="#ffb703" stroke-width="2" fill="none"><path d="M40 75 L37 85 M60 75 L63 85"/></g></svg>` },
            bird: { id: 'bird', name: 'Bird', prey: 'flower', fact: "Birds drink nectar and help spread pollen.", 
                svg: `<svg viewBox="0 0 100 100"><ellipse cx="45" cy="65" rx="22" ry="16" fill="#00b4d8"/><circle cx="65" cy="52" r="14" fill="#00b4d8"/><path d="M45 50 Q30 25 20 50" fill="#90e0ef" opacity="0.8"/><path d="M25 65 L10 60 L10 70 Z" fill="#0077b6"/><circle cx="72" cy="50" r="2" fill="white"/><circle cx="72" cy="50" r="1" fill="black"/><path d="M78 52 L88 55 L78 58 Z" fill="#ff9f1c"/></svg>` }
        }
    }
];

createApp({
    setup() {
        const screen = ref('start');
        const showSuccessPopup = ref(false);
        const levelQueue = ref([]);
        const currentLevelIdx = ref(0);
        const activeOrganisms = ref([]);
        const connections = ref([]);
        const activeNote = ref(null);
        const progress = ref(0);

        const currentLevelData = computed(() => levelQueue.value[currentLevelIdx.value] || ALL_LEVELS[0]);

        const playSfx = (type) => {
            const sound = SOUNDS[type].cloneNode();
            sound.volume = 0.6;
            sound.play().catch(e => {});
        };

        const startFirstLevel = () => {
            levelQueue.value = [...ALL_LEVELS].sort(() => Math.random() - 0.5);
            screen.value = 'playing';
            loadLevel();
        };

        const loadLevel = () => {
            activeOrganisms.value = [];
            connections.value = [];
            progress.value = 0;
            activeNote.value = null;
            showSuccessPopup.value = false;
        };

        const nextLevel = () => {
            if (currentLevelIdx.value < levelQueue.value.length - 1) {
                currentLevelIdx.value++;
                loadLevel();
            } else {
                showSuccessPopup.value = false;
                screen.value = 'win';
            }
        };

        const spawn = (key) => {
            playSfx('soft');
            setTimeout(() => playSfx('pop'), 50);
            const data = currentLevelData.value.items[key];
            const instanceId = 'org-' + Date.now();
            activeOrganisms.value.push({
                ...data, instanceId,
                x: Math.random() * (window.innerWidth - 200) + 100,
                y: Math.random() * (window.innerHeight - 400) + 300,
                isDragging: false, isGlowing: false
            });
        };

        const startDrag = (e, org) => {
            if (showSuccessPopup.value) return;
            org.isDragging = true;
            const startX = e.clientX - org.x;
            const startY = e.clientY - org.y;

            const move = (me) => {
                const clientX = me.touches ? me.touches[0].clientX : me.clientX;
                const clientY = me.touches ? me.touches[0].clientY : me.clientY;
                org.x = clientX - startX;
                org.y = clientY - startY;
                checkProximity(org);
            };

            const end = () => {
                window.removeEventListener('mousemove', move);
                window.removeEventListener('mouseup', end);
                window.removeEventListener('touchmove', move);
                window.removeEventListener('touchend', end);
                checkSnap(org);
                org.isDragging = false;
            };

            window.addEventListener('mousemove', move);
            window.addEventListener('mouseup', end);
            window.addEventListener('touchmove', move);
            window.addEventListener('touchend', end);
        };

        const checkProximity = (dragging) => {
            activeOrganisms.value.forEach(other => {
                if (other.instanceId === dragging.instanceId) return;
                const dist = Math.hypot(dragging.x - other.x, dragging.y - other.y);
                other.isGlowing = dist < 120 && (dragging.prey === other.id || other.prey === dragging.id);
            });
        };

        const checkSnap = (dragging) => {
            activeOrganisms.value.forEach(other => {
                if (other.instanceId === dragging.instanceId) return;
                const dist = Math.hypot(dragging.x - other.x, dragging.y - other.y);
                if (dist < 120) {
                    if (dragging.prey === other.id) link(other, dragging);
                    else if (other.prey === dragging.id) link(dragging, other);
                }
                other.isGlowing = false;
            });
        };

        const link = (prey, predator) => {
            const exists = connections.value.some(c => c.from === prey.instanceId && c.to === predator.instanceId);
            if (exists) return;

            playSfx('thud');
            connections.value.push({ id: Date.now(), from: prey.instanceId, to: predator.instanceId });
            activeNote.value = { text: predator.fact, svg: predator.svg };
            
            const totalRequired = Object.values(currentLevelData.value.items).filter(i => i.prey).length;
            progress.value = (connections.value.length / totalRequired) * 100;

            if (progress.value >= 100) {
                setTimeout(() => {
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                    setTimeout(() => {
                        showSuccessPopup.value = true;
                        playSfx('soft');
                    }, 1000);
                }, 100);
            }
        };

        const getLinePath = (link) => {
            const f = activeOrganisms.value.find(o => o.instanceId === link.from);
            const t = activeOrganisms.value.find(o => o.instanceId === link.to);
            if (!f || !t) return '';
            const mx = (f.x + t.x) / 2;
            const my = Math.min(f.y, t.y) - 60;
            return `M ${f.x + 50} ${f.y + 50} Q ${mx} ${my} ${t.x + 50} ${t.y + 50}`;
        };

        const resetAll = () => location.reload();

        return { screen, currentLevelData, activeOrganisms, connections, progress, activeNote, spawn, startDrag, getLinePath, startFirstLevel, resetAll, showSuccessPopup, nextLevel };
    }
}).mount('#app');
</script>
</body>
</html>