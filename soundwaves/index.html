<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonic Pulse: 8-Bit Science</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --pixel-bg: #0f0f1b;
            --pixel-border: #4a4a7d;
            --pixel-accent: #38bdf8;
            --pixel-success: #4ade80;
        }

        body {
            font-family: 'VT323', monospace;
            background-color: #05050a;
            color: #fff;
            image-rendering: pixelated;
            overflow: hidden;
            user-select: none;
        }

        .pixel-border {
            border: 4px solid var(--pixel-border);
            box-shadow: 
                inset -4px -4px 0px 0px rgba(0,0,0,0.3),
                inset 4px 4px 0px 0px rgba(255,255,255,0.1);
            background: var(--pixel-bg);
        }

        .pixel-button {
            position: relative;
            display: inline-block;
            padding: 10px 20px;
            background: #334155;
            border: 4px solid #1e293b;
            box-shadow: inset -4px -4px 0px 0px #0f172a;
            transition: all 0.1s;
            cursor: pointer;
        }

        .pixel-button:active {
            transform: translateY(4px);
            box-shadow: inset 2px 2px 0px 0px #000;
        }

        .btn-primary { background: #3b82f6; border-color: #1d4ed8; }
        .btn-success { background: #16a34a; border-color: #14532d; }

        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
            cursor: pointer;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 12px;
            background: #1e293b;
            border: 2px solid var(--pixel-border);
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 12px;
            background: var(--pixel-accent);
            border: 2px solid white;
            margin-top: -8px;
            box-shadow: 4px 4px 0px #000;
        }

        .scanlines {
            position: relative;
            overflow: hidden;
        }
        .scanlines::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 30;
            background-size: 100% 4px, 3px 100%;
            pointer-events: none;
        }

        @keyframes glitch {
            0% { transform: translate(0) }
            20% { transform: translate(-2px, 2px) }
            40% { transform: translate(-2px, -2px) }
            60% { transform: translate(2px, 2px) }
            80% { transform: translate(2px, -2px) }
            100% { transform: translate(0) }
        }
        .glitch-text:hover { animation: glitch 0.3s infinite; }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <div class="max-w-5xl w-full flex flex-col gap-4">
        
        <!-- TOP HUD -->
        <div class="flex justify-between items-end px-2">
            <div>
                <div class="text-blue-400 text-xl tracking-tighter">PROJECT: SONIC_PULSE_V5</div>
                <h1 class="text-5xl glitch-text text-white leading-none uppercase">System.Oscilloscope</h1>
            </div>
            <div class="text-right flex flex-col items-end">
                <div class="bg-blue-900/50 border-2 border-blue-400 px-4 py-1 flex items-center gap-4">
                    <span class="text-blue-300">MISSION_STEP:</span>
                    <span id="level-display" class="text-2xl text-white">01</span>
                </div>
            </div>
        </div>

        <!-- MAIN SCREEN -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
            
            <div class="lg:col-span-3 flex flex-col gap-4">
                <div class="scanlines pixel-border h-[400px] relative overflow-hidden bg-black">
                    <div class="absolute inset-0 opacity-20" style="background-image: linear-gradient(#334155 1px, transparent 1px), linear-gradient(90deg, #334155 1px, transparent 1px); background-size: 40px 40px;"></div>
                    
                    <canvas id="waveCanvas" class="w-full h-full relative z-10"></canvas>

                    <div class="absolute top-6 right-6 z-20 flex flex-col items-end gap-1">
                        <div class="text-xs text-blue-400 tracking-widest uppercase">Signal_Sync</div>
                        <div class="w-48 h-6 bg-slate-900 border-2 border-slate-700 flex p-1">
                            <div id="sync-bar" class="h-full bg-blue-400 transition-all duration-100" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="absolute bottom-6 left-6 z-20">
                        <svg id="pixelSpeaker" width="80" height="80" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="1" y="1" width="14" height="14" fill="#334155"/>
                            <rect x="2" y="2" width="12" height="12" fill="#1e293b"/>
                            <rect x="4" y="4" width="8" height="8" fill="#475569"/>
                            <rect id="speakerCone" x="6" y="6" width="4" height="4" fill="#38bdf8"/>
                        </svg>
                    </div>

                    <div class="absolute bottom-6 right-6 z-20 font-mono text-[10px] text-green-500/50 leading-tight text-right">
                        SYS.CPU: ACTIVE<br>
                        RANDOM_SEED: OK<br>
                        SINE.GEN: READY
                    </div>
                </div>

                <div class="pixel-border p-4 bg-slate-900/80">
                    <div class="flex items-center gap-2 mb-1">
                        <div class="w-3 h-3 bg-blue-400 animate-pulse"></div>
                        <span class="text-blue-400 text-lg uppercase tracking-wider">Lab_Intelligence_Brief</span>
                    </div>
                    <p id="fact-box" class="text-slate-300 text-xl leading-none">
                        AWAITING_INPUT... MATCH THE TARGET WAVEFORM TO ANALYZE FREQUENCY DATA.
                    </p>
                </div>
            </div>

            <div class="flex flex-col gap-4">
                <div class="pixel-border p-6 flex flex-col gap-8 flex-grow">
                    
                    <button id="powerBtn" class="pixel-button btn-primary w-full text-2xl py-4">
                        RUN_ANALYSIS
                    </button>

                    <div class="flex flex-col gap-2">
                        <div class="flex justify-between text-xl">
                            <span class="text-blue-300 uppercase">Freq_Hz</span>
                            <span id="freqVal" class="text-white">220</span>
                        </div>
                        <input type="range" id="freqSlider" min="100" max="1000" value="220" class="w-full">
                        <div class="flex justify-between text-[10px] text-slate-500 uppercase">
                            <span>Low_Pitch</span>
                            <span>High_Pitch</span>
                        </div>
                    </div>

                    <div class="flex flex-col gap-2">
                        <div class="flex justify-between text-xl">
                            <span class="text-pink-400 uppercase">Amp_Vol</span>
                            <span id="ampVal" class="text-white">50%</span>
                        </div>
                        <input type="range" id="ampSlider" min="0" max="100" value="50" class="w-full">
                        <div class="flex justify-between text-[10px] text-slate-500 uppercase">
                            <span>Quiet</span>
                            <span>Loud</span>
                        </div>
                    </div>

                    <div class="flex flex-col gap-2 mt-auto">
                        <span class="text-[10px] text-slate-500 uppercase">Waveform_Type</span>
                        <div class="grid grid-cols-1 gap-2">
                            <button class="pixel-button bg-blue-900 text-white border-blue-400 text-lg cursor-default">SINE_PURE</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Start Overlay -->
    <div id="startOverlay" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50">
        <div class="pixel-border p-12 max-w-lg text-center bg-blue-950 flex flex-col gap-6">
            <h2 class="text-7xl text-white glitch-text">SONIC PULSE</h2>
            <div class="h-1 bg-blue-400 w-full"></div>
            <p class="text-2xl text-blue-300">MASTER THE PHYSICS OF SOUND THROUGH WAVEFORM MATCHING.</p>
            <button id="initBtn" class="pixel-button btn-primary text-4xl px-12 py-6">INITIALIZE_SYSTEM</button>
            <p class="text-xs text-slate-500 uppercase">Procedural Missions • Retro Synthesis • Pure Science</p>
        </div>
    </div>

    <!-- Mission Clear Modal -->
    <div id="clearOverlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 pointer-events-none opacity-0 transition-opacity">
        <div class="pixel-border p-10 max-w-md text-center bg-slate-900 flex flex-col gap-6 scale-90 transition-transform duration-300" id="clearContent">
            <h2 class="text-6xl text-green-400">MISSION_CLEAR</h2>
            <div class="bg-green-900/30 p-4 border-2 border-green-400">
                <p id="level-fact" class="text-2xl text-white"></p>
            </div>
            <button id="nextBtn" class="pixel-button btn-success text-3xl py-4 pointer-events-auto uppercase">Next_Analysis >></button>
        </div>
    </div>

    <script>
        // --- State ---
        let audioCtx = null;
        let oscillator = null;
        let gainNode = null;
        let isActive = false;
        let isGameRunning = false;
        let currentFreq = 220;
        let currentAmp = 0.5;
        let currentLevel = 0;
        let matchProgress = 0;

        let levelSet = [
            { freq: 150, amp: 0.75, title: "SUB-BASS SCAN", fact: "LOW FREQUENCY sounds have long wavelengths. These waves can even be felt physically as vibrations!" },
            { freq: 900, amp: 0.20, title: "SILENT WHISPER", fact: "HIGH FREQUENCY waves are very short. Low amplitude means the wave carries very little energy." },
            { freq: 440, amp: 0.50, title: "REFERENCE A4", fact: "Musical pitch is determined by frequency. A standard orchestra tunes to this 440Hz signal!" },
            { freq: 260, amp: 0.95, title: "THUNDER PULSE", fact: "AMPLITUDE determines the 'loudness' or volume. High amplitude waves carry massive energy!" },
            { freq: 750, amp: 0.85, title: "SONIC SIREN", fact: "Middle-High frequencies are where human hearing is most sensitive. This is a high-energy signal." },
            { freq: 520, amp: 0.35, title: "STEADY HUM", fact: "A wave's 'height' (Amplitude) and 'width' (Frequency) are independent properties of sound." }
        ];

        const canvas = document.getElementById('waveCanvas');
        const ctx = canvas.getContext('2d');
        const freqSlider = document.getElementById('freqSlider');
        const ampSlider = document.getElementById('ampSlider');
        const powerBtn = document.getElementById('powerBtn');
        const initBtn = document.getElementById('initBtn');
        const nextBtn = document.getElementById('nextBtn');
        const clearOverlay = document.getElementById('clearOverlay');
        const clearContent = document.getElementById('clearContent');

        // --- Procedural Sound Effects ---
        function playClickSound() {
            if (!audioCtx) return;
            const clickOsc = audioCtx.createOscillator();
            const clickGain = audioCtx.createGain();
            
            clickOsc.type = 'square';
            clickOsc.frequency.setValueAtTime(800, audioCtx.currentTime);
            clickOsc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.05);
            
            clickGain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            clickGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);
            
            clickOsc.connect(clickGain);
            clickGain.connect(audioCtx.destination);
            
            clickOsc.start();
            clickOsc.stop(audioCtx.currentTime + 0.05);
        }

        // --- Core Functions ---
        initBtn.onclick = () => {
            if (isGameRunning) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            playClickSound();
            startGame();
        };

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[array[j]]] = [array[j], array[i]];
            }
            return array;
        }

        function startGame() {
            isGameRunning = true;
            document.getElementById('startOverlay').style.display = 'none';
            shuffle(levelSet);
            startLevel(0);
            draw();
        }

        function startLevel(idx) {
            currentLevel = idx;
            matchProgress = 0;
            
            if (currentLevel >= levelSet.length) {
                document.getElementById('level-fact').innerText = "ALL SONIC MISSIONS COMPLETE. YOU ARE A MASTER OF ACOUSTICS.";
                nextBtn.innerText = "RESTART_SYSTEM";
                nextBtn.onclick = () => {
                    playClickSound();
                    location.reload();
                };
                showClearModal();
                return;
            }
            
            document.getElementById('level-display').innerText = (currentLevel + 1).toString().padStart(2, '0');
            document.getElementById('fact-box').innerHTML = `MISSION: MATCH THE <span class="text-white">${levelSet[currentLevel].title}</span> WAVEFORM.`;
            hideClearModal();
        }

        function showClearModal() {
            if (currentLevel < levelSet.length) {
                document.getElementById('level-fact').innerText = levelSet[currentLevel].fact;
            }
            clearOverlay.style.opacity = '1';
            clearOverlay.style.pointerEvents = 'auto';
            clearContent.style.transform = 'scale(1)';
        }

        function hideClearModal() {
            clearOverlay.style.opacity = '0';
            clearOverlay.style.pointerEvents = 'none';
            clearContent.style.transform = 'scale(0.9)';
        }

        nextBtn.onclick = () => {
            playClickSound();
            if (currentLevel < levelSet.length) {
                startLevel(currentLevel + 1);
            }
        };

        // --- Audio Logic ---
        function togglePower() {
            if (!audioCtx) return;
            playClickSound();

            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            if (!isActive) {
                oscillator = audioCtx.createOscillator();
                gainNode = audioCtx.createGain();
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(currentFreq, audioCtx.currentTime);
                
                gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(currentAmp, audioCtx.currentTime + 0.1);
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.start();
                isActive = true;
                powerBtn.innerText = "SHUT_DOWN";
                powerBtn.classList.replace('btn-primary', 'bg-red-600');
            } else {
                stopAudio();
            }
        }

        function stopAudio() {
            if (gainNode) {
                gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
                const oldOsc = oscillator;
                setTimeout(() => { 
                    if (oldOsc) oldOsc.stop(); 
                }, 150);
            }
            isActive = false;
            powerBtn.innerText = "RUN_ANALYSIS";
            powerBtn.classList.remove('bg-red-600');
            powerBtn.classList.add('btn-primary');
        }

        powerBtn.addEventListener('click', togglePower);

        freqSlider.oninput = (e) => {
            currentFreq = parseInt(e.target.value);
            document.getElementById('freqVal').innerText = currentFreq;
            if (oscillator && isActive) oscillator.frequency.setTargetAtTime(currentFreq, audioCtx.currentTime, 0.05);
        };

        ampSlider.oninput = (e) => {
            currentAmp = parseInt(e.target.value) / 100;
            document.getElementById('ampVal').innerText = `${parseInt(e.target.value)}%`;
            if (gainNode && isActive) gainNode.gain.setTargetAtTime(currentAmp, audioCtx.currentTime, 0.05);
        };

        // --- Rendering ---
        let offset = 0;
        function draw() {
            if (!isGameRunning) return;

            const w = canvas.width = canvas.parentElement.clientWidth;
            const h = canvas.height = canvas.parentElement.clientHeight;
            const cy = h / 2;
            
            ctx.clearRect(0, 0, w, h);

            if (currentLevel < levelSet.length) {
                const target = levelSet[currentLevel];
                
                // 1. Draw Target (Ghost)
                ctx.beginPath();
                ctx.setLineDash([10, 10]);
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.15)';
                ctx.lineWidth = 2;
                for (let x = 0; x < w; x++) {
                    const ty = cy + Math.sin(x * (target.freq / 1000) * 0.15 + offset) * (target.amp * h * 0.4);
                    if (x === 0) ctx.moveTo(x, ty); else ctx.lineTo(x, ty);
                }
                ctx.stroke();
                ctx.setLineDash([]);

                // 2. Draw Active Wave
                ctx.beginPath();
                ctx.strokeStyle = isActive ? '#38bdf8' : '#1e293b';
                ctx.lineWidth = 4;
                ctx.shadowBlur = isActive ? 15 : 0;
                ctx.shadowColor = '#38bdf8';
                
                const ampPx = currentAmp * h * 0.4;
                const freqScaling = (currentFreq / 1000) * 0.15;

                for (let x = 0; x < w; x++) {
                    const ay = cy + Math.sin(x * freqScaling + offset) * ampPx;
                    if (x === 0) ctx.moveTo(x, ay); else ctx.lineTo(x, ay);
                }
                ctx.stroke();
                ctx.shadowBlur = 0;

                // 3. Match Logic
                if (isActive) {
                    const fDiff = Math.abs(currentFreq - target.freq) / 1000;
                    const aDiff = Math.abs(currentAmp - target.amp);
                    const diff = (fDiff + aDiff);
                    const score = Math.max(0, 100 - (diff * 250));
                    
                    document.getElementById('sync-bar').style.width = score + "%";
                    
                    if (score > 92) {
                        matchProgress += 1.2;
                        document.getElementById('sync-bar').style.backgroundColor = "#4ade80";
                        if (matchProgress > 100) {
                            stopAudio();
                            showClearModal();
                        }
                    } else {
                        matchProgress = Math.max(0, matchProgress - 1);
                        document.getElementById('sync-bar').style.backgroundColor = "#38bdf8";
                    }
                } else {
                    document.getElementById('sync-bar').style.width = "0%";
                    matchProgress = 0;
                }
            }

            // Animate
            if (isActive) {
                offset -= (currentFreq / 2000) * 2;
                const v = 6 + (currentAmp * 4);
                const sc = document.getElementById('speakerCone');
                if (sc) {
                    sc.setAttribute('width', v);
                    sc.setAttribute('height', v);
                    sc.setAttribute('x', 8 - v/2);
                    sc.setAttribute('y', 8 - v/2);
                }
            }

            requestAnimationFrame(draw);
        }

    </script>
</body>
</html>